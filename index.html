<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SuperOps - å…¨æ–¹ä½ç‡Ÿé‹ç®¡ç†ç³»çµ± (æ——è‰¦ç‰ˆ)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useMemo, useEffect, useRef } = React;
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, writeBatch } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- UI Components ---
        const Logo = ({ className }) => {
            const [imgError, setImgError] = useState(false);
            if (imgError) {
                return (
                    <div className={`flex items-center gap-2 ${className}`}>
                         <div className="w-8 h-8 bg-gradient-to-br from-yellow-400 to-orange-500 rounded-lg flex items-center justify-center text-white font-bold shadow-sm shrink-0">T</div>
                        <span className="font-bold text-xl tracking-tight text-slate-800 whitespace-nowrap">TPHA ECOTOURISM</span>
                    </div>
                );
            }
            return <img src="LOGOä¿®å¾©æª”.png" alt="Logo" className={`object-contain ${className}`} onError={() => setImgError(true)} />;
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (!window.lucide) return;
                const { icons, createElement } = window.lucide;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconNode = icons[iconName];
                if (iconNode && containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const svgElement = createElement(iconNode);
                    svgElement.setAttribute('width', size);
                    svgElement.setAttribute('height', size);
                    const existingClass = svgElement.getAttribute('class') || '';
                    svgElement.setAttribute('class', `${existingClass} ${className}`.trim());
                    containerRef.current.appendChild(svgElement);
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center shrink-0"></span>;
        };

        // --- Config & Helpers ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtfR8N9Dw9kG3jQSfJSs0p0MLvlQaOR74",
            authDomain: "crm-sys-4184a.firebaseapp.com",
            projectId: "crm-sys-4184a",
            storageBucket: "crm-sys-4184a.firebasestorage.app",
            messagingSenderId: "943273685158",
            appId: "1:943273685158:web:8ca441dd78dcb5b956c467",
            measurementId: "G-2M2W340ZKB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        const CSV_HEADER = "æ—¥æœŸ,æ´»å‹•åç¨±,è¬›å¸«,å®¢æˆ¶å§“å,é‡‘é¡,äº¤é€šæ–¹å¼,èº«åˆ†è­‰å­—è™Ÿ,ç”Ÿæ—¥,Email,å ±åç®¡é“,ç¤¾ç¾¤æš±ç¨±,å‚™è¨»,è¨‚è³¼æ—¥,æ‰‹æ©Ÿ,å ±åˆ°ç‹€æ…‹";
        const INITIAL_CSV_DATA = `${CSV_HEADER}
2026-01-11,é™½æ˜å…”,,å¼µæ›‰å¨Ÿ,750,,F227249054,1988-12-25,reina249@hotmail.com,IGå»£å‘Š,,â€œæ—©é³¥ç¥¨ï¼›è¨‚å–®ç·¨è™Ÿï¼šRZ251127YP9852ï¼›ä»˜æ¬¾æ–¹å¼ï¼šè—æ–°é‡‘æµä¿¡ç”¨å¡â€,2025-11-27,0988112667,0`;

        const INITIAL_PROJECTS = [
            { name: '12æœˆè·¨å¹´æ´»å‹•ç±Œå‚™', owner: 'Alex', status: 'In Progress', deadline: '2023-12-15' },
            { name: 'å®˜ç¶²è¦–è¦ºå¤§æ”¹ç‰ˆ', owner: 'Sarah', status: 'Stuck', deadline: '2024-01-10' },
            { name: '2024 å¹´åº¦è¬›å¸«æ‹›å‹Ÿ', owner: 'Ken', status: 'Done', deadline: '2023-11-30' },
        ];

        const DEFAULT_TASKS_TEMPLATE = [
            { id: 'insurance', type: 'insurance', name: 'è¾¦ç†ä¿éšª', fields: [{ label: 'ä¿å–®è™Ÿç¢¼', value: '' }], completed: false },
            { id: 'pre_letter', type: 'pre_letter', name: 'å¯„é€è¡Œå‰ä¿¡', fields: [{ label: 'å¯„é€æ—¥æœŸ', value: '' }], completed: false },
            { id: 'post_letter', type: 'post_letter', name: 'å¯„é€èŠ±çµ®ä¿¡', fields: [{ label: 'ç…§ç‰‡é€£çµ', value: '' }], completed: false },
        ];

        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const toCSVField = (text) => {
            if (!text) return '';
            const str = String(text);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        const getTaskStatusStyle = (taskType, eventDateStr) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(eventDateStr);
            const diffTime = target.getTime() - today.getTime();
            const daysDiff = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

            if (taskType === 'insurance') {
                if (daysDiff <= 3 && daysDiff >= 0) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'æ€¥è¿«' };
                if (daysDiff < 0) return { color: 'text-slate-400', bg: 'bg-slate-100', border: 'border-slate-200', label: 'å·²é' };
                return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: 'å¾…è¾¦' };
            }
            if (taskType === 'post_letter') {
                const daysSinceEvent = -daysDiff; 
                if (daysSinceEvent < 1) return { color: 'text-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', label: 'æœªé–‹å§‹' };
                if (daysSinceEvent === 1) return { color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200', label: 'å»ºè­°å¯„é€' };
                if (daysSinceEvent >= 3) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'å»¶é²' };
            }
            return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: '' };
        };

        const getPromiseStatus = (date, time) => {
            if (!date) return { status: 'normal', color: 'text-slate-600', bg: 'bg-white' };
            const now = new Date();
            const dueStr = time ? `${date}T${time}` : `${date}T23:59`;
            const due = new Date(dueStr);
            const diffMs = due - now;
            const diffHrs = diffMs / (1000 * 60 * 60);

            if (diffMs < 0) return { status: 'overdue', color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'å·²éæœŸ' };
            if (diffHrs < 24) return { status: 'urgent', color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200', label: '24hå…§' };
            return { status: 'future', color: 'text-green-700', bg: 'bg-green-50', border: 'border-green-200', label: 'é€²è¡Œä¸­' };
        };

        const downloadCSV = (csvContent, filename = 'export.csv') => {
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        const TASK_GROUP_COLORS = [
            { border: 'border-blue-200', bg: 'bg-blue-50', text: 'text-blue-800', icon: 'text-blue-500' },
            { border: 'border-emerald-200', bg: 'bg-emerald-50', text: 'text-emerald-800', icon: 'text-emerald-500' },
            { border: 'border-amber-200', bg: 'bg-amber-50', text: 'text-amber-800', icon: 'text-amber-500' },
            { border: 'border-purple-200', bg: 'bg-purple-50', text: 'text-purple-800', icon: 'text-purple-500' },
            { border: 'border-rose-200', bg: 'bg-rose-50', text: 'text-rose-800', icon: 'text-rose-500' },
            { border: 'border-cyan-200', bg: 'bg-cyan-50', text: 'text-cyan-800', icon: 'text-cyan-500' },
        ];

        const COLOR_OPTIONS = [
            { value: 'blue', label: 'è—è‰² (é è¨­)', bg: 'bg-blue-50', border: 'border-blue-100', hover: 'hover:bg-blue-100' },
            { value: 'red', label: 'ç´…è‰² (ç†±é–€)', bg: 'bg-red-50', border: 'border-red-100', hover: 'hover:bg-red-100' },
            { value: 'orange', label: 'æ©˜è‰² (å¿«æ»¿)', bg: 'bg-orange-50', border: 'border-orange-100', hover: 'hover:bg-orange-100' },
            { value: 'green', label: 'ç¶ è‰² (å……è¶³)', bg: 'bg-green-50', border: 'border-green-100', hover: 'hover:bg-green-100' },
            { value: 'purple', label: 'ç´«è‰² (ç‰¹åˆ¥)', bg: 'bg-purple-50', border: 'border-purple-100', hover: 'hover:bg-purple-100' },
        ];

        const NavItem = ({ id, icon, label, activeTab, setActiveTab, onClick }) => (
            <button onClick={() => { setActiveTab(id); if(onClick) onClick(); }} className={`flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 w-full text-left ${activeTab === id ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'text-slate-500 hover:bg-white hover:shadow-sm'}`}>
                <Icon name={icon} size={20} />
                <span className="font-medium tracking-wide">{label}</span>
            </button>
        );

        // --- Modals ---

        const LoginModal = ({ onClose, onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);

            const handleSubmit = (e) => {
                e.preventDefault();
                onLogin(password, (isSuccess) => {
                    if (!isSuccess) setError(true);
                });
            };

            return (
                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-sm p-8 shadow-2xl">
                        <div className="flex flex-col items-center mb-6">
                            <div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-3">
                                <Icon name="lock" size={24} />
                            </div>
                            <h3 className="text-xl font-bold text-slate-800">ç®¡ç†å“¡ç™»å…¥</h3>
                            <p className="text-sm text-slate-500">è«‹è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–å¾Œå°</p>
                        </div>
                        <form onSubmit={handleSubmit} className="space-y-4">
                            <div>
                                <input 
                                    type="password" 
                                    className={`w-full p-3 border rounded-xl outline-none transition-all text-center tracking-widest font-bold text-lg ${error ? 'border-red-500 bg-red-50' : 'border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200'}`}
                                    placeholder="è¼¸å…¥å¯†ç¢¼"
                                    value={password}
                                    onChange={e => { setPassword(e.target.value); setError(false); }}
                                    autoFocus
                                />
                                {error && <p className="text-red-500 text-xs text-center mt-2">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</p>}
                            </div>
                            <div className="flex gap-2">
                                <button type="button" onClick={onClose} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors">å–æ¶ˆ</button>
                                <button type="submit" className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors">ç™»å…¥</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const AddPromiseModal = ({ onClose, onSave }) => {
            const [form, setForm] = useState({ content: '', who: '', date: new Date().toISOString().split('T')[0], time: '12:00' });
            return (
                <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="message-square" className="text-purple-500"/> æ–°å¢æ‰¿è«¾</h3><button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button></div><div className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 mb-1">å…§å®¹</label><textarea className="w-full p-3 border rounded-xl resize-none h-24" value={form.content} onChange={e=>setForm({...form, content: e.target.value})}></textarea></div><div><label className="block text-xs font-bold text-slate-500 mb-1">å°è±¡</label><input type="text" className="w-full p-3 border rounded-xl" value={form.who} onChange={e=>setForm({...form, who: e.target.value})} /></div><div className="grid grid-cols-2 gap-3"><input type="date" className="w-full p-3 border rounded-xl" value={form.date} onChange={e=>setForm({...form, date: e.target.value })} /><input type="time" className="w-full p-3 border rounded-xl" value={form.time} onChange={e=>setForm({...form, time: e.target.value })} /></div><button onClick={()=>{if(!form.content)return;onSave(form)}} className="w-full py-3 bg-purple-600 text-white rounded-xl font-bold shadow-lg shadow-purple-200 mt-2">å»ºç«‹</button></div></div></div>
            );
        };

        const InstructorScheduleModal = ({ date, availableInstructors, restingList, onClose, onToggle }) => {
            return (
                <div className="fixed inset-0 bg-black/50 z-[90] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl"><div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icon name="calendar-days" className="text-blue-600"/> {date} æ’ç­</h3><button onClick={onClose}><Icon name="x" className="text-slate-400"/></button></div><p className="text-xs text-slate-500 mb-4">é»æ“Šåˆ‡æ›ä¸Šå·¥ç‹€æ…‹ (ğŸ”´ ä¼‘å‡ / ğŸŸ¢ å¯ä¸Šå·¥)</p><div className="space-y-2 max-h-60 overflow-y-auto">{availableInstructors.map(name => { const isResting = restingList.includes(name); return (<div key={name} onClick={() => onToggle(date, name)} className={`flex justify-between items-center p-3 rounded-xl border cursor-pointer transition-all ${isResting ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`}><span className={`font-bold ${isResting ? 'text-red-700' : 'text-green-700'}`}>{name}</span><span className={`text-xs px-2 py-1 rounded-full font-bold ${isResting ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{isResting ? 'ä¼‘å‡' : 'å¯ä¸Šå·¥'}</span></div>); })} {availableInstructors.length === 0 && <div className="text-center text-slate-400 py-4">æš«ç„¡è¬›å¸«è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹æ´»å‹•æˆ–æ‰‹å‹•è¼¸å…¥ã€‚</div>}</div><div className="mt-4 pt-4 border-t flex justify-end"><button onClick={onClose} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm">å®Œæˆ</button></div></div></div>
            );
        };

        const EventManagerModal = ({ event, config, onClose, onSaveConfig, availableInstructors, instructorSchedule, onCheckInToggle }) => {
            const [capacity, setCapacity] = useState(config?.capacity || 20);
            const [eventNote, setEventNote] = useState(config?.note || '');
            const [eventTime, setEventTime] = useState(config?.time || '');
            const [eventLink, setEventLink] = useState(config?.link || '');
            const [hotThreshold, setHotThreshold] = useState(config?.hotThreshold || 10);
            const [hotColor, setHotColor] = useState(config?.hotColor || 'blue');
            const [tasks, setTasks] = useState(config?.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE)));
            const [instructors, setInstructors] = useState(event.instructor ? event.instructor.split(/[&,]/).map(s=>s.trim()) : []);
            const [tempInstructor, setTempInstructor] = useState('');

            const sortedCustomers = useMemo(() => {
                if (!event.customers) return [];
                return [...event.customers].sort((a, b) => {
                    if (a.transport === 'å…±ä¹˜' && b.transport !== 'å…±ä¹˜') return -1;
                    if (a.transport !== 'å…±ä¹˜' && b.transport === 'å…±ä¹˜') return 1;
                    return 0;
                });
            }, [event.customers]);
            const carpoolCount = event.customers ? event.customers.filter(c => c.transport === 'å…±ä¹˜').length : 0;
            const checkedInCount = event.customers ? event.customers.filter(c => c.isCheckedIn).length : 0;

            const handleTaskToggle = (index) => { const newTasks = [...tasks]; newTasks[index].completed = !newTasks[index].completed; setTasks(newTasks); };
            const handleAddTask = () => { const name = prompt("ä»»å‹™åç¨±:"); if(name) setTasks([...tasks, { id: `custom_${Date.now()}`, name, fields: [], completed: false }]); };
            const handleDeleteTask = (index) => { if(confirm("åˆªé™¤?")) { const n=[...tasks]; n.splice(index,1); setTasks(n); } };
            
            const addInstructor = (name) => { const clean = name.trim(); if(!clean) return; const isResting = instructorSchedule[event.date] && instructorSchedule[event.date].includes(clean); if (isResting) { if(!confirm(`${clean} åœ¨ ${event.date} å·²æ’ä¼‘ï¼Œç¢ºå®šè¦æ’å…¥å—ï¼Ÿ`)) return; } if (!instructors.includes(clean)) setInstructors([...instructors, clean]); setTempInstructor(''); };
            const removeInstructor = (name) => { setInstructors(instructors.filter(i => i !== name)); };
            
            const handleSave = () => { 
                const newInstructorStr = instructors.join(' & ');
                onSaveConfig({ 
                    capacity: parseInt(capacity), 
                    tasks, 
                    note: eventNote, 
                    time: eventTime, 
                    link: eventLink,
                    hotThreshold: parseInt(hotThreshold),
                    hotColor: hotColor
                }, newInstructorStr); 
                onClose(); 
            };

            const progress = Math.round((tasks.filter(t => t.completed).length / Math.max(tasks.length, 1)) * 100);

            return (
                <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl m-auto"><div className="p-6 border-b border-slate-100 flex justify-between items-center"><div><div className="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded mb-1 inline-block">{event.date}</div><h3 className="text-xl font-bold text-slate-800">{event.eventName}</h3></div><button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button></div><div className="p-6 overflow-y-auto space-y-6"><section><h4 className="font-bold text-slate-700 mb-2 flex items-center"><Icon name="user" size={18} className="mr-2"/> å¸¶åœ˜è¬›å¸«</h4><div className="bg-slate-50 p-3 rounded-xl border border-slate-200"><div className="flex flex-wrap gap-2 mb-2">{instructors.map(ins=><div key={ins} className="flex items-center bg-white text-blue-700 px-2 py-1 rounded-md text-sm border border-blue-100 shadow-sm"><span className="mr-1">{ins}</span><button onClick={()=>removeInstructor(ins)}><Icon name="x" size={14} className="text-slate-400 hover:text-red-500"/></button></div>)}{instructors.length===0 && <span className="text-xs text-slate-400 py-1">æœªæŒ‡å®šè¬›å¸«</span>}</div><div className="flex gap-2 mb-2"><input type="text" className="flex-1 px-3 py-1.5 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" value={tempInstructor} onChange={e=>setTempInstructor(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addInstructor(tempInstructor)} placeholder="è¼¸å…¥åå­—..."/><button onClick={()=>addInstructor(tempInstructor)} className="px-3 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"><Icon name="plus" size={16}/></button></div><div className="flex flex-wrap gap-2">{availableInstructors.slice(0,5).map(i=><button key={i} onClick={()=>addInstructor(i)} className="text-xs px-2 py-1 bg-white border rounded-full hover:bg-blue-50 text-slate-600">+ {i}</button>)}</div></div></section>
                
                <section>
                    <div className="flex justify-between items-center mb-3">
                        <h4 className="font-bold text-slate-700 flex items-center"><Icon name="users" size={18} className="mr-2"/> å ±ååå–® ({checkedInCount}/{event.count})</h4>
                        <span className="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-full">å…±ä¹˜éœ€æ±‚: {carpoolCount} äºº</span>
                    </div>
                    <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 max-h-60 overflow-y-auto">
                        {sortedCustomers.length > 0 ? (
                            <ul className="space-y-2">
                                {sortedCustomers.map((c, i) => (
                                    <li key={i} className={`flex justify-between items-center text-sm p-2 rounded-lg ${c.transport === 'å…±ä¹˜' ? 'bg-white border border-orange-100 shadow-sm' : 'border-b border-slate-100'}`}>
                                        <div className="flex items-center gap-3">
                                            <button onClick={(e)=>{e.stopPropagation(); onCheckInToggle(c.id, c.isCheckedIn);}} className={`w-5 h-5 rounded flex items-center justify-center border transition-colors ${c.isCheckedIn ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-slate-300 text-transparent hover:border-blue-400'}`}>
                                                <Icon name="check" size={14} />
                                            </button>
                                            <div className="flex flex-col">
                                                <span className={`font-medium ${c.isCheckedIn ? 'text-green-700' : 'text-slate-700'}`}>{c.customerName}</span>
                                                {c.transport === 'å…±ä¹˜' && <span className="text-[10px] text-orange-500 flex items-center"><Icon name="car" size={10} className="mr-0.5"/> å…±ä¹˜</span>}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <span className="text-xs text-slate-400">{c.source || '-'}</span>
                                            {c.isCheckedIn && <span className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded">å·²å ±åˆ°</span>}
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        ) : <div className="text-slate-400 text-center text-sm py-2">ç›®å‰å°šç„¡å ±å</div>}
                    </div>
                </section>
                
                <section>
                    <h4 className="font-bold text-slate-700 mb-3 flex items-center"><Icon name="settings" size={18} className="mr-2"/> æ´»å‹•è¨­å®š</h4>
                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4">
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <span className="text-slate-500 text-xs font-bold mb-1 block">æ´»å‹•æ™‚é–“</span>
                                <input type="time" value={eventTime} onChange={e=>setEventTime(e.target.value)} className="w-full px-2 py-1.5 text-center border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-white"/>
                            </div>
                            <div>
                                <span className="text-slate-500 text-xs font-bold mb-1 block">äººæ•¸ä¸Šé™</span>
                                <input type="number" value={capacity} onChange={e=>setCapacity(e.target.value)} className="w-full px-2 py-1.5 text-center border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-white"/>
                            </div>
                        </div>
                        <div className="grid grid-cols-2 gap-4">
                            <div>
                                <span className="text-slate-500 text-xs font-bold mb-1 block">ğŸ”¥ ç†±é–€é–€æª» (äºº)</span>
                                <input type="number" value={hotThreshold} onChange={e=>setHotThreshold(e.target.value)} className="w-full px-2 py-1.5 text-center border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-white"/>
                            </div>
                            <div>
                                <span className="text-slate-500 text-xs font-bold mb-1 block">ğŸ¨ ç†±é–€é¡è‰²</span>
                                <select value={hotColor} onChange={e=>setHotColor(e.target.value)} className="w-full px-2 py-1.5 text-center border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-white">
                                    {COLOR_OPTIONS.map(c => <option key={c.value} value={c.value}>{c.label}</option>)}
                                </select>
                            </div>
                        </div>

                        <div>
                            <label className="text-xs font-bold text-slate-500 mb-1 block">æ´»å‹•å ±åé€£çµ (å‰å°é»æ“Šè·³è½‰)</label>
                            <input type="text" className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://..." value={eventLink} onChange={e=>setEventLink(e.target.value)} />
                        </div>
                        <div>
                            <label className="text-xs font-bold text-slate-500 mb-1 block">æ´»å‹•å°ˆå±¬å‚™è¨»</label>
                            <textarea className="w-full p-2 border border-slate-300 rounded-lg text-sm h-20 resize-none focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚: è¨˜å¾—å¸¶ç„¡ç·šé›»..." value={eventNote} onChange={e=>setEventNote(e.target.value)}></textarea>
                        </div>
                    </div>
                </section>
                
                <section><div className="flex justify-between items-center mb-2"><h4 className="font-bold text-slate-700 flex items-center"><Icon name="check-square" size={18} className="mr-2"/> åŸ·è¡Œä»»å‹™</h4><button onClick={handleAddTask} className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 flex items-center"><Icon name="plus" size={14} className="mr-1"/> æ–°å¢</button></div><div className="w-full h-1.5 bg-slate-100 rounded-full mb-4 overflow-hidden"><div className="h-full bg-green-500 transition-all duration-500" style={{width: `${progress}%`}}></div></div><div className="space-y-2">{tasks.map((t, i) => (<div key={i} className="flex items-center justify-between p-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 group"><div className="flex items-center gap-3 cursor-pointer" onClick={()=>handleTaskToggle(i)}><div className={`w-4 h-4 rounded border flex items-center justify-center ${t.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300'}`}>{t.completed && <Icon name="check" size={12}/>}</div><span className={`text-sm ${t.completed ? 'text-slate-400 line-through' : 'text-slate-700 font-medium'}`}>{t.name}</span></div><button onClick={()=>handleDeleteTask(i)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={14}/></button></div>))}</div></section></div><div className="p-4 border-t border-slate-100 bg-slate-50/50 rounded-b-2xl flex justify-end gap-2"><button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button><button onClick={handleSave} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md">å„²å­˜è¨­å®š</button></div></div></div>);
        };
        
        const CreateEventModal = ({ onClose, onSave, customTemplates, onSaveTemplate, onDeleteTemplate, availableInstructors, instructorSchedule }) => { /* ...same... */ const [mode, setMode] = useState('template'); const [isCreatingTemplate, setIsCreatingTemplate] = useState(false); const [calendarMonth, setCalendarMonth] = useState(new Date()); const [formData, setFormData] = useState({ dates: [], eventName: '', instructors: [], time: '', link: '' }); const [tempInstructor, setTempInstructor] = useState(''); const [newTemplateData, setNewTemplateData] = useState({ id: null, name: '', eventName: '', instructor: '', time: '', link: '' }); const unavailableInstructors = useMemo(() => { const unavailable = new Set(); formData.dates.forEach(date => { const resting = instructorSchedule[date] || []; resting.forEach(name => unavailable.add(name)); }); return unavailable; }, [formData.dates, instructorSchedule]); const handleTemplateSelect = (tpl) => { let tplInstructors = []; if (tpl.instructor) tplInstructors = tpl.instructor.split(/[&,]/).map(s => s.trim()); setFormData({ ...formData, eventName: tpl.eventName, instructors: tplInstructors, time: tpl.time || '', link: tpl.link || '' }); }; const handleEditTemplate = (e, tpl) => { e.stopPropagation(); setNewTemplateData({ id: tpl.id, name: tpl.name, eventName: tpl.eventName, instructor: tpl.instructor, time: tpl.time || '', link: tpl.link || '' }); setIsCreatingTemplate(true); }; const toggleDate = (year, month, day) => { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; let newDates = formData.dates.includes(dateStr) ? formData.dates.filter(d => d !== dateStr) : [...formData.dates, dateStr].sort(); setFormData({ ...formData, dates: newDates }); }; const addInstructor = (name) => { const clean = name.trim(); const isResting = formData.dates.some(d => instructorSchedule[d] && instructorSchedule[d].includes(clean)); if (isResting) { if(!confirm(`${clean} åœ¨éƒ¨åˆ†é¸å®šçš„æ—¥æœŸå·²æ’ä¼‘ï¼Œç¢ºå®šè¦æ’å…¥å—ï¼Ÿ`)) return; } if (clean && !formData.instructors.includes(clean)) setFormData({ ...formData, instructors: [...formData.instructors, clean] }); setTempInstructor(''); }; const removeInstructor = (name) => { setFormData({ ...formData, instructors: formData.instructors.filter(i => i !== name) }); }; const handleSubmitEvent = () => { if (formData.dates.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸ"); return; } onSave(formData); }; const handleSaveNewTemplate = () => { if (!newTemplateData.name) { alert("è«‹è¼¸å…¥æ¨¡æ¿åç¨±"); return; } onSaveTemplate(newTemplateData); setIsCreatingTemplate(false); setNewTemplateData({ id: null, name: '', eventName: '', instructor: '', time: '', link: '' }); }; const renderCalendar = () => { const year = calendarMonth.getFullYear(); const month = calendarMonth.getMonth(); const daysInMonth = getDaysInMonth(year, month); const firstDay = getFirstDayOfMonth(year, month); const days = Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1)); return ( <div className="bg-slate-50 p-4 rounded-xl border border-slate-200"> <div className="flex justify-between items-center mb-4"> <button onClick={() => setCalendarMonth(new Date(year, month - 1))}><Icon name="chevron-left" size={20}/></button> <span className="font-bold text-slate-700">{year}å¹´ {month + 1}æœˆ</span> <button onClick={() => setCalendarMonth(new Date(year, month + 1))}><Icon name="chevron-right" size={20}/></button> </div> <div className="grid grid-cols-7 text-center mb-2 text-xs font-bold text-slate-400">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}</div> <div className="grid grid-cols-7 gap-1"> {days.map((day, i) => ( <div key={i} className="aspect-square flex items-center justify-center"> {day && (<button onClick={() => toggleDate(year, month, day)} className={`w-8 h-8 rounded-full text-sm transition-all ${formData.dates.includes(`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`) ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-blue-100 text-slate-600'}`}>{day}</button>)} </div> ))} </div> </div> ); }; return ( <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm"> <div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl m-auto"> <div className="p-6 border-b border-slate-100 flex justify-between items-center"><h3 className="text-xl font-bold flex items-center gap-2"><Icon name="zap" className="text-yellow-500"/> å¿«é€Ÿé–‹åœ˜</h3><button onClick={onClose}><Icon name="x" className="text-slate-400"/></button></div> <div className="p-6 overflow-y-auto space-y-6"> {!isCreatingTemplate ? ( <> <div className="flex bg-slate-100 p-1 rounded-lg"><button onClick={()=>setMode('template')} className={`flex-1 py-1.5 text-sm rounded-md transition-all ${mode==='template'?'bg-white shadow text-blue-600':'text-slate-500'}`}>ä½¿ç”¨æ¨¡æ¿</button><button onClick={()=>setMode('custom')} className={`flex-1 py-1.5 text-sm rounded-md transition-all ${mode==='custom'?'bg-white shadow text-blue-600':'text-slate-500'}`}>å®Œå…¨è‡ªè¨‚</button></div> {mode === 'template' && ( <div className="grid grid-cols-3 gap-3"> {[...DEFAULT_EVENT_TEMPLATES, ...customTemplates].map((tpl, i) => ( <div key={i} onClick={()=>handleTemplateSelect(tpl)} className={`relative border rounded-xl p-3 cursor-pointer text-center hover:bg-blue-50 transition-all group ${formData.eventName===tpl.eventName?'border-blue-500 ring-1 ring-blue-500 bg-blue-50':'border-slate-200'}`}> <div className="font-bold text-slate-700 text-sm mb-1">{tpl.name}</div><div className="text-xs text-slate-500">{tpl.instructor}</div><div className="text-[10px] text-slate-400 mt-1">{tpl.time ? `â° ${tpl.time}` : ''}</div> {!tpl.isSystem && <button onClick={(e)=>handleEditTemplate(e, tpl)} className="absolute top-1 right-1 p-1 bg-white rounded-full shadow-sm text-slate-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition"><Icon name="edit-2" size={12}/></button>} </div> ))} <button onClick={()=>setIsCreatingTemplate(true)} className="border border-dashed border-slate-300 rounded-xl p-3 flex flex-col items-center justify-center text-slate-400 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all"><Icon name="plus-circle" className="mb-1"/><span className="text-xs">æ–°å¢æ¨¡æ¿</span></button> </div> )} <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-slate-100"> <div><label className="block text-sm font-medium text-slate-700 mb-2">1. é¸æ“‡æ—¥æœŸ (å¤šé¸)</label>{renderCalendar()}</div> <div className="space-y-4"> <div><label className="block text-sm font-medium text-slate-700 mb-1">2. æ´»å‹•åç¨±</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={formData.eventName} onChange={e=>setFormData({...formData, eventName: e.target.value})} placeholder="è¼¸å…¥åç¨±..."/></div> <div> <label className="block text-sm font-medium text-slate-700 mb-1">3. å¸¶åœ˜è¬›å¸«</label> <div className="flex flex-wrap gap-2 mb-2 min-h-[38px] p-2 bg-white border border-slate-200 rounded-lg">{formData.instructors.map(ins=><div key={ins} className="flex items-center bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm"><span className="mr-1">{ins}</span><button onClick={()=>setFormData({...formData, instructors: formData.instructors.filter(i=>i!==ins)})}><Icon name="x" size={14}/></button></div>)}</div> <div className="flex gap-2"><input type="text" className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" value={tempInstructor} onChange={e=>setTempInstructor(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addInstructor(tempInstructor)} placeholder="è¼¸å…¥åå­—..."/><button onClick={()=>addInstructor(tempInstructor)} className="px-3 bg-slate-100 rounded-lg hover:bg-slate-200"><Icon name="plus" size={18}/></button></div> <div className="flex flex-wrap gap-2 mt-2">{availableInstructors.slice(0,6).map(i=><button key={i} onClick={()=>addInstructor(i)} className={`text-xs px-2 py-1 border rounded-full transition ${unavailableInstructors.has(i)?'bg-slate-100 text-slate-400 border-slate-200':'bg-slate-50 hover:bg-blue-50 text-slate-600'}`}>+ {i}</button>)}</div> </div> 
            {/* [æ–°å¢] æ´»å‹•æ™‚é–“è¼¸å…¥æ¬„ä½ */}
            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">4. æ´»å‹•æ™‚é–“</label>
                <input type="time" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={formData.time} onChange={e=>setFormData({...formData, time: e.target.value})}/>
            </div>
            {/* [æ–°å¢] æ´»å‹•ç¶²å€è¼¸å…¥æ¬„ä½ */}
            <div>
                <label className="block text-sm font-medium text-slate-700 mb-1">5. æ´»å‹•ç¶²å€ (é¸å¡«)</label>
                <input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://..." value={formData.link} onChange={e=>setFormData({...formData, link: e.target.value})}/>
            </div>
            </div> </div> </> ) : ( <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3"> <div className="flex justify-between"><h4 className="font-bold">{newTemplateData.id ? 'ç·¨è¼¯æ¨¡æ¿' : 'å»ºç«‹æ–°æ¨¡æ¿'}</h4><button onClick={()=>{setIsCreatingTemplate(false);setNewTemplateData({id:null,name:'',eventName:'',instructor:'',time:'',link:''})}} className="text-sm text-slate-500">å–æ¶ˆ</button></div> <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="æ¨¡æ¿åç¨± (å¦‚: è±ªè¯åœ˜)" value={newTemplateData.name} onChange={e=>setNewTemplateData({...newTemplateData, name: e.target.value})}/> <div className="grid grid-cols-2 gap-3"> <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="é è¨­æ´»å‹•åç¨±" value={newTemplateData.eventName} onChange={e=>setNewTemplateData({...newTemplateData, eventName: e.target.value})}/> <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="é è¨­è¬›å¸«" value={newTemplateData.instructor} onChange={e=>setNewTemplateData({...newTemplateData, instructor: e.target.value})}/> </div> 
            {/* [æ–°å¢] æ¨¡æ¿æ™‚é–“è¨­å®š */}
            <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">é è¨­æ™‚é–“</label>
                <input type="time" className="w-full px-3 py-2 text-sm border rounded-lg" value={newTemplateData.time} onChange={e=>setNewTemplateData({...newTemplateData, time: e.target.value})}/>
            </div>
            {/* [æ–°å¢] æ¨¡æ¿ç¶²å€è¨­å®š */}
            <div>
                <label className="block text-xs font-bold text-slate-500 mb-1">é è¨­ç¶²å€</label>
                <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="https://..." value={newTemplateData.link} onChange={e=>setNewTemplateData({...newTemplateData, link: e.target.value})}/>
            </div>
            <div className="flex gap-2">{newTemplateData.id && <button onClick={()=>{if(confirm("ç¢ºå®šåˆªé™¤?")){onDeleteTemplate(newTemplateData.id);setIsCreatingTemplate(false);setNewTemplateData({id:null,name:'',eventName:'',instructor:'',time:'',link:''})}}} className="flex-1 py-2 bg-red-100 text-red-600 rounded-lg text-sm">åˆªé™¤</button>}<button onClick={handleSaveNewTemplate} className="flex-[2] py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">å„²å­˜æ¨¡æ¿</button></div> </div> )} </div> {!isCreatingTemplate && <div className="p-4 border-t border-slate-100 flex justify-end items-center gap-4 bg-slate-50/50 rounded-b-2xl"><span className="text-xs text-slate-500">å°‡å»ºç«‹ {formData.dates.length} å ´æ´»å‹•</span><button onClick={()=>onSave(formData)} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md">æ‰¹é‡å»ºç«‹</button></div>} </div> </div> ); };

        const TaskDetailModal = ({ task, eventData, onClose }) => { /* ...same... */ const [copied, setCopied] = useState(false); const exportTaskData = (type) => { let csvContent = "\uFEFF"; if (type === 'insurance') { csvContent += "å§“å,ç”Ÿæ—¥,èº«åˆ†è­‰å­—è™Ÿ\n"; eventData.customers.forEach(c => { const name = c.customerName || ''; const birth = c.birthday || ''; const id = c.idNo || ''; csvContent += `${name},${birth},${id}\n`; }); downloadCSV(csvContent, `${eventData.eventName}_ä¿éšªåå–®.csv`); } else if (type === 'pre_letter') { csvContent += "æ´»å‹•æ—¥æœŸ,æ´»å‹•åç¨±,å§“å,Email,äº¤é€šæ–¹å¼,å‚™è¨»\n"; const sorted = [...eventData.customers].sort((a, b) => { const tA = a.transport || ''; const tB = b.transport || ''; if (tA === 'å…±ä¹˜' && tB !== 'å…±ä¹˜') return -1; if (tA !== 'å…±ä¹˜' && tB === 'å…±ä¹˜') return 1; return 0; }); sorted.forEach(c => { const date = eventData.date || ''; const evtName = eventData.eventName || ''; const name = c.customerName || ''; const email = c.email || ''; const transport = c.transport || ''; const notes = c.notes || ''; const cleanNotes = notes.includes(',') ? `"${notes}"` : notes; csvContent += `${date},${evtName},${name},${email},${transport},${cleanNotes}\n`; }); downloadCSV(csvContent, `${eventData.eventName}_è¡Œå‰ä¿¡åå–®.csv`); } }; const renderContent = () => { if (task.type === 'insurance') { const copyText = eventData.customers.map(c => `${c.customerName}\t${c.idNo}\t${c.birthday}`).join('\n'); const handleCopy = () => { navigator.clipboard.writeText(copyText); setCopied(true); setTimeout(() => setCopied(false), 2000); }; return ( <div className="space-y-4"> <div className="bg-amber-50 border border-amber-200 p-3 rounded-lg flex gap-3"> <Icon name="shield-check" className="text-amber-600 mt-0.5" size={20}/> <div className="text-sm text-amber-800 flex-1"> <p className="font-bold">ä¿éšªè¾¦ç†è³‡è¨Š</p> <p>è«‹å°‡ä¸‹åˆ—åå–®è¤‡è£½ä¸¦æä¾›çµ¦ä¿éšªæ¥­å‹™ï¼Œæˆ–ç›´æ¥åŒ¯å‡º Excelã€‚</p> </div> </div> <div className="flex gap-2 justify-end"> <button onClick={() => exportTaskData('insurance')} className="flex items-center px-3 py-1.5 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700 shadow-sm transition-colors"> <Icon name="download" size={14} className="mr-1"/> åŒ¯å‡ºåå–® (Excel) </button> <button onClick={handleCopy} className="flex items-center px-3 py-1.5 bg-white border border-slate-300 rounded text-xs font-medium hover:bg-slate-50 text-slate-700 shadow-sm transition-colors"> {copied ? <Icon name="check" size={14} className="mr-1 text-green-600"/> : <Icon name="copy" size={14} className="mr-1"/>} {copied ? 'å·²è¤‡è£½' : 'è¤‡è£½æ–‡å­—'} </button> </div> <div className="bg-slate-100 p-4 rounded-lg font-mono text-xs max-h-60 overflow-y-auto whitespace-pre border border-slate-200"> {copyText || "ç„¡è³‡æ–™"} </div> </div> ); } if (task.type === 'pre_letter') { const car = eventData.customers.filter(c=>c.transport==='å…±ä¹˜'); const self = eventData.customers.filter(c=>c.transport!=='å…±ä¹˜'); return ( <div className="space-y-4"> <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg flex gap-3"> <Icon name="mail" className="text-blue-600 mt-0.5" size={20}/> <div className="text-sm text-blue-800 flex-1"> <p className="font-bold">è¡Œå‰ä¿¡å¯„é€</p> <p>å·²è‡ªå‹•åˆ†æµå…±ä¹˜èˆ‡è‡ªè¡Œå‰å¾€çš„å®¢æˆ¶ã€‚å¯åŒ¯å‡ºå®Œæ•´åå–®åŒ…å«å‚™è¨»ã€‚</p> </div> </div> <div className="flex justify-end"> <button onClick={() => exportTaskData('pre_letter')} className="flex items-center px-3 py-1.5 bg-green-600 text-white rounded text-xs font-medium hover:bg-green-700 shadow-sm transition-colors"> <Icon name="download" size={14} className="mr-1"/> åŒ¯å‡ºåå–® (Excel) </button> </div> <div className="grid grid-cols-2 gap-4"> <div className="border border-slate-200 p-3 rounded-lg bg-white"> <h4 className="font-bold text-slate-700 mb-2 text-sm flex items-center"><Icon name="car" size={14} className="mr-1 text-orange-500"/> å…±ä¹˜ ({car.length})</h4> <div className="bg-slate-50 p-2 rounded text-xs h-32 overflow-y-auto text-slate-600"> {car.length ? car.map(c=>(<div key={c.id} className="mb-1">{c.customerName} <span className="text-slate-400">&lt;{c.email}&gt;</span></div>)) : <span className="text-slate-400">ç„¡</span>} </div> </div> <div className="border border-slate-200 p-3 rounded-lg bg-white"> <h4 className="font-bold text-slate-700 mb-2 text-sm flex items-center"><Icon name="footprints" size={14} className="mr-1 text-blue-500"/> è‡ªè¡Œ ({self.length})</h4> <div className="bg-slate-50 p-2 rounded text-xs h-32 overflow-y-auto text-slate-600"> {self.length ? self.map(c=>(<div key={c.id} className="mb-1">{c.customerName} <span className="text-slate-400">&lt;{c.email}&gt;</span></div>)) : <span className="text-slate-400">ç„¡</span>} </div> </div> </div> </div> ); } return <div className="text-center text-slate-500 py-8">ç„¡ç‰¹æ®Šå·¥å…·ï¼Œè«‹ä¾ä¸€èˆ¬æµç¨‹åŸ·è¡Œã€‚</div>; }; return <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl"><div className="p-6 border-b flex justify-between items-center"><div><div className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded inline-block mb-1">{eventData.date}</div><h3 className="text-xl font-bold">{task.name}</h3></div><button onClick={onClose}><Icon name="x"/></button></div><div className="p-6 overflow-y-auto">{renderContent()}</div></div></div>; };
        const MonthlyReport = ({ month, data }) => { /* ...same... */ const [expanded, setExpanded] = useState(false); const stats = useMemo(() => { const rev = data.reduce((a,c)=>a+c.price,0); const pax = data.length; const sources = {}; const activities = {}; data.forEach(c => { sources[c.source || 'æœªçŸ¥'] = (sources[c.source || 'æœªçŸ¥'] || 0) + 1; if (!activities[c.eventName]) { activities[c.eventName] = { count: 0, revenue: 0, dates: new Set() }; } activities[c.eventName].count += 1; activities[c.eventName].revenue += c.price; if (c.date) activities[c.eventName].dates.add(c.date + c.instructor); }); return { rev, pax, sources, activities }; }, [data]); return ( <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-4 transition-all"> <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50" onClick={()=>setExpanded(!expanded)}> <div className="flex items-center gap-4"> <div className="text-lg font-bold text-slate-700">{month}</div> <div className="text-sm text-slate-500 bg-slate-100 px-2 py-0.5 rounded">ç¸½æ”¶ ${stats.rev.toLocaleString()}</div> <div className="text-sm text-slate-500">({stats.pax} äºº)</div> </div> <Icon name={expanded ? 'chevron-up' : 'chevron-down'} className="text-slate-400"/> </div> {expanded && ( <div className="p-4 border-t border-slate-100 bg-slate-50/50 animate-in fade-in space-y-6"> <div> <h5 className="text-xs font-bold text-slate-500 mb-3 uppercase flex items-center"><Icon name="activity" size={14} className="mr-1"/> å„é …æ´»å‹•è¡¨ç¾</h5> <div className="bg-white border border-slate-200 rounded-xl overflow-hidden"> <table className="w-full text-left text-sm"> <thead className="bg-slate-50 border-b border-slate-100 text-slate-500"><tr><th className="px-4 py-2">æ´»å‹•åç¨±</th><th className="px-4 py-2">å ´æ¬¡</th><th className="px-4 py-2">äººæ•¸</th><th className="px-4 py-2">å¹³å‡äººæ•¸</th><th className="px-4 py-2 text-right">ç‡Ÿæ”¶</th></tr></thead> <tbody className="divide-y divide-slate-100"> {Object.entries(stats.activities).map(([name, s], i) => { const sessionCount = s.dates.size || 1; return (<tr key={i} className="hover:bg-slate-50"><td className="px-4 py-2 font-medium text-slate-700">{name}</td><td className="px-4 py-2 text-slate-500">{sessionCount}</td><td className="px-4 py-2 text-slate-500">{s.count}</td><td className="px-4 py-2 text-slate-500">{(s.count / sessionCount).toFixed(1)}</td><td className="px-4 py-2 text-right font-mono text-slate-600">${s.revenue.toLocaleString()}</td></tr>); })} </tbody> </table> </div> </div> <div> <h5 className="text-xs font-bold text-slate-500 mb-2 uppercase flex items-center"><Icon name="share-2" size={14} className="mr-1"/> å ±åç®¡é“åˆ†æ</h5> <div className="flex flex-wrap gap-2">{Object.entries(stats.sources).map(([src, count]) => (<div key={src} className="text-xs px-3 py-1.5 bg-white border rounded-lg shadow-sm flex gap-2"><span className="text-slate-600">{src}</span><span className="font-bold text-blue-600">{count}</span><span className="text-slate-400">({Math.round(count/stats.pax*100)}%)</span></div>))}</div> </div> <div className="flex justify-end pt-2"><button onClick={(e)=>{e.stopPropagation(); downloadCSV(data.map(d=>Object.values(d).join(',')).join('\n'), `${month}_report.csv`)}} className="text-xs text-blue-600 hover:underline flex items-center bg-blue-50 px-3 py-1.5 rounded border border-blue-100"><Icon name="download" size={12} className="mr-1"/> ä¸‹è¼‰æ­¤æœˆè©³ç´°å ±è¡¨</button></div> </div> )} </div> ); };
        const EditRowModal = ({ rowData, onClose, onSave }) => { /* ...same... */ const [form, setForm] = useState({ ...rowData }); return (<div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold">ç·¨è¼¯å ±åè³‡æ–™</h3><button onClick={onClose}><Icon name="x"/></button></div><div className="space-y-4 max-h-[70vh] overflow-y-auto p-1"> <div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold">æ—¥æœŸ</label><input type="date" className="w-full p-2 border rounded" value={form.date} onChange={e=>setForm({...form, date:e.target.value})}/></div><div><label className="text-xs font-bold">æ´»å‹•åç¨±</label><input type="text" className="w-full p-2 border rounded" value={form.eventName} onChange={e=>setForm({...form, eventName:e.target.value})}/></div></div> <div><label className="text-xs font-bold">å®¢æˆ¶å§“å</label><input type="text" className="w-full p-2 border rounded" value={form.customerName} onChange={e=>setForm({...form, customerName:e.target.value})}/></div> <div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold">é‡‘é¡</label><input type="number" className="w-full p-2 border rounded" value={form.price} onChange={e=>setForm({...form, price:e.target.value})}/></div><div><label className="text-xs font-bold">äº¤é€š</label><input type="text" className="w-full p-2 border rounded" value={form.transport} onChange={e=>setForm({...form, transport:e.target.value})}/></div></div> <div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold">Email</label><input type="email" className="w-full p-2 border rounded" value={form.email||''} onChange={e=>setForm({...form, email:e.target.value})}/></div><div><label className="text-xs font-bold">æ‰‹æ©Ÿ</label><input type="text" className="w-full p-2 border rounded" value={form.phone||''} onChange={e=>setForm({...form, phone:e.target.value})}/></div></div> <div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold">è¨‚è³¼æ—¥</label><input type="date" className="w-full p-2 border rounded" value={form.orderDate||''} onChange={e=>setForm({...form, orderDate:e.target.value})}/></div><div><label className="text-xs font-bold">èº«åˆ†è­‰</label><input type="text" className="w-full p-2 border rounded" value={form.idNo||''} onChange={e=>setForm({...form, idNo:e.target.value})}/></div></div> <div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold">ç”Ÿæ—¥</label><input type="date" className="w-full p-2 border rounded" value={form.birthday||''} onChange={e=>setForm({...form, birthday:e.target.value})}/></div><div><label className="text-xs font-bold">ç¤¾ç¾¤æš±ç¨±</label><input type="text" className="w-full p-2 border rounded" value={form.socialName||''} onChange={e=>setForm({...form, socialName:e.target.value})}/></div></div> <div className="grid grid-cols-2 gap-3"><div><label className="text-xs font-bold">å ±åç®¡é“</label><input type="text" className="w-full p-2 border rounded" value={form.source||''} onChange={e=>setForm({...form, source:e.target.value})}/></div><div><label className="text-xs font-bold">å‚™è¨»</label><input type="text" className="w-full p-2 border rounded" value={form.notes||''} onChange={e=>setForm({...form, notes:e.target.value})}/></div></div> </div><div className="flex justify-end mt-6 gap-2"><button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button><button onClick={()=>onSave(form)} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">å„²å­˜è®Šæ›´</button></div></div></div>); };
        const BulkImportModal = ({ onClose, onImport, existingData }) => { /* ...same... */ return <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-2xl h-[85vh] flex flex-col shadow-2xl"><div className="p-6 border-b flex justify-between items-center"><h3 className="text-xl font-bold">æ‰¹é‡åŒ¯å…¥åŠŸèƒ½é–‹ç™¼ä¸­...</h3><button onClick={onClose}><Icon name="x"/></button></div></div></div>; };
        const DataRescueTab = ({ currentAppId, onSwitch }) => { /* ...same... */ const options = [ { id: 'crm-system-v1', label: 'v1 (æ‚¨çš„çœŸå¯¦è³‡æ–™)' }, { id: 'default-app-id', label: 'Default (èˆŠç‰ˆæ¸¬è©¦)' } ]; return ( <div className="bg-white p-6 rounded-2xl shadow-sm border border-orange-200"> <div className="flex items-start gap-4"> <div className="bg-orange-100 p-3 rounded-full text-orange-600"><Icon name="life-buoy" size={24}/></div> <div className="flex-1"> <h3 className="text-xl font-bold text-slate-800 mb-2">è³‡æ–™åº«æ•‘æ´æ§åˆ¶å°</h3> <p className="text-sm text-slate-500 mb-4">å¦‚æœæ‚¨ç™¼ç¾è³‡æ–™éºå¤±ï¼Œè«‹å˜—è©¦åˆ‡æ›ä¸‹æ–¹çš„è³‡æ–™ä¾†æºã€‚é€™é€šå¸¸ç™¼ç”Ÿåœ¨ç³»çµ±æ›´æ–°å¾Œã€‚</p> <div className="grid grid-cols-1 md:grid-cols-2 gap-4"> {options.map(opt => ( <div key={opt.id} onClick={() => onSwitch(opt.id)} className={`p-4 rounded-xl border cursor-pointer transition-all flex justify-between items-center ${currentAppId === opt.id ? 'bg-orange-50 border-orange-400 ring-1 ring-orange-400' : 'hover:bg-slate-50 border-slate-200'}`} > <div> <div className="font-bold text-slate-700">{opt.label}</div> <div className="text-xs text-slate-400 font-mono">{opt.id}</div> </div> {currentAppId === opt.id && <Icon name="check-circle" className="text-orange-500" size={20}/>} </div> ))} </div> </div> </div> </div> ); };

        const MainApp = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('events'); 
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [showDebug, setShowDebug] = useState(false);
            const [showCreateEvent, setShowCreateEvent] = useState(false);
            const [showAddPromise, setShowAddPromise] = useState(false); 
            const [showBulkImport, setShowBulkImport] = useState(false); 
            const [showScheduleModal, setShowScheduleModal] = useState(false); 
            const [scheduleDate, setScheduleDate] = useState(''); 
            const [editingEvent, setEditingEvent] = useState(null); 
            const [editingRow, setEditingRow] = useState(null); 
            const [eventsViewMode, setEventsViewMode] = useState('calendar');
            const [importSearch, setImportSearch] = useState(''); 
            const [promiseSearch, setPromiseSearch] = useState('');
            
            const [dbSource, setDbSource] = useState('crm-system-v1'); 

            const [csvInput, setCsvInput] = useState('');
            const [parsedData, setParsedData] = useState([]);
            const [eventConfigs, setEventConfigs] = useState({});
            const [customTemplates, setCustomTemplates] = useState([]);
            const [projects, setProjects] = useState([]); 
            const [promises, setPromises] = useState([]);
            const [instructorSchedule, setInstructorSchedule] = useState({}); 
            
            const [newPasswordInput, setNewPasswordInput] = useState('');
            const [passwordSaveStatus, setPasswordSaveStatus] = useState('idle'); 
            const [addRegStatus, setAddRegStatus] = useState('idle'); 
            
            const [viewMode, setViewMode] = useState('public');
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');

            const [activeTaskDetail, setActiveTaskDetail] = useState(null);
            const [selectedCustomer, setSelectedCustomer] = useState('');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [crmSearchTerm, setCrmSearchTerm] = useState('');
            const [showCrmDropdown, setShowCrmDropdown] = useState(false);
            const [newReg, setNewReg] = useState({
                date: new Date().toISOString().split('T')[0], eventName: '', instructor: '', customerName: '', 
                price: '', transport: '', idNo: '', birthday: '', email: '', source: '', orderDate: new Date().toISOString().split('T')[0], phone: ''
            });
            
            // Mobile menu state
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);


            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                return onAuthStateChanged(auth, u => setUser(u));
            }, []);

            useEffect(() => {
                if (!user) return;
                setLoading(true);
                const basePath = `artifacts/${dbSource}/public/data`;
                
                onSnapshot(doc(db, basePath, 'settings', 'auth'), s => {
                    if (s.exists()) {
                        setAdminPassword(s.data().password || '8888');
                    } else {
                        setAdminPassword('8888'); 
                    }
                });

                const updateParsedData = (raw) => {
                    try {
                        const lines = raw.trim().split('\n');
                        const data = lines.slice(1).map((line, i) => {
                            const v = line.split(',');
                            if(v.length < 5) return null;
                            return {
                                id: i, date: v[0]?.trim(), eventName: v[1]?.trim(), instructor: v[2]?.trim(),
                                customerName: v[3]?.trim(), price: parseInt(v[4])||0, transport: v[5]?.trim(),
                                idNo: v[6]?.trim(), birthday: v[7]?.trim(), email: v[8]?.trim(), source: v[9]?.trim(),
                                socialName: v[10]?.trim(), notes: v[11]?.trim(), orderDate: v[12]?.trim(), phone: v[13]?.trim(),
                                isCheckedIn: v[14]?.trim() === '1' 
                            };
                        }).filter(Boolean);
                        setParsedData(data);
                    } catch(e) { console.error(e); }
                };

                const unsub1 = onSnapshot(doc(db, basePath, 'settings', 'main'), s => {
                    if(s.exists()) {
                        const d = s.data().csvData || '';
                        if(d !== csvInput) { setCsvInput(d); updateParsedData(d); }
                    } else { 
                         setDoc(doc(db, basePath, 'settings', 'main'), { csvData: INITIAL_CSV_DATA }); 
                    }
                    setLoading(false);
                });
                // ... subs ...
                const unsub2 = onSnapshot(doc(db, basePath, 'settings', 'templates'), s => setCustomTemplates(s.data()?.list || []));
                const unsub3 = onSnapshot(collection(db, basePath, 'event_configs'), s => {
                    const cfgs = {}; s.forEach(d => cfgs[d.id] = d.data()); setEventConfigs(cfgs);
                });
                const unsub4 = onSnapshot(collection(db, basePath, 'projects'), s => {
                    const p = []; s.forEach(d => p.push({id: d.id, ...d.data()})); 
                    if(p.length===0 && !s.metadata.fromCache && dbSource === 'default-app-id') { 
                        INITIAL_PROJECTS.forEach(ip=>addDoc(collection(db, basePath, 'projects'), ip));
                    }
                    setProjects(p);
                });
                const unsub5 = onSnapshot(collection(db, basePath, 'promises'), s => { 
                    const p = []; s.forEach(d => p.push({id: d.id, ...d.data()})); 
                    setPromises(p.sort((a,b) => new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time)));
                });
                const unsub6 = onSnapshot(doc(db, basePath, 'settings', 'schedule'), s => {
                    if (s.exists()) setInstructorSchedule(s.data().resting || {});
                });

                return () => { unsub1(); unsub2(); unsub3(); unsub4(); unsub5(); unsub6(); };
            }, [user, dbSource]);

            const handleVerifyLogin = (inputPwd, callback) => {
                if (inputPwd === adminPassword) {
                    setViewMode('admin');
                    setShowLoginModal(false);
                    callback(true);
                } else {
                    callback(false);
                }
            };

            // [ä¿®æ”¹] ä¸ä½¿ç”¨ confirm/alertï¼Œæ”¹ç”¨ç‹€æ…‹å›é¥‹
            const handleUpdatePassword = async () => {
                if (!newPasswordInput) return;
                setPasswordSaveStatus('saving');
                try {
                    await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'auth'), { password: newPasswordInput }, { merge: true });
                    setNewPasswordInput('');
                    setPasswordSaveStatus('success');
                    setTimeout(() => setPasswordSaveStatus('idle'), 2000);
                } catch (e) {
                    console.error("Password update failed", e);
                    setPasswordSaveStatus('idle'); 
                }
            };

            const handleToggleInstructorRest = async (date, name) => { /* ...same... */ if (!user) return; const currentResting = instructorSchedule[date] || []; let newResting; if (currentResting.includes(name)) { newResting = currentResting.filter(n => n !== name); } else { newResting = [...currentResting, name]; } const newSchedule = { ...instructorSchedule }; if (newResting.length > 0) { newSchedule[date] = newResting; } else { delete newSchedule[date]; } await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'schedule'), { resting: newSchedule }, { merge: true }); };
            const handleSaveCSV = async (newData) => { if(!user) return; setIsSaving(true); try { setCsvInput(newData); await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { csvData: newData }, { merge: true }); } catch(e) { console.error(e); } finally { setIsSaving(false); } };
            const arrayToCSV = (dataArray) => { let csv = CSV_HEADER + '\n'; dataArray.forEach(row => { const check = row.isCheckedIn ? '1' : '0'; const line = `${row.date||''},${row.eventName||''},${row.instructor||''},${row.customerName||''},${row.price||0},${row.transport||''},${row.idNo||''},${row.birthday||''},${row.email||''},${row.source||''},${row.socialName||''},${toCSVField(row.notes)},${row.orderDate||''},${row.phone||''},${check}`; csv += line + '\n'; }); return csv; };
            const handleUpdateRow = async (newRowData) => { const newData = parsedData.map(row => row.id === newRowData.id ? newRowData : row); await handleSaveCSV(arrayToCSV(newData)); setEditingRow(null); };
            const handleDeleteRow = async (id) => { if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) return; const newData = parsedData.filter(row => row.id !== id); await handleSaveCSV(arrayToCSV(newData)); };
            const handleBulkImport = async (newRows) => { const currentRows = [...parsedData]; const formattedNewRows = newRows.map(r => ({ date: r.date || '', eventName: r.eventName || '', instructor: r.instructor || '', customerName: r.customerName || '', price: r.price || 0, transport: '', idNo: r.idNo || '', birthday: r.birthday || '', email: r.email || '', source: r.source || '', socialName: r.socialName || '', notes: r.notes || '', orderDate: new Date().toISOString().split('T')[0], phone: r.phone || '' })); const finalData = [...currentRows, ...formattedNewRows]; await handleSaveCSV(arrayToCSV(finalData)); };
            
            // [ä¿®æ”¹] ä¸ä½¿ç”¨ alertï¼Œä½¿ç”¨ addRegStatus
            const handleAddManualReg = async () => { 
                if(!newReg.date || !newReg.eventName || !newReg.customerName) { return; } // ç°¡å–®é˜²å‘†
                setAddRegStatus('saving');
                let currentData = csvInput.trim(); 
                if (!currentData || !currentData.startsWith("æ—¥æœŸ")) { currentData = CSV_HEADER + "\n" + currentData; } 
                const newRow = `\n${newReg.date},${newReg.eventName},${newReg.instructor},${newReg.customerName},${newReg.price},${newReg.transport},${newReg.idNo},${newReg.birthday},${newReg.email},${newReg.source},,${newReg.orderDate},${newReg.phone},0`; 
                const updatedCSV = currentData + newRow; 
                await handleSaveCSV(updatedCSV); 
                setNewReg({ date: '', eventName: '', instructor: '', customerName: '', price: '', transport: '', idNo: '', birthday: '', email: '', source: '', orderDate: new Date().toISOString().split('T')[0], phone: '' }); 
                setAddRegStatus('success');
                setTimeout(() => setAddRegStatus('idle'), 2000);
            };
            
            const handleCreateEvent = async ({ dates, eventName, instructors, time, link }) => { // Add time, link
                let rows = '';
                const instr = instructors.join(' & ');
                dates.forEach(d => rows += `\n${d},${eventName},${instr},é–‹æ”¾å ±åä¸­,0,,,,,,,,,0`);
                await handleSaveCSV(csvInput + rows);

                // [ä¿®æ”¹] æ›´æ–° event_configs
                const batch = writeBatch(db);
                dates.forEach(d => {
                    const key = `${d}_${eventName}_${instr}`.replace(/[\/\\#\?]/g, '-');
                    const ref = doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', key);
                    batch.set(ref, { time: time || '', link: link || '' }, { merge: true });
                });
                await batch.commit();

                setShowCreateEvent(false);
            };

            const handleCheckInToggle = async (customerId, currentStatus) => { const row = parsedData.find(r => r.id === customerId); if (row) { await handleUpdateRow({ ...row, isCheckedIn: !currentStatus }); } };
            const handleSaveEventConfig = async (oldEventKey, newConfig, newInstructorStr) => { const affectedRows = parsedData.filter(r => { const key = `${r.date}_${r.eventName}_${r.instructor}`.replace(/[\/\\#\?]/g, '-'); return key === oldEventKey; }); if (newInstructorStr !== undefined) { const newRows = parsedData.map(r => { const key = `${r.date}_${r.eventName}_${r.instructor}`.replace(/[\/\\#\?]/g, '-'); if (key === oldEventKey) { return { ...r, instructor: newInstructorStr }; } return r; }); await handleSaveCSV(arrayToCSV(newRows)); if (affectedRows.length > 0) { const evt = affectedRows[0]; const newKey = `${evt.date}_${evt.eventName}_${newInstructorStr}`.replace(/[\/\\#\?]/g, '-'); if (newKey !== oldEventKey) { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', newKey), newConfig, { merge: true }); } else { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', oldEventKey), newConfig, { merge: true }); } } } else { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', oldEventKey), newConfig, { merge: true }); } };
            const handleSaveTemplate = (tpl) => { let newList; if (tpl.id) { newList = customTemplates.map(t => t.id === tpl.id ? t : t); } else { newList = [...customTemplates, { ...tpl, id: `custom_${Date.now()}` }]; } setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'templates'), { list: newList }, { merge: true }); };
            const handleAddTemplate = (tpl) => handleSaveTemplate(tpl);
            const onDeleteTemplate = (id) => { if(confirm("ç¢ºå®šåˆªé™¤?")) setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'templates'), { list: customTemplates.filter(t=>t.id!==id) }, { merge: true }); };
            const handleProjectStatus = async (pid, status) => { const next = status === 'Stuck' ? 'To Do' : status === 'To Do' ? 'In Progress' : status === 'In Progress' ? 'Done' : 'Stuck'; await updateDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', pid), { status: next }); };
            const handleAddProject = async () => { const name = prompt("å°ˆæ¡ˆåç¨±:"); if(name) await addDoc(collection(db, `artifacts/${dbSource}/public/data`, 'projects'), { name, owner: 'Team', status: 'To Do', deadline: new Date().toISOString().split('T')[0] }); };
            const handleDeleteProject = async (pid) => { if(confirm("åˆªé™¤å°ˆæ¡ˆ?")) await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', pid)); };
            const handleAddPromise = async (data) => { await addDoc(collection(db, `artifacts/${dbSource}/public/data`, 'promises'), { ...data, status: 'pending', createdAt: new Date().toISOString() }); setShowAddPromise(false); };
            const handleTogglePromise = async (id, currentStatus) => { await updateDoc(doc(db, `artifacts/${dbSource}/public/data`, 'promises', id), { status: currentStatus === 'done' ? 'pending' : 'done' }); };
            const handleDeletePromise = async (id) => { if(confirm("åˆªé™¤æ­¤æ‰¿è«¾ï¼Ÿ")) await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'promises', id)); };

            const stats = useMemo(() => { const totalRev = parsedData.reduce((a,c) => a + c.price, 0); const events = {}; const instrs = {}; parsedData.forEach(c => { const key = `${c.date}_${c.eventName}_${c.instructor}`.replace(/[\/\\#\?]/g, '-'); if(!events[key]) events[key] = { ...c, count: 0, customers: [], key }; if(c.customerName !== 'é–‹æ”¾å ±åä¸­') { events[key].count++; events[key].customers.push(c); } if(c.instructor) c.instructor.split(/[&,]/).forEach(i => { const name = i.trim(); if(name && name !== 'æœªå®š') instrs[name] = (instrs[name]||0)+1; }); }); return { totalRev, totalPax: parsedData.length, events, instrs }; }, [parsedData]);
            const dashboardData = useMemo(() => { const now = new Date(); const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; const monthlyGroups = {}; parsedData.forEach(c => { if (!c.date) return; const m = c.date.substring(0, 7); if (c.customerName === 'é–‹æ”¾å ±åä¸­') return; if (!monthlyGroups[m]) monthlyGroups[m] = []; monthlyGroups[m].push(c); }); const currentMonthData = monthlyGroups[currentMonthStr] || []; const currentMonthRev = currentMonthData.reduce((a,c)=>a+c.price,0); const currentMonthPax = currentMonthData.length; return { monthlyGroups, currentMonthRev, currentMonthPax }; }, [parsedData]);
            const tasks = useMemo(() => { const list = []; Object.values(stats.events).forEach(evt => { const cfg = eventConfigs[evt.key] || {}; const tList = cfg.tasks || DEFAULT_TASKS_TEMPLATE; tList.forEach((t, i) => { if(!t.completed) list.push({ ...t, taskIdx: i, evtDate: evt.date, evtName: evt.eventName, cfgKey: evt.key, style: getTaskStatusStyle(t.type, evt.date), fullEvent: evt }); }); }); return list.sort((a,b) => new Date(a.evtDate) - new Date(b.evtDate)); }, [stats.events, eventConfigs]);
            const toggleTask = async (key, idx) => { const cfg = eventConfigs[key] || {}; const tList = cfg.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE)); tList[idx].completed = !tList[idx].completed; await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', key), { ...cfg, tasks: tList }, { merge: true }); };
            const uniqueCustomers = [...new Set(parsedData.map(d => d.customerName))].filter(n => n !== 'é–‹æ”¾å ±åä¸­');
            const filteredCrmCustomers = uniqueCustomers.filter(c => c.toLowerCase().includes(crmSearchTerm.toLowerCase()));
            const customerProfile = useMemo(() => { if (!selectedCustomer) return null; const history = parsedData.filter(d => d.customerName === selectedCustomer); const totalSpend = history.reduce((a,c)=>a+c.price,0); const avgSpend = history.length ? Math.round(totalSpend / history.length) : 0; const lastReg = history[history.length-1]; return { history, totalSpend, avgSpend, email: lastReg?.email, source: lastReg?.source, idNo: lastReg?.idNo, birthday: lastReg?.birthday, transport: lastReg?.transport, phone: lastReg?.phone, socialName: lastReg?.socialName, notes: lastReg?.notes, latestRecord: lastReg }; }, [selectedCustomer, parsedData]);
            const calendarDays = useMemo(() => { const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const daysInMonth = getDaysInMonth(year, month); const firstDay = getFirstDayOfMonth(year, month); return Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1)); }, [currentDate]);
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));

            // Group tasks logic
            const groupedTasks = useMemo(() => {
                return tasks.reduce((acc, task) => {
                    const groupKey = task.name; 
                    if (!acc[groupKey]) {
                        acc[groupKey] = [];
                    }
                    acc[groupKey].push(task);
                    return acc;
                }, {});
            }, [tasks]);

            if(loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-400"><Icon name="loader-2" className="animate-spin mr-2"/> è¼‰å…¥ä¸­...</div>;
            
            const activeEditingEvent = editingEvent && stats.events[editingEvent.key] ? stats.events[editingEvent.key] : editingEvent;

            // [æ–°] å‰å°æ¸²æŸ“é‚è¼¯
            if (viewMode === 'public') {
                return (
                    <div className="min-h-screen bg-white">
                        <nav className="glass-nav sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
                            <Logo className="h-8 w-auto" />
                            <button 
                                onClick={() => setShowLoginModal(true)}
                                className="text-sm text-slate-500 hover:text-blue-600 flex items-center gap-1 px-3 py-1.5 rounded-lg hover:bg-slate-50 transition-colors"
                            >
                                <Icon name="lock" size={14}/> ç®¡ç†å“¡ç™»å…¥
                            </button>
                        </nav>
                        <main className="max-w-5xl mx-auto p-6">
                            <div className="mb-8 text-center">
                                <h1 className="text-3xl font-bold text-slate-800 mb-2">æ´»å‹•å ´æ¬¡è¡¨</h1>
                                <p className="text-slate-500">æ­¡è¿æŸ¥çœ‹æœ€æ–°çš„æ´»å‹•è³‡è¨Š</p>
                            </div>

                            <div className="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden">
                                <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                    <div className="flex items-center gap-4">
                                        <button onClick={prevMonth} className="p-2 hover:bg-white hover:shadow-sm rounded-full transition-all text-slate-500"><Icon name="chevron-left"/></button>
                                        <h2 className="text-2xl font-bold text-slate-800">{currentDate.getFullYear()}å¹´ {currentDate.getMonth()+1}æœˆ</h2>
                                        <button onClick={nextMonth} className="p-2 hover:bg-white hover:shadow-sm rounded-full transition-all text-slate-500"><Icon name="chevron-right"/></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-7 text-center py-3 text-sm font-bold text-slate-400 bg-white border-b border-slate-100">
                                    {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}
                                </div>
                                <div className="grid grid-cols-7 auto-rows-[220px] bg-slate-50">
                                    {calendarDays.map((day, i) => {
                                        const dateStr = day ? `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}` : '';
                                        const dayEvents = day ? Object.values(stats.events).filter(e => e.date === dateStr) : [];
                                        const isToday = day && new Date().toDateString() === new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toDateString();

                                        return (
                                            <div key={i} className={`border-r border-b border-slate-200 p-2 relative transition-all hover:bg-white ${!day ? 'bg-slate-50' : 'bg-white'} ${isToday ? 'ring-2 ring-blue-500 z-10 bg-blue-50/20' : ''}`}>
                                                {day && (
                                                    <div className="flex flex-col h-full">
                                                        <div className={`text-sm font-bold mb-2 w-7 h-7 flex items-center justify-center rounded-full ${isToday ? 'bg-blue-600 text-white' : 'text-slate-700'}`}>{day}</div>
                                                        <div className="space-y-2 overflow-y-auto no-scrollbar flex-1">
                                                            {dayEvents.map((e, idx) => {
                                                                const cfg = eventConfigs[e.key] || {};
                                                                // [Fix] Define capacity here
                                                                const capacity = cfg.capacity || 20;
                                                                const isHot = e.count >= (cfg.hotThreshold || 10);
                                                                const isFull = capacity > 0 && e.count >= capacity;
                                                                
                                                                let cardClass = 'bg-blue-50 border-blue-100';
                                                                if (isFull) cardClass = 'bg-slate-100 border-slate-200 opacity-80';
                                                                else if (isHot) {
                                                                    const color = COLOR_OPTIONS.find(c => c.value === cfg.hotColor) || COLOR_OPTIONS[0];
                                                                    cardClass = `${color.bg} ${color.border}`;
                                                                }

                                                                return (
                                                                    <div 
                                                                        key={idx} 
                                                                        onClick={() => cfg.link ? window.open(cfg.link, '_blank') : null}
                                                                        className={`p-2 rounded-xl border transition-all group ${cfg.link ? 'cursor-pointer hover:ring-2 hover:ring-blue-200 hover:border-blue-300 hover:shadow-md' : ''} ${cardClass}`}
                                                                    >
                                                                        <div className="font-bold text-sm text-slate-800 mb-1 leading-tight flex justify-between items-center">
                                                                            <span>{e.eventName}</span>
                                                                            {isFull && <span className="text-[10px] bg-slate-600 text-white px-1 rounded ml-1">å·²æ»¿</span>}
                                                                        </div>
                                                                        <div className="flex justify-between items-center text-xs text-slate-500">
                                                                            <div className="flex items-center gap-1"><Icon name="user" size={12}/> {e.instructor || 'æœªå®š'}</div>
                                                                            <div className={`font-bold bg-white px-1.5 py-0.5 rounded ${isFull ? 'text-slate-500' : 'text-blue-600'}`}>{e.count}äºº</div>
                                                                        </div>
                                                                        {cfg.time && <div className="mt-1 text-[10px] text-slate-400 flex items-center gap-1"><Icon name="clock" size={10}/> {cfg.time}</div>}
                                                                    </div>
                                                                );
                                                            })}
                                                        </div>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </main>
                        {showLoginModal && <LoginModal onClose={() => setShowLoginModal(false)} onLogin={handleVerifyLogin} />}
                    </div>
                );
            }

            // Admin View
            return (
                <div className="flex min-h-screen">
                    {/* Mobile Menu Overlay */}
                    {mobileMenuOpen && (
                        <div className="fixed inset-0 z-50 bg-slate-800/50 backdrop-blur-sm md:hidden" onClick={() => setMobileMenuOpen(false)}>
                            <div className="absolute top-0 left-0 w-64 h-full bg-white shadow-xl p-4" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <Logo className="h-6 w-auto" />
                                    <button onClick={() => setMobileMenuOpen(false)} className="p-2 text-slate-500"><Icon name="x" /></button>
                                </div>
                                <nav className="space-y-1">
                                    <NavItem id="tasks" icon="check-square" label="ä»»å‹™æŒ‡æ®ä¸­å¿ƒ" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="promises" icon="message-square" label="æ‰¿è«¾ç‰†" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="events" icon="calendar" label="æ´»å‹•å ´æ¬¡è¡¨" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="projects" icon="briefcase" label="å°ˆæ¡ˆé€²åº¦" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="dashboard" icon="trending-up" label="ç‡Ÿé‹å„€è¡¨æ¿" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="crm" icon="users" label="å®¢æˆ¶ CRM" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <div className="border-t border-slate-100 my-2 pt-2">
                                         <NavItem id="import" icon="database" label="è³‡æ–™åº«ç®¡ç†" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                         <button 
                                            onClick={() => { setViewMode('public'); setMobileMenuOpen(false); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all text-left"
                                        >
                                            <Icon name="eye" size={20} />
                                            <span className="font-medium tracking-wide">é è¦½å‰å°</span>
                                        </button>
                                    </div>
                                </nav>
                            </div>
                        </div>
                    )}

                    <aside className="w-64 bg-white border-r border-slate-200 flex flex-col p-4 hidden md:flex sticky top-0 h-screen">
                        <div className="flex items-center space-x-2 px-4 mb-8 mt-2">
                            <Logo className="h-8 w-auto" />
                        </div>
                        <nav className="space-y-1 flex-1">
                            <NavItem id="tasks" icon="check-square" label="ä»»å‹™æŒ‡æ®ä¸­å¿ƒ" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="promises" icon="message-square" label="æ‰¿è«¾ç‰†" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="events" icon="calendar" label="æ´»å‹•å ´æ¬¡è¡¨" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="projects" icon="briefcase" label="å°ˆæ¡ˆé€²åº¦" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="dashboard" icon="trending-up" label="ç‡Ÿé‹å„€è¡¨æ¿" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="crm" icon="users" label="å®¢æˆ¶ CRM" activeTab={activeTab} setActiveTab={setActiveTab} />
                        </nav>
                        <div className="pt-4 border-t border-slate-100 space-y-2">
                            <NavItem id="import" icon="database" label="è³‡æ–™åº«ç®¡ç†" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <button 
                                onClick={() => setViewMode('public')}
                                className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all"
                            >
                                <Icon name="eye" size={20} />
                                <span className="font-medium tracking-wide">é è¦½å‰å°</span>
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 p-4 md:p-10 overflow-y-auto bg-slate-50/50 relative h-screen">
                        {/* Mobile Header */}
                        <div className="md:hidden mb-6 flex justify-between items-center sticky top-0 z-30 bg-slate-50/90 backdrop-blur-sm py-2">
                            <Logo className="h-6 w-auto" />
                            <button onClick={() => setMobileMenuOpen(true)} className="p-2 bg-white rounded-lg shadow-sm text-slate-600 border border-slate-200"><Icon name="menu" /></button>
                        </div>

                        {/* Tasks, Promises, Events, Projects, Dashboard, CRM, Import */}
                        {activeTab === 'tasks' && (
                            <div className="max-w-6xl mx-auto fade-in pb-20">
                                <header className="mb-8 flex justify-between items-end">
                                    <div><h2 className="text-2xl font-bold text-slate-800 mb-1">ä»»å‹™æŒ‡æ®ä¸­å¿ƒ</h2><p className="text-slate-500 text-sm">æ™ºæ…§è¿½è¹¤ç³»çµ±ï¼Œæ ¹æ“šæ´»å‹•æ—¥æœŸè‡ªå‹•æ’åº</p></div>
                                    <div className="bg-white px-4 py-2 rounded-full border text-sm font-medium whitespace-nowrap">å¾…è™•ç†: <span className="text-blue-600 font-bold ml-1">{tasks.length}</span></div>
                                </header>
                                {Object.keys(groupedTasks).length === 0 ? (
                                    <div className="text-center py-20"><div className="text-6xl mb-4">ğŸ‰</div><h3 className="text-xl font-bold text-slate-700">å¤ªæ£’äº†ï¼ä»»å‹™å·²æ¸…ç©º</h3></div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                        {Object.entries(groupedTasks).map(([taskName, taskList], index) => {
                                            const color = TASK_GROUP_COLORS[index % TASK_GROUP_COLORS.length];
                                            return (
                                                <div key={taskName} className={`rounded-2xl border ${color.border} ${color.bg} p-4 h-fit`}>
                                                    <h3 className={`font-bold text-lg mb-4 ${color.text} flex items-center gap-2`}>
                                                        <Icon name="layers" className={color.icon} size={20}/>
                                                        {taskName} 
                                                        <span className="text-sm opacity-75 font-normal ml-auto bg-white/50 px-2 py-0.5 rounded-full">{taskList.length}</span>
                                                    </h3>
                                                    <div className="space-y-3">
                                                        {taskList.map((t, i) => (
                                                            <div key={`${t.cfgKey}-${t.taskIdx}`} onClick={() => setActiveTaskDetail(t)} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden">
                                                                <div className={`absolute top-0 left-0 w-1 h-full ${t.style.bg.replace('bg-', 'bg-') === 'bg-white' ? 'bg-slate-200' : t.style.bg.replace('bg', 'bg').replace('50', '400')}`}></div>
                                                                <div className="flex justify-between mb-2 pl-2">
                                                                    <span className="bg-slate-100 text-slate-600 text-xs font-mono px-2 py-0.5 rounded">{t.evtDate}</span>
                                                                    {t.style.label && <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${t.style.color} ${t.style.border} ${t.style.bg}`}>{t.style.label}</span>}
                                                                </div>
                                                                <div className="pl-2">
                                                                    <div className="text-sm font-bold text-slate-800 mb-1 truncate">{t.evtName}</div>
                                                                    <button onClick={(e) => { e.stopPropagation(); toggleTask(t.cfgKey, t.taskIdx) }} className="w-full mt-3 py-2 rounded-lg bg-slate-50 text-slate-400 hover:bg-green-500 hover:text-white transition-all flex justify-center gap-2 text-xs font-bold">
                                                                        <Icon name="check-circle-2" size={14} /> æ¨™ç¤ºå®Œæˆ
                                                                    </button>
                                                                </div>
                                                            </div>
                                                        ))}
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* ... (Promises with Search, Events, Projects, Dashboard, CRM, Import logic same as before) ... */}
                        {activeTab === 'promises' && (
                            <div className="max-w-6xl mx-auto fade-in pb-20">
                                <header className="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                                    <div>
                                        <h2 className="text-2xl font-bold text-slate-800 mb-1">åœ˜éšŠæ‰¿è«¾ç‰†</h2>
                                        <p className="text-slate-500 text-sm">ç´€éŒ„é‚£äº›éæ­£å¼ä½†é‡è¦çš„ç´„å®š</p>
                                    </div>
                                    <div className="flex gap-3 w-full md:w-auto">
                                        <div className="relative flex-1 md:w-64"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={18}/><input type="text" placeholder="æœå°‹æ‰¿è«¾..." className="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-purple-500 transition-all" value={promiseSearch} onChange={e => setPromiseSearch(e.target.value)} /></div>
                                        <button onClick={()=>setShowAddPromise(true)} className="bg-purple-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 shadow-md hover:bg-purple-700 whitespace-nowrap"><Icon name="plus" size={18}/> <span className="hidden md:inline">æ–°å¢</span></button>
                                    </div>
                                </header>
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {promises.filter(p => !promiseSearch || (p.content && p.content.toLowerCase().includes(promiseSearch.toLowerCase())) || (p.who && p.who.toLowerCase().includes(promiseSearch.toLowerCase()))).map(p => {
                                        const st = getPromiseStatus(p.date, p.time);
                                        const isDone = p.status === 'done';
                                        return (
                                            <div key={p.id} className={`bg-white p-5 rounded-2xl border shadow-sm relative transition-all ${isDone ? 'opacity-50 border-slate-100' : 'border-slate-200 hover:shadow-md'}`}>
                                                <button onClick={()=>handleDeletePromise(p.id)} className="absolute top-3 right-3 text-slate-300 hover:text-red-400 opacity-0 hover:opacity-100 transition"><Icon name="trash-2" size={16}/></button>
                                                <div className="flex items-center gap-2 mb-3"><span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${isDone ? 'text-slate-400 border-slate-200 bg-slate-50' : `${st.color} ${st.border} ${st.bg}`}`}>{isDone ? 'å·²å®Œæˆ' : st.label}</span><span className="text-xs text-slate-400 flex items-center gap-1"><Icon name="clock" size={12}/> {p.date} {p.time}</span></div>
                                                <h4 className={`font-bold text-lg mb-2 ${isDone ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{p.content}</h4>
                                                {p.who && <div className="text-sm text-slate-500 mb-4 flex items-center gap-1"><Icon name="user" size={14}/> {p.who}</div>}
                                                <button onClick={()=>handleTogglePromise(p.id, p.status)} className={`w-full py-2 rounded-xl border font-bold text-sm flex items-center justify-center gap-2 transition-all ${isDone ? 'bg-slate-50 text-slate-400 border-slate-200' : 'bg-white text-purple-600 border-purple-200 hover:bg-purple-50'}`}>{isDone ? 'é‡å•Ÿä»»å‹™' : 'æ¨™ç¤ºå®Œæˆ'}</button>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        )}

                        {activeTab === 'events' && (
                            <div className="fade-in max-w-6xl mx-auto pb-20">
                                <header className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">æ´»å‹•å ´æ¬¡</h2><div className="flex gap-3"><button onClick={()=>setShowCreateEvent(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-md whitespace-nowrap"><Icon name="plus" size={18}/> <span className="hidden md:inline">å¿«é€Ÿé–‹åœ˜</span><span className="md:hidden">é–‹åœ˜</span></button><div className="bg-white p-1 rounded-lg border flex"><button onClick={()=>setEventsViewMode('list')} className={`p-2 rounded-md ${eventsViewMode==='list'?'bg-slate-100':''}`}><Icon name="list" size={18}/></button><button onClick={()=>setEventsViewMode('calendar')} className={`p-2 rounded-md ${eventsViewMode==='calendar'?'bg-slate-100':''}`}><Icon name="calendar" size={18}/></button></div></div></header>
                                {eventsViewMode === 'list' && (
                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden table-container">
                                        <table className="w-full text-left min-w-[600px]">
                                            <thead className="bg-slate-50 border-b border-slate-100 text-slate-500 text-sm"><tr><th className="px-6 py-4 whitespace-nowrap">æ—¥æœŸ</th><th className="px-6 py-4 whitespace-nowrap">æ´»å‹•</th><th className="px-6 py-4 whitespace-nowrap">å ±å</th><th className="px-6 py-4 whitespace-nowrap">æ“ä½œ</th></tr></thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {Object.values(stats.events).map((e, i) => {
                                                    const cfg = eventConfigs[e.key] || {};
                                                    const cap = cfg.capacity || 20;
                                                    const isFull = e.count >= cap;
                                                    const carpool = e.customers ? e.customers.filter(c=>c.transport==='å…±ä¹˜').length : 0;
                                                    return (
                                                        <tr key={i} className="hover:bg-slate-50/80">
                                                            <td className="px-6 py-4 text-slate-600 whitespace-nowrap">{e.date}</td>
                                                            <td className="px-6 py-4"><div className="font-bold text-slate-800">{e.eventName}</div><div className="text-xs text-slate-400 mt-0.5">{e.instructor}</div></td>
                                                            <td className="px-6 py-4"><div className="flex items-center gap-2"><span className={`font-bold ${isFull?'text-red-500':'text-slate-700'}`}>{e.count}</span><span className="text-xs text-slate-400">/ {cap}</span><div className="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${isFull?'bg-red-500':'bg-green-500'}`} style={{width:`${Math.min((e.count/cap)*100,100)}%`}}></div></div></div>{carpool > 0 && <div className="text-[10px] text-orange-500 mt-1 flex items-center"><Icon name="car" size={10} className="mr-1"/> å…±ä¹˜ {carpool} äºº</div>}</td>
                                                            <td className="px-6 py-4"><button onClick={()=>setEditingEvent(e)} className="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded flex items-center gap-1 text-sm whitespace-nowrap"><Icon name="settings" size={14}/> ç®¡ç†</button></td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                {eventsViewMode === 'calendar' && (
                                    <div className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 table-container">
                                        <div className="flex justify-between items-center mb-6 sticky left-0">
                                            <div className="flex items-center gap-2"><button onClick={prevMonth} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevron-left"/></button><h3 className="text-xl font-bold text-slate-800 whitespace-nowrap">{currentDate.getFullYear()}å¹´ {currentDate.getMonth()+1}æœˆ</h3><button onClick={nextMonth} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevron-right"/></button></div>
                                        </div>
                                        <div className="min-w-[600px]">
                                            <div className="grid grid-cols-7 mb-2 text-center text-sm font-bold text-slate-400">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}</div>
                                            {/* [ä¿®æ”¹] é«˜åº¦ 160px */}
                                            <div className="grid grid-cols-7 auto-rows-[160px] border-t border-l border-slate-200">
                                                {calendarDays.map((day, i) => {
                                                    const dateStr = day ? `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}` : '';
                                                    const dayEvents = day ? Object.values(stats.events).filter(e => e.date === dateStr) : [];
                                                    return (
                                                        <div key={i} className={`border-b border-r border-slate-200 p-1 md:p-2 relative ${day ? 'hover:bg-slate-50' : 'bg-slate-50/50'}`}>
                                                            {day && (
                                                                <>
                                                                    <div className="flex justify-between items-start"><div className="text-sm font-medium mb-1">{day}</div><button onClick={(e)=>{e.stopPropagation();setShowScheduleModal(true);setScheduleDate(dateStr)}} className="text-slate-300 hover:text-blue-600"><Icon name="calendar-days" size={14}/></button></div>
                                                                    {/* [ä¿®æ”¹] åˆ—è¡¨é«˜åº¦ 120px */}
                                                                    <div className="space-y-1 overflow-y-auto max-h-[120px] no-scrollbar">
                                                                        {dayEvents.map((e, idx) => {
                                                                            const cfg = eventConfigs[e.key] || {};
                                                                            return (
                                                                                <div key={idx} onClick={(evt)=>{ evt.stopPropagation(); setEditingEvent(e); }} className="mb-1 p-1.5 rounded-lg border border-blue-100 bg-blue-50 hover:bg-blue-100 cursor-pointer transition-all group">
                                                                                    <div className="flex justify-between items-start mb-0.5">
                                                                                        <div className="font-bold text-xs text-blue-800 truncate flex-1">{e.eventName}</div>
                                                                                        {cfg.time && <div className="text-[10px] text-slate-500 bg-white px-1 rounded ml-1 whitespace-nowrap">{cfg.time}</div>}
                                                                                    </div>
                                                                                    <div className="flex justify-between items-center">
                                                                                        <div className="text-[10px] text-slate-600 flex items-center truncate max-w-[60%]"><Icon name="user" size={10} className="mr-0.5 flex-shrink-0"/><span className="truncate">{e.instructor || 'æœªå®š'}</span></div>
                                                                                        <div className="text-[10px] font-bold text-blue-600 bg-white px-1 rounded-md shadow-sm">{e.count}äºº</div>
                                                                                    </div>
                                                                                </div>
                                                                            );
                                                                        })}
                                                                        {instructorSchedule[dateStr] && instructorSchedule[dateStr].length > 0 && (<div className="text-[10px] text-red-400 flex flex-wrap gap-1 mt-1">{instructorSchedule[dateStr].map(name => <span key={name} className="bg-red-50 px-1 rounded">{name}ä¼‘</span>)}</div>)}
                                                                    </div>
                                                                </>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'projects' && (
                            <div className="fade-in max-w-6xl mx-auto pb-20">
                                <header className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">å°ˆæ¡ˆé€²åº¦</h2><button onClick={handleAddProject} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"><Icon name="plus" size={18}/> æ–°å¢ä»»å‹™</button></header>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {['To Do', 'In Progress', 'Done'].map(status => (
                                        <div key={status} className="bg-slate-100/50 p-4 rounded-2xl border border-slate-200/60">
                                            <h3 className="text-sm font-bold text-slate-500 uppercase mb-4 flex justify-between">{status} <span className="bg-white px-2 py-0.5 rounded shadow-sm text-slate-800">{projects.filter(p => { if(status==='To Do') return p.status==='To Do'||p.status==='Stuck'; if(status==='In Progress') return p.status==='In Progress'; return p.status==='Done'; }).length}</span></h3>
                                            <div className="space-y-3">
                                                {projects.filter(p => { if(status==='To Do') return p.status==='To Do'||p.status==='Stuck'; if(status==='In Progress') return p.status==='In Progress'; return p.status==='Done'; }).map(p => (
                                                    <div key={p.id} onClick={()=>handleProjectStatus(p.id, p.status)} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition cursor-pointer group relative">
                                                        <button onClick={(e)=>{e.stopPropagation();handleDeleteProject(p.id)}} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icon name="trash-2" size={14}/></button>
                                                        <div className={`text-[10px] font-bold px-2 py-0.5 rounded w-fit mb-2 ${p.status==='Stuck'?'bg-red-100 text-red-600':p.status==='Done'?'bg-green-100 text-green-600':'bg-blue-50 text-blue-600'}`}>{p.status}</div>
                                                        <div className="font-bold text-slate-800">{p.name}</div>
                                                        <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-50">
                                                            <div className="text-xs text-slate-400 flex items-center gap-1"><Icon name="clock" size={12}/> {p.deadline}</div>
                                                            <div className="w-6 h-6 bg-slate-100 rounded-full flex items-center justify-center text-xs font-bold text-slate-600">{p.owner?.[0]}</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'dashboard' && (
                            <div className="fade-in max-w-6xl mx-auto space-y-8 pb-20">
                                <header className="flex justify-between items-center"><h2 className="text-2xl font-bold">ç‡Ÿé‹å„€è¡¨æ¿</h2><button onClick={()=>downloadCSV(csvInput, 'full_export.csv')} className="text-sm bg-slate-800 text-white px-4 py-2 rounded-lg flex items-center gap-2"><Icon name="download" size={16}/> åŒ¯å‡ºç¸½è¡¨ (Excel)</button></header>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-blue-100 relative overflow-hidden"><div className="absolute -right-4 -top-4 text-blue-50 opacity-50"><Icon name="trending-up" size={100}/></div><div className="relative"><div className="text-sm font-bold text-blue-600 mb-1 uppercase tracking-wider">æœ¬æœˆç‡Ÿæ”¶</div><div className="text-4xl font-bold text-slate-800">${dashboardData.currentMonthRev.toLocaleString()}</div></div></div>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100 relative overflow-hidden"><div className="absolute -right-4 -top-4 text-indigo-50 opacity-50"><Icon name="users" size={100}/></div><div className="relative"><div className="text-sm font-bold text-indigo-600 mb-1 uppercase tracking-wider">æœ¬æœˆäººæ¬¡</div><div className="text-4xl font-bold text-slate-800">{dashboardData.currentMonthPax} <span className="text-lg font-normal text-slate-400">äºº</span></div></div></div>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><div className="text-sm font-medium text-slate-500 mb-4">æ­·å²ç¸½ç‡Ÿæ”¶</div><div className="text-2xl font-bold text-slate-700">${stats.totalRev.toLocaleString()}</div></div>
                                </div>
                                <div><h3 className="text-lg font-bold text-slate-700 mb-4">æœˆåº¦ç‡Ÿé‹å ±è¡¨</h3>{Object.entries(dashboardData.monthlyGroups).sort((a,b)=>b[0].localeCompare(a[0])).map(([month, data]) => (<MonthlyReport key={month} month={month} data={data} />))}</div>
                            </div>
                        )}

                        {/* [ä¿®æ”¹] CRM: å¢åŠ ç·¨è¼¯æŒ‰éˆ• */}
                        {activeTab === 'crm' && (
                            <div className="fade-in max-w-6xl mx-auto pb-20">
                                <h2 className="text-2xl font-bold mb-6">å®¢æˆ¶ CRM</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <div className="relative mb-6">
                                        <Icon name="search" className="absolute left-3 top-3 text-slate-400" size={20}/>
                                        <input 
                                            type="text" 
                                            className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all"
                                            placeholder="è¼¸å…¥å§“åæœå°‹å®¢æˆ¶..."
                                            value={crmSearchTerm}
                                            onChange={(e) => {
                                                setCrmSearchTerm(e.target.value);
                                                setShowCrmDropdown(true);
                                                setSelectedCustomer('');
                                            }}
                                            onFocus={() => setShowCrmDropdown(true)}
                                            onBlur={() => setTimeout(() => setShowCrmDropdown(false), 200)}
                                        />
                                        {showCrmDropdown && crmSearchTerm && (
                                            <div className="absolute z-10 w-full bg-white border border-slate-200 rounded-xl shadow-lg mt-1 max-h-60 overflow-y-auto">
                                                {filteredCrmCustomers.length > 0 ? (
                                                    filteredCrmCustomers.map(c => (
                                                        <div 
                                                            key={c} 
                                                            className="p-3 hover:bg-blue-50 cursor-pointer text-slate-700"
                                                            onClick={() => {
                                                                setSelectedCustomer(c);
                                                                setCrmSearchTerm(c);
                                                                setShowCrmDropdown(false);
                                                            }}
                                                        >
                                                            {c}
                                                        </div>
                                                    ))
                                                ) : (
                                                    <div className="p-3 text-slate-400 text-sm">æ‰¾ä¸åˆ°ç›¸ç¬¦çš„å®¢æˆ¶</div>
                                                )}
                                            </div>
                                        )}
                                    </div>
                                    {customerProfile ? (
                                        <div className="animate-in fade-in slide-in-from-top-4">
                                            {/* å®¢æˆ¶è³‡æ–™å¡ */}
                                            <div className="flex flex-col md:flex-row gap-8 mb-8 pb-8 border-b border-slate-100 relative">
                                                {/* [æ–°å¢] ç·¨è¼¯æŒ‰éˆ• */}
                                                <button 
                                                    onClick={() => setEditingRow(customerProfile.latestRecord)}
                                                    className="absolute top-0 right-0 text-slate-400 hover:text-blue-600 flex items-center gap-1 text-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition"
                                                >
                                                    <Icon name="edit-2" size={14}/> <span className="hidden md:inline">ç·¨è¼¯è³‡æ–™/å‚™è¨»</span><span className="md:hidden">ç·¨è¼¯</span>
                                                </button>

                                                <div className="flex items-center gap-6">
                                                    <div className="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-4xl font-bold text-white shadow-lg shrink-0">{selectedCustomer[0]}</div>
                                                    <div>
                                                        <div className="text-3xl font-bold text-slate-800 mb-1">{selectedCustomer}</div>
                                                        <div className="text-sm text-slate-500 flex items-center gap-2"><Icon name="credit-card" size={14}/> ç¸½æ¶ˆè²»: <span className="text-blue-600 font-bold">${customerProfile.totalSpend.toLocaleString()}</span></div>
                                                    </div>
                                                </div>
                                                <div className="flex-1 bg-slate-50 p-4 rounded-xl border border-slate-100 grid grid-cols-2 gap-y-3 gap-x-6 text-sm mt-4 md:mt-0">
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">Email</span>{customerProfile.email || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">æ‰‹æ©Ÿ</span>{customerProfile.phone || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">èº«åˆ†è­‰</span>{customerProfile.idNo || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">ç”Ÿæ—¥</span>{customerProfile.birthday || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">å¸¸ç”¨äº¤é€š</span>{customerProfile.transport || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">ä¾†æºç®¡é“</span>{customerProfile.source || '-'}</div>
                                                    <div><span className="block text-xs text-slate-400 font-bold uppercase">ç¤¾ç¾¤æš±ç¨±</span>{customerProfile.socialName || '-'}</div>
                                                    <div className="col-span-2"><span className="block text-xs text-slate-400 font-bold uppercase">å‚™è¨»</span>{customerProfile.notes || '-'}</div>
                                                </div>
                                            </div>

                                            <h4 className="font-bold text-slate-700 mb-4">æ¶ˆè²»æ­·å² ({customerProfile.history.length})</h4>
                                            <div className="space-y-2 table-container max-h-[400px] overflow-y-auto">
                                                {customerProfile.history.map((h,i) => (<div key={i} className="flex justify-between items-center p-4 border border-slate-100 rounded-xl hover:bg-slate-50 transition"><div><div className="font-bold text-slate-700">{h.eventName}</div><div className="text-xs text-slate-400 mt-1">{h.date} â€¢ {h.instructor}</div>{h.orderDate && <div className="text-xs text-blue-500 mt-0.5">ğŸ“… ä¸‹å®šæ–¼: {h.orderDate}</div>}</div><div className="font-mono font-bold text-slate-600">${h.price}</div></div>))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center py-12 text-slate-400">è«‹æœå°‹æˆ–é¸æ“‡ä¸€ä½å®¢æˆ¶ä»¥æŸ¥çœ‹è©³ç´°åˆ†æ</div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'import' && (
                            <div className="fade-in max-w-6xl mx-auto space-y-8 pb-20">
                                <header className="flex flex-col md:flex-row justify-between items-center gap-4">
                                    <h2 className="text-2xl font-bold">è³‡æ–™åº«èˆ‡å ±åç®¡ç†</h2>
                                    <div className="flex gap-2 items-center w-full md:w-auto justify-end">
                                        <div className="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">ä¾†æº: {dbSource}</div>
                                        <select className="text-xs p-1 border rounded" onChange={e=>setDbSource(e.target.value)} value={dbSource}>
                                            <option value="crm-system-v1">v1 (æ‚¨çš„çœŸå¯¦è³‡æ–™)</option>
                                            <option value="default-app-id">Default (èˆŠç‰ˆæ¸¬è©¦)</option>
                                        </select>
                                        <button onClick={()=>setShowBulkImport(true)} className="bg-green-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-green-700 shadow-md whitespace-nowrap"><Icon name="file-spreadsheet" size={18}/> æ‰¹é‡åŒ¯å…¥</button>
                                    </div>
                                </header>

                                {/* æœå°‹èˆ‡åˆ—è¡¨ */}
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden table-container">
                                    <div className="p-4 border-b border-slate-100 flex gap-4 sticky left-0">
                                        <div className="relative flex-1">
                                            <Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={18}/>
                                            <input type="text" placeholder="æœå°‹å§“åã€æ´»å‹•æˆ–æ—¥æœŸ..." className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={importSearch} onChange={e=>setImportSearch(e.target.value)}/>
                                        </div>
                                    </div>
                                    <div className="max-h-[600px] overflow-y-auto">
                                        <table className="w-full text-left text-sm min-w-[800px]">
                                            <thead className="bg-slate-50 border-b border-slate-100 text-slate-500 sticky top-0"><tr><th className="p-4">æ—¥æœŸ</th><th className="p-4">æ´»å‹•</th><th className="p-4">å®¢æˆ¶</th><th className="p-4">é‡‘é¡</th><th className="p-4 text-right">æ“ä½œ</th></tr></thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {parsedData.filter(r => !importSearch || JSON.stringify(r).toLowerCase().includes(importSearch.toLowerCase())).map((row) => (
                                                    <tr key={row.id} className="hover:bg-slate-50">
                                                        <td className="p-4 text-slate-600">{row.date}</td>
                                                        <td className="p-4 font-medium text-slate-700">{row.eventName}</td>
                                                        <td className="p-4">{row.customerName}</td>
                                                        <td className="p-4 font-mono">${row.price}</td>
                                                        <td className="p-4 text-right flex justify-end gap-2">
                                                            <button onClick={()=>setEditingRow(row)} className="p-2 text-blue-600 hover:bg-blue-50 rounded"><Icon name="edit-2" size={16}/></button>
                                                            <button onClick={()=>handleDeleteRow(row.id)} className="p-2 text-red-400 hover:bg-red-50 rounded"><Icon name="trash-2" size={16}/></button>
                                                        </td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                {/* [ä¿®æ”¹] æ–°å¢å ±åè³‡æ–™ Form (åŠ å…¥ phone) */}
                                <section>
                                    <h2 className="text-2xl font-bold mb-6">æ–°å¢å ±åè³‡æ–™</h2>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ *</label><input type="date" className="w-full p-2 border rounded-lg" value={newReg.date} onChange={e=>setNewReg({...newReg, date: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">æ´»å‹•åç¨± *</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="ä¾‹å¦‚: ç™»å±±åœ˜" value={newReg.eventName} onChange={e=>setNewReg({...newReg, eventName: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">è¬›å¸«</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="è¬›å¸«å§“å" value={newReg.instructor} onChange={e=>setNewReg({...newReg, instructor: e.target.value})} /></div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">å®¢æˆ¶å§“å *</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="ç‹å°æ˜" value={newReg.customerName} onChange={e=>setNewReg({...newReg, customerName: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">é‡‘é¡</label><input type="number" className="w-full p-2 border rounded-lg" placeholder="3000" value={newReg.price} onChange={e=>setNewReg({...newReg, price: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">äº¤é€šæ–¹å¼</label>
                                                <select className="w-full p-2 border rounded-lg" value={newReg.transport} onChange={e=>setNewReg({...newReg, transport: e.target.value})}>
                                                    <option value="">æœªå®š</option>
                                                    <option value="å…±ä¹˜">å…±ä¹˜</option>
                                                    <option value="è‡ªè¡Œå‰å¾€">è‡ªè¡Œå‰å¾€</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">è¨‚è³¼æ—¥</label><input type="date" className="w-full p-2 border rounded-lg" value={newReg.orderDate} onChange={e=>setNewReg({...newReg, orderDate: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">å ±åç®¡é“</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="FB, IG..." value={newReg.source} onChange={e=>setNewReg({...newReg, source: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">æ‰‹æ©Ÿ</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="09xx..." value={newReg.phone} onChange={e=>setNewReg({...newReg, phone: e.target.value})} /></div>
                                        </div>
                                        <div className="flex justify-end pt-2">
                                            <button onClick={handleAddManualReg} disabled={isSaving} className={`bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors ${addRegStatus==='success'?'bg-green-600 hover:bg-green-700':'hover:bg-blue-700'}`}>
                                                {isSaving ? <Icon name="loader-2" className="animate-spin"/> : (addRegStatus==='success' ? <Icon name="check"/> : <Icon name="plus"/>)}
                                                {addRegStatus==='success' ? 'æ–°å¢æˆåŠŸï¼' : 'æ–°å¢ä¸€ç­†å ±å'}
                                            </button>
                                        </div>
                                    </div>
                                </section>

                                {/* åŸå§‹ CSV (æŠ˜ç–Š) */}
                                <details className="group">
                                    <summary className="flex items-center gap-2 cursor-pointer text-slate-500 font-bold hover:text-slate-700"><Icon name="code" size={16}/> é€²éšï¼šåŸå§‹ CSV è³‡æ–™åº« (å…¨é‡ç·¨è¼¯)</summary>
                                    <div className="mt-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                        <textarea className="w-full h-96 p-4 font-mono text-sm bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none" value={csvInput} onChange={e=>setCsvInput(e.target.value)} />
                                        <div className="mt-4 flex justify-between items-center">
                                            {/* ç®¡ç†å“¡å¯†ç¢¼è¨­å®šå€å¡Š */}
                                            <div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200">
                                                <Icon name="lock" size={16} className="text-slate-400"/>
                                                <span className="text-xs font-bold text-slate-600">ç®¡ç†å“¡å®‰å…¨è¨­å®š</span>
                                                <input 
                                                    type="password" 
                                                    placeholder="è¼¸å…¥æ–°å¯†ç¢¼..." 
                                                    className="px-2 py-1 border rounded text-xs w-32 outline-none focus:border-blue-400" 
                                                    value={newPasswordInput} 
                                                    onChange={e=>setNewPasswordInput(e.target.value)} 
                                                />
                                                <button 
                                                    onClick={handleUpdatePassword} 
                                                    className={`text-xs text-white px-3 py-1 rounded transition-colors ${passwordSaveStatus==='success' ? 'bg-green-500' : 'bg-slate-600 hover:bg-slate-700'}`}
                                                >
                                                    {passwordSaveStatus==='success' ? 'å·²æ›´æ–°' : (passwordSaveStatus==='saving' ? '...' : 'æ›´æ–°å¯†ç¢¼')}
                                                </button>
                                            </div>

                                            <button onClick={() => handleSaveCSV(csvInput)} disabled={isSaving} className="bg-slate-800 text-white px-6 py-2 rounded-xl flex items-center gap-2 hover:bg-slate-900">
                                                {isSaving ? <Icon name="loader-2" className="animate-spin"/> : <Icon name="save"/>} <span>å„²å­˜è®Šæ›´</span>
                                            </button>
                                        </div>
                                    </div>
                                </details>
                                
                                {/* Data Rescue */}
                                <DataRescueTab currentAppId={dbSource} onSwitch={setDbSource} />
                            </div>
                        )}

                    </main>

                    {/* Modals */}
                    {showDebug && <DebugPanel onClose={()=>setShowDebug(false)} />}
                    {showCreateEvent && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in"><div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl m-auto"><CreateEventModal onClose={()=>setShowCreateEvent(false)} onSave={handleCreateEvent} customTemplates={customTemplates} onSaveTemplate={handleSaveTemplate} onDeleteTemplate={onDeleteTemplate} availableInstructors={Object.keys(stats.instrs).sort()} instructorSchedule={instructorSchedule} /></div></div>}
                    {showAddPromise && <AddPromiseModal onClose={()=>setShowAddPromise(false)} onSave={handleAddPromise} />}
                    {showBulkImport && <BulkImportModal onClose={()=>setShowBulkImport(false)} onImport={handleBulkImport} existingData={parsedData} />}
                    {showScheduleModal && <InstructorScheduleModal date={scheduleDate} availableInstructors={Object.keys(stats.instrs).sort()} restingList={instructorSchedule[scheduleDate] || []} onClose={()=>setShowScheduleModal(false)} onToggle={handleToggleInstructorRest} />}
                    {activeTaskDetail && <TaskDetailModal task={activeTaskDetail} eventData={activeTaskDetail.fullEvent} onClose={()=>setActiveTaskDetail(null)} />}
                    {editingEvent && <EventManagerModal 
                        event={activeEditingEvent} 
                        config={eventConfigs[editingEvent.key]} 
                        onClose={()=>setEditingEvent(null)} 
                        onSaveConfig={(cfg, newInstr)=>handleSaveEventConfig(editingEvent.key, cfg, newInstr)} 
                        availableInstructors={Object.keys(stats.instrs).sort()} 
                        instructorSchedule={instructorSchedule} 
                        onCheckInToggle={handleCheckInToggle} 
                    />}
                    {editingRow && <EditRowModal rowData={editingRow} onClose={()=>setEditingRow(null)} onSave={handleUpdateRow} />}
                    {showLoginModal && <LoginModal onClose={()=>setShowLoginModal(false)} onLogin={handleVerifyLogin} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
