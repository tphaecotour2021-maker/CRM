import React, { useState, useMemo, useEffect } from 'react';
import { 
  Calendar as CalendarIcon, 
  Users, 
  TrendingUp, 
  Briefcase, 
  Settings, 
  Search, 
  PlusCircle,
  BarChart3,
  CheckCircle2,
  Clock,
  AlertCircle,
  FileText,
  Save,
  Loader2,
  Trash2,
  Edit,
  X,
  CheckSquare,
  ChevronRight,
  ChevronLeft,
  ChevronDown,
  LayoutList,
  PartyPopper,
  List,
  Filter,
  Copy,
  Mail,
  ShieldCheck,
  Zap,
  Plus,
  UserPlus,
  Activity,
  Wifi,
  Database,
  Lock
} from 'lucide-react';

// Firebase Imports
import { initializeApp } from 'firebase/app';
import { getAnalytics } from "firebase/analytics"; 
import { 
  getAuth, 
  signInAnonymously, 
  onAuthStateChanged
} from 'firebase/auth';
import { 
  getFirestore, 
  doc, 
  setDoc, 
  getDoc, 
  onSnapshot, 
  collection, 
  addDoc, 
  updateDoc,
  deleteDoc,
  query,
  orderBy
} from 'firebase/firestore';

// --- æ‚¨çš„ Firebase è¨­å®š ---
const firebaseConfig = {
  apiKey: "AIzaSyBtfR8N9Dw9kG3jQSfJSs0p0MLvlQaOR74",
  authDomain: "crm-sys-4184a.firebaseapp.com",
  projectId: "crm-sys-4184a",
  storageBucket: "crm-sys-4184a.firebasestorage.app",
  messagingSenderId: "943273685158",
  appId: "1:943273685158:web:8ca441dd78dcb5b956c467",
  measurementId: "G-2M2W340ZKB"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
// const analytics = getAnalytics(app); // æš«æ™‚è¨»è§£æ‰ Analytics é¿å…å¹²æ“¾ Debug
const auth = getAuth(app);
const db = getFirestore(app);

// å›ºå®š App ID
const appId = 'crm-system-v1';

// --- æ“´å……å¾Œçš„ç¯„ä¾‹è³‡æ–™ ---
const INITIAL_CSV_DATA = `æ—¥æœŸ,æ´»å‹•åç¨±,è¬›å¸«,å®¢æˆ¶å§“å,é‡‘é¡,äº¤é€šæ–¹å¼,èº«åˆ†è­‰å­—è™Ÿ,ç”Ÿæ—¥
2023-11-05,é«˜å±±æ”å½±åœ˜,å¼µå¤§å¸«,ç‹å°æ˜,5000,å…±ä¹˜,A123456789,1990-05-20
2023-11-05,é«˜å±±æ”å½±åœ˜,å¼µå¤§å¸«,æå°ç¾,5000,è‡ªè¡Œå‰å¾€,B223456789,1992-08-15
2023-11-05,é«˜å±±æ”å½±åœ˜,å¼µå¤§å¸«,é™³å¤§æ–‡,4500,å…±ä¹˜,C123456789,1988-12-01
2023-11-12,é‡å¤–æ±‚ç”Ÿç‡Ÿ,é™³æ•™ç·´,ç‹å°æ˜,3000,å…±ä¹˜,A123456789,1990-05-20
2023-11-12,é‡å¤–æ±‚ç”Ÿç‡Ÿ,é™³æ•™ç·´,è¶™é˜¿å¼·,3000,è‡ªè¡Œå‰å¾€,D123456789,1995-03-10
2023-11-12,é‡å¤–æ±‚ç”Ÿç‡Ÿ,é™³æ•™ç·´,å­«å°æ¯›,2800,å…±ä¹˜,E123456789,1998-11-11
2023-11-20,è§€æ˜Ÿéœ²ç‡Ÿ,æ—åšå£« & é™³æ•™ç·´,æå°ç¾,4500,è‡ªè¡Œå‰å¾€,B223456789,1992-08-15
2023-11-20,è§€æ˜Ÿéœ²ç‡Ÿ,æ—åšå£« & é™³æ•™ç·´,éŒ¢è€é—†,4500,è‡ªè¡Œå‰å¾€,F123456789,1980-01-01
2023-11-20,è§€æ˜Ÿéœ²ç‡Ÿ,æ—åšå£« & é™³æ•™ç·´,ç‹å°æ˜,4000,å…±ä¹˜,A123456789,1990-05-20
2023-12-01,å†¬å­£è³é›ªåœ˜,å¼µå¤§å¸«,ç‹å°æ˜,6000,å…±ä¹˜,A123456789,1990-05-20
2023-12-01,å†¬å­£è³é›ªåœ˜,å¼µå¤§å¸«,éŒ¢è€é—†,6000,è‡ªè¡Œå‰å¾€,F123456789,1980-01-01`;

const INITIAL_PROJECTS = [
  { name: '12æœˆè·¨å¹´æ´»å‹•ç±Œå‚™', owner: 'Alex', status: 'In Progress', deadline: '2023-12-15' },
  { name: 'å®˜ç¶²è¦–è¦ºå¤§æ”¹ç‰ˆ', owner: 'Sarah', status: 'Stuck', deadline: '2024-01-10' },
  { name: '2024 å¹´åº¦è¬›å¸«æ‹›å‹Ÿ', owner: 'Ken', status: 'Done', deadline: '2023-11-30' },
];

const DEFAULT_TASKS_TEMPLATE = [
  { id: 'insurance', type: 'insurance', name: 'è¾¦ç†ä¿éšª', fields: [{ label: 'ä¿å–®è™Ÿç¢¼', value: '' }], completed: false },
  { id: 'pre_letter', type: 'pre_letter', name: 'å¯„é€è¡Œå‰ä¿¡', fields: [{ label: 'å¯„é€æ—¥æœŸ', value: '' }], completed: false },
  { id: 'post_letter', type: 'post_letter', name: 'å¯„é€èŠ±çµ®ä¿¡', fields: [{ label: 'ç…§ç‰‡é€£çµ', value: '' }], completed: false },
];

const DEFAULT_EVENT_TEMPLATES = [
  { id: 'default_1', name: 'ç™»å±±åœ˜æ¨¡æ¿', eventName: 'é€±æœ«ç™»å±±åœ˜', instructor: 'å¼µå¤§å¸«', isSystem: true },
  { id: 'default_2', name: 'éœ²ç‡Ÿåœ˜æ¨¡æ¿', eventName: 'æ˜Ÿç©ºéœ²ç‡Ÿ', instructor: 'æ—åšå£«', isSystem: true },
  { id: 'default_3', name: 'èª²ç¨‹æ¨¡æ¿', eventName: 'æ”å½±æ•™å­¸', instructor: 'é™³æ•™ç·´', isSystem: true },
];

// --- Helper Functions ---
const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
const getDaysDiff = (targetDateStr) => {
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  const target = new Date(targetDateStr);
  const diffTime = target.getTime() - today.getTime();
  return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
};

const getTaskStatusStyle = (taskType, eventDateStr) => {
  const daysDiff = getDaysDiff(eventDateStr);
  if (taskType === 'insurance') {
    if (daysDiff <= 3 && daysDiff >= 0) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'æ€¥è¿« (å‰©3å¤©)' };
    if (daysDiff < 0) return { color: 'text-slate-400', bg: 'bg-slate-100', border: 'border-slate-200', label: 'æ´»å‹•å·²é' };
    return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: 'å¾…è¾¦' };
  }
  if (taskType === 'post_letter') {
    const daysSinceEvent = -daysDiff; 
    if (daysSinceEvent < 1) return { color: 'text-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', label: 'æ´»å‹•æœªçµæŸ' };
    if (daysSinceEvent === 1) return { color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200', label: 'å»ºè­°å¯„é€ (Day 1)' };
    if (daysSinceEvent === 2) return { color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200', label: 'å¿«å¯„å‡º (Day 2)' };
    if (daysSinceEvent >= 3) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'å»¶é² (Day 3+)' };
  }
  return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: '' };
};

const NavItem = ({ id, icon: Icon, label, activeTab, setActiveTab }) => (
  <button
    onClick={() => setActiveTab(id)}
    className={`flex items-center space-x-2 px-4 py-3 rounded-lg transition-colors w-full ${
      activeTab === id 
        ? 'bg-blue-600 text-white shadow-md' 
        : 'text-slate-600 hover:bg-slate-100'
    }`}
  >
    <Icon size={20} />
    <span className="font-medium">{label}</span>
  </button>
);

// --- Debug Panel Component (æ–°åŠŸèƒ½) ---
const DebugPanel = ({ onClose }) => {
  const [logs, setLogs] = useState([]);
  const [status, setStatus] = useState({
    auth: 'pending',
    firestore: 'pending',
    network: 'pending'
  });

  const addLog = (msg, type = 'info') => {
    setLogs(prev => [...prev, { msg, type, time: new Date().toLocaleTimeString() }]);
  };

  useEffect(() => {
    const runDiagnostics = async () => {
      addLog("é–‹å§‹è¨ºæ–·ç³»çµ±...", 'info');

      // 1. æª¢æŸ¥ Auth
      try {
        addLog("æ­£åœ¨å˜—è©¦åŒ¿åç™»å…¥...", 'info');
        const userCred = await signInAnonymously(auth);
        addLog(`ç™»å…¥æˆåŠŸï¼User ID: ${userCred.user.uid}`, 'success');
        setStatus(prev => ({ ...prev, auth: 'success' }));
      } catch (e) {
        addLog(`ç™»å…¥å¤±æ•—: ${e.message}`, 'error');
        setStatus(prev => ({ ...prev, auth: 'error' }));
        if (e.code === 'auth/admin-restricted-operation') {
          addLog("æç¤º: è«‹å» Firebase Console -> Authentication -> Sign-in method é–‹å•Ÿ 'Anonymous'ã€‚", 'warning');
        }
        return; // Auth å¤±æ•—å°±ä¸æ¸¬ DB äº†
      }

      // 2. æª¢æŸ¥ Firestore å¯«å…¥æ¬Šé™
      try {
        addLog("æ­£åœ¨æ¸¬è©¦è³‡æ–™åº«å¯«å…¥æ¬Šé™...", 'info');
        const testRef = doc(db, 'artifacts', appId, 'public', 'data', 'debug_test', 'ping');
        await setDoc(testRef, { timestamp: new Date().toISOString(), status: 'ok' });
        addLog("è³‡æ–™åº«å¯«å…¥æˆåŠŸï¼", 'success');
        setStatus(prev => ({ ...prev, firestore: 'success' }));
      } catch (e) {
        addLog(`è³‡æ–™åº«å¯«å…¥å¤±æ•—: ${e.message}`, 'error');
        setStatus(prev => ({ ...prev, firestore: 'error' }));
        if (e.message.includes('permission-denied')) {
          addLog("é‡è¦æç¤º: é€™æ˜¯ 'æ¬Šé™ä¸è¶³' éŒ¯èª¤ã€‚", 'warning');
          addLog("è«‹å» Firebase Console -> Firestore Database -> Rules", 'warning');
          addLog("å°‡è¦å‰‡æ”¹æˆ: allow read, write: if true;", 'warning');
        }
      }
    };

    runDiagnostics();
  }, []);

  return (
    <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
      <div className="bg-slate-900 text-green-400 rounded-xl shadow-2xl w-full max-w-2xl h-[600px] flex flex-col font-mono text-sm border border-slate-700">
        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800 rounded-t-xl">
          <div className="flex items-center space-x-2">
            <Activity className="animate-pulse" size={18} />
            <span className="font-bold text-white">ç³»çµ±è¨ºæ–·çµ‚ç«¯æ©Ÿ</span>
          </div>
          <button onClick={onClose} className="text-slate-400 hover:text-white"><X size={20}/></button>
        </div>
        
        <div className="p-4 grid grid-cols-3 gap-4 border-b border-slate-700 bg-slate-800/50">
          <div className={`flex flex-col items-center p-3 rounded ${status.auth === 'success' ? 'bg-green-900/30 text-green-400' : status.auth === 'error' ? 'bg-red-900/30 text-red-400' : 'bg-slate-800 text-slate-500'}`}>
            <UserPlus size={24} className="mb-2"/>
            <span className="font-bold">èº«åˆ†é©—è­‰</span>
            <span className="text-xs mt-1">{status.auth === 'success' ? 'PASS' : status.auth === 'error' ? 'FAIL' : 'Checking...'}</span>
          </div>
          <div className={`flex flex-col items-center p-3 rounded ${status.firestore === 'success' ? 'bg-green-900/30 text-green-400' : status.firestore === 'error' ? 'bg-red-900/30 text-red-400' : 'bg-slate-800 text-slate-500'}`}>
            <Database size={24} className="mb-2"/>
            <span className="font-bold">è³‡æ–™åº«æ¬Šé™</span>
            <span className="text-xs mt-1">{status.firestore === 'success' ? 'PASS' : status.firestore === 'error' ? 'FAIL' : 'Checking...'}</span>
          </div>
          <div className="flex flex-col items-center p-3 rounded bg-slate-800 text-slate-400">
            <Wifi size={24} className="mb-2"/>
            <span className="font-bold">ç¶²è·¯é€£ç·š</span>
            <span className="text-xs mt-1">Online</span>
          </div>
        </div>

        <div className="flex-1 overflow-y-auto p-4 space-y-2">
          {logs.map((log, idx) => (
            <div key={idx} className={`flex space-x-2 ${log.type === 'error' ? 'text-red-400' : log.type === 'warning' ? 'text-yellow-400' : log.type === 'success' ? 'text-green-400' : 'text-slate-300'}`}>
              <span className="text-slate-600">[{log.time}]</span>
              <span>{log.type === 'error' ? 'âŒ' : log.type === 'warning' ? 'âš ï¸' : log.type === 'success' ? 'âœ…' : 'â„¹ï¸'}</span>
              <span>{log.msg}</span>
            </div>
          ))}
        </div>
        
        <div className="p-4 bg-slate-800 rounded-b-xl text-xs text-slate-500 border-t border-slate-700">
          å¦‚æœçœ‹åˆ°ç´…è‰²éŒ¯èª¤ï¼Œè«‹ä¾ç…§æç¤ºå‰å¾€ Firebase Console ä¿®æ­£è¨­å®šã€‚ä¿®æ­£å¾Œè«‹é‡æ–°æ•´ç†ç¶²é ã€‚
        </div>
      </div>
    </div>
  );
};

const CreateEventModal = ({ onClose, onSave, customTemplates, onAddTemplate, onDeleteTemplate, availableInstructors }) => {
  const [mode, setMode] = useState('template'); 
  const [isCreatingTemplate, setIsCreatingTemplate] = useState(false);
  const [calendarMonth, setCalendarMonth] = useState(new Date());
  const [formData, setFormData] = useState({ dates: [], eventName: '', instructors: [] });
  const [tempInstructor, setTempInstructor] = useState('');
  const [newTemplateData, setNewTemplateData] = useState({ name: '', eventName: '', instructor: '' });

  const handleTemplateSelect = (tpl) => {
    let tplInstructors = [];
    if (tpl.instructor) {
      tplInstructors = tpl.instructor.split(/[&,]/).map(s => s.trim());
    }
    setFormData({ ...formData, eventName: tpl.eventName, instructors: tplInstructors });
  };

  const toggleDate = (year, month, day) => {
    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
    let newDates;
    if (formData.dates.includes(dateStr)) {
      newDates = formData.dates.filter(d => d !== dateStr);
    } else {
      newDates = [...formData.dates, dateStr].sort();
    }
    setFormData({ ...formData, dates: newDates });
  };

  const addInstructor = (name) => {
    const cleanName = name.trim();
    if (cleanName && !formData.instructors.includes(cleanName)) {
      setFormData({ ...formData, instructors: [...formData.instructors, cleanName] });
    }
    setTempInstructor('');
  };

  const removeInstructor = (name) => {
    setFormData({ ...formData, instructors: formData.instructors.filter(i => i !== name) });
  };

  const handleSubmitEvent = () => {
    if (formData.dates.length === 0) {
      alert("è«‹è‡³å°‘åœ¨æ—¥æ›†ä¸Šé¸æ“‡ä¸€å€‹æ—¥æœŸ");
      return;
    }
    onSave(formData);
  };

  const handleSaveNewTemplate = () => {
    if (!newTemplateData.name) {
      alert("è«‹è¼¸å…¥æ¨¡æ¿åç¨±");
      return;
    }
    onAddTemplate(newTemplateData);
    setIsCreatingTemplate(false);
    setNewTemplateData({ name: '', eventName: '', instructor: '' });
  };

  const renderCalendar = () => {
    const year = calendarMonth.getFullYear();
    const month = calendarMonth.getMonth();
    const daysInMonth = getDaysInMonth(year, month);
    const firstDay = getFirstDayOfMonth(year, month);
    const days = [];
    for (let i = 0; i < firstDay; i++) days.push(null);
    for (let i = 1; i <= daysInMonth; i++) days.push(i);

    return (
      <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
        <div className="flex justify-between items-center mb-4">
          <button onClick={() => setCalendarMonth(new Date(year, month - 1))} className="p-1 hover:bg-slate-200 rounded"><ChevronLeft size={20}/></button>
          <span className="font-bold text-slate-700">{year}å¹´ {month + 1}æœˆ</span>
          <button onClick={() => setCalendarMonth(new Date(year, month + 1))} className="p-1 hover:bg-slate-200 rounded"><ChevronRight size={20}/></button>
        </div>
        <div className="grid grid-cols-7 text-center mb-2">
           {['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'].map(d => <div key={d} className="text-xs text-slate-500 font-bold">{d}</div>)}
        </div>
        <div className="grid grid-cols-7 gap-1">
          {days.map((day, idx) => {
             if (!day) return <div key={idx} />;
             const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
             const isSelected = formData.dates.includes(dateStr);
             return (
               <button 
                 key={idx}
                 onClick={() => toggleDate(year, month, day)}
                 className={`w-8 h-8 rounded-full text-sm flex items-center justify-center transition-all ${
                   isSelected ? 'bg-blue-600 text-white shadow-md scale-110' : 'hover:bg-blue-100 text-slate-700'
                 }`}
               >
                 {day}
               </button>
             );
          })}
        </div>
        <div className="mt-3 text-xs text-slate-500 text-center">
          å·²é¸æ“‡ <span className="font-bold text-blue-600">{formData.dates.length}</span> å€‹æ—¥æœŸ
        </div>
      </div>
    );
  };

  return (
    <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 animate-in fade-in duration-200">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <div className="p-6 border-b border-slate-100 flex justify-between items-center bg-slate-50">
          <h3 className="text-xl font-bold text-slate-800 flex items-center">
            <Zap size={20} className="mr-2 text-yellow-500" />
            å¿«é€Ÿé–‹åœ˜
          </h3>
          <button onClick={onClose}><X size={24} className="text-slate-400 hover:text-slate-600"/></button>
        </div>
        <div className="p-6 space-y-6 overflow-y-auto">
          {!isCreatingTemplate && (
            <div className="flex space-x-2 p-1 bg-slate-100 rounded-lg">
              <button onClick={() => setMode('template')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${mode === 'template' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>ä½¿ç”¨æ¨¡æ¿</button>
              <button onClick={() => setMode('custom')} className={`flex-1 py-2 text-sm font-medium rounded-md transition-all ${mode === 'custom' ? 'bg-white shadow text-blue-600' : 'text-slate-500'}`}>å®Œå…¨è‡ªè¨‚</button>
            </div>
          )}
          {!isCreatingTemplate && mode === 'template' && (
            <div className="grid grid-cols-3 gap-3">
              {DEFAULT_EVENT_TEMPLATES.map((tpl) => (
                <div key={tpl.id} onClick={() => handleTemplateSelect(tpl)} className={`border rounded-lg p-3 cursor-pointer transition-all text-center hover:bg-blue-50 relative group ${formData.eventName === tpl.eventName ? 'border-blue-500 ring-1 ring-blue-500 bg-blue-50' : 'border-slate-200'}`}>
                  <div className="font-bold text-slate-700 text-sm mb-1">{tpl.name}</div>
                  <div className="text-xs text-slate-500">{tpl.instructor}</div>
                </div>
              ))}
              {customTemplates.map((tpl) => (
                <div key={tpl.id} onClick={() => handleTemplateSelect(tpl)} className={`border rounded-lg p-3 cursor-pointer transition-all text-center hover:bg-blue-50 relative group ${formData.eventName === tpl.eventName ? 'border-blue-500 ring-1 ring-blue-500 bg-blue-50' : 'border-slate-200'}`}>
                  <button onClick={(e) => { e.stopPropagation(); onDeleteTemplate(tpl.id); }} className="absolute top-1 right-1 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity p-1"><X size={12} /></button>
                  <div className="font-bold text-blue-700 text-sm mb-1">{tpl.name}</div>
                  <div className="text-xs text-slate-500">{tpl.instructor}</div>
                </div>
              ))}
              <button onClick={() => setIsCreatingTemplate(true)} className="border border-dashed border-slate-300 rounded-lg p-3 flex flex-col items-center justify-center text-slate-400 hover:text-blue-600 hover:border-blue-300 hover:bg-blue-50 transition-all"><PlusCircle size={24} className="mb-1" /><span className="text-xs font-medium">æ–°å¢æ¨¡æ¿</span></button>
            </div>
          )}
          {isCreatingTemplate && (
            <div className="bg-slate-50 p-4 rounded-lg border border-slate-200 animate-in fade-in zoom-in-95">
              <div className="flex justify-between items-center mb-4"><h4 className="font-bold text-slate-700">å»ºç«‹æ–°æ¨¡æ¿</h4><button onClick={() => setIsCreatingTemplate(false)} className="text-slate-400 hover:text-slate-600 text-sm">å–æ¶ˆ</button></div>
              <div className="space-y-3">
                <div><label className="block text-xs font-medium text-slate-500 mb-1">æ¨¡æ¿åç¨±</label><input type="text" className="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-blue-500 outline-none" value={newTemplateData.name} onChange={e => setNewTemplateData({...newTemplateData, name: e.target.value})} /></div>
                <div className="grid grid-cols-2 gap-3">
                   <div><label className="block text-xs font-medium text-slate-500 mb-1">é è¨­æ´»å‹•åç¨±</label><input type="text" className="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-blue-500 outline-none" value={newTemplateData.eventName} onChange={e => setNewTemplateData({...newTemplateData, eventName: e.target.value})} /></div>
                   <div><label className="block text-xs font-medium text-slate-500 mb-1">é è¨­è¬›å¸«</label><input type="text" className="w-full px-3 py-2 text-sm border border-slate-300 rounded focus:ring-1 focus:ring-blue-500 outline-none" value={newTemplateData.instructor} onChange={e => setNewTemplateData({...newTemplateData, instructor: e.target.value})} /></div>
                </div>
                <button onClick={handleSaveNewTemplate} className="w-full py-2 bg-blue-600 text-white rounded text-sm font-medium hover:bg-blue-700 mt-2">å„²å­˜æ¨¡æ¿</button>
              </div>
            </div>
          )}
          {!isCreatingTemplate && (
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 border-t border-slate-100 pt-6">
               <div><label className="block text-sm font-medium text-slate-700 mb-2">1. é»é¸æ—¥æœŸ (å¯å¤šé¸)</label>{renderCalendar()}</div>
               <div className="space-y-4">
                 <div><label className="block text-sm font-medium text-slate-700 mb-1">2. æ´»å‹•åç¨±</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={formData.eventName} onChange={e => setFormData({...formData, eventName: e.target.value})} placeholder="è¼¸å…¥åç¨±..." /></div>
                 <div>
                   <label className="block text-sm font-medium text-slate-700 mb-1">3. å¸¶åœ˜è¬›å¸« (å¯å¤šäºº)</label>
                   <div className="flex flex-wrap gap-2 mb-2 min-h-[38px] p-2 bg-white border border-slate-200 rounded-lg">
                      {formData.instructors.length === 0 && <span className="text-xs text-slate-400 self-center">è«‹è¼¸å…¥æˆ–é»é¸ä¸‹æ–¹è¬›å¸«</span>}
                      {formData.instructors.map((ins, idx) => (<div key={idx} className="flex items-center bg-blue-50 text-blue-700 px-2 py-1 rounded-md text-sm border border-blue-100"><span className="mr-1">{ins}</span><button onClick={() => removeInstructor(ins)} className="text-blue-400 hover:text-red-500"><X size={14}/></button></div>))}
                   </div>
                   <div className="flex gap-2 mb-3"><input type="text" className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none" value={tempInstructor} onChange={(e) => setTempInstructor(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && addInstructor(tempInstructor)} placeholder="è¼¸å…¥åå­—æŒ‰ Enter..." /><button onClick={() => addInstructor(tempInstructor)} className="px-3 py-2 bg-slate-100 rounded-lg hover:bg-slate-200 text-slate-600"><Plus size={18}/></button></div>
                   <div className="space-y-2">
                     <div className="text-xs text-slate-400">å¸¸ç”¨è¬›å¸«åå–®:</div>
                     <div className="flex flex-wrap gap-2">{availableInstructors.filter(i => !formData.instructors.includes(i)).slice(0, 8).map(ins => (<button key={ins} onClick={() => addInstructor(ins)} className="text-xs px-2 py-1 bg-slate-50 border border-slate-200 rounded-full text-slate-600 hover:bg-blue-50 hover:text-blue-600 hover:border-blue-200 transition">+ {ins}</button>))}</div>
                   </div>
                 </div>
               </div>
            </div>
          )}
        </div>
        {!isCreatingTemplate && (
          <div className="p-4 bg-slate-50 border-t border-slate-200 flex justify-end items-center">
             <div className="mr-auto text-xs text-slate-500">å°‡å»ºç«‹ <span className="font-bold text-blue-600">{formData.dates.length}</span> å ´æ´»å‹•</div>
             <button onClick={handleSubmitEvent} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium">æ‰¹é‡å»ºç«‹</button>
          </div>
        )}
      </div>
    </div>
  );
};

const TaskDetailModal = ({ task, eventData, onClose }) => {
  const [copied, setCopied] = useState(false);
  const renderContent = () => {
    if (task.type === 'insurance') {
      const copyText = eventData.customers.map(c => `${c.name}\t${c.id}\t${c.birthday}`).join('\n');
      const handleCopy = () => { navigator.clipboard.writeText(copyText); setCopied(true); setTimeout(() => setCopied(false), 2000); };
      return (
        <div className="space-y-4">
          <div className="bg-amber-50 border border-amber-200 p-3 rounded-lg flex items-start"><ShieldCheck className="text-amber-600 mt-0.5 mr-2" size={18}/><div className="text-sm text-amber-800"><p className="font-bold">ä¿éšªè¾¦ç†è³‡è¨Š</p><p>è«‹å°‡ä¸‹åˆ—åå–®è¤‡è£½ä¸¦æä¾›çµ¦ä¿éšªæ¥­å‹™ã€‚åŒ…å«å§“åã€èº«åˆ†è­‰å­—è™Ÿèˆ‡ç”Ÿæ—¥ã€‚</p></div></div>
          <div className="relative"><div className="absolute top-2 right-2"><button onClick={handleCopy} className="flex items-center px-3 py-1 bg-white border border-slate-300 rounded text-xs font-medium hover:bg-slate-50 text-slate-700 shadow-sm">{copied ? <CheckCircle2 size={14} className="mr-1 text-green-600"/> : <Copy size={14} className="mr-1"/>}{copied ? 'å·²è¤‡è£½' : 'è¤‡è£½å…¨éƒ¨'}</button></div><div className="bg-slate-100 p-4 rounded-lg font-mono text-sm max-h-60 overflow-y-auto whitespace-pre"><div className="flex border-b border-slate-300 pb-2 mb-2 font-bold text-slate-500"><span className="w-24">å§“å</span><span className="w-32">èº«åˆ†è­‰</span><span>ç”Ÿæ—¥</span></div>{eventData.customers.map((c, idx) => (<div key={idx} className="flex py-1 text-slate-800"><span className="w-24 truncate">{c.name}</span><span className="w-32">{c.id}</span><span>{c.birthday}</span></div>))}</div></div>
        </div>
      );
    }
    if (task.type === 'pre_letter') {
      const carpoolUsers = eventData.customers.filter(c => c.transport === 'å…±ä¹˜');
      const selfUsers = eventData.customers.filter(c => c.transport !== 'å…±ä¹˜');
      const getFakeEmail = (name) => `user_${name}@example.com`;
      return (
        <div className="space-y-6">
           <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg flex items-start"><Mail className="text-blue-600 mt-0.5 mr-2" size={18}/><div className="text-sm text-blue-800"><p className="font-bold">è¡Œå‰ä¿¡å¯„é€</p><p>ç³»çµ±å·²è‡ªå‹•å°‡å®¢æˆ¶ä¾æ“šäº¤é€šæ–¹å¼åˆ†çµ„ï¼Œè«‹åˆ†åˆ¥å¯„é€ä¸åŒç‰ˆæœ¬çš„è¡Œå‰é€šçŸ¥ã€‚</p></div></div>
          <div className="grid grid-cols-2 gap-4">
             <div className="border border-slate-200 rounded-lg p-3"><h4 className="font-bold text-slate-700 mb-2 flex items-center">ğŸš— å…±ä¹˜çµ„ ({carpoolUsers.length})</h4><div className="bg-slate-50 p-2 rounded text-xs text-slate-500 h-32 overflow-y-auto">{carpoolUsers.map(c => getFakeEmail(c.name)).join('; ')}</div><button className="mt-2 text-xs text-blue-600 hover:underline">è¤‡è£½æ‰€æœ‰ Email</button></div>
             <div className="border border-slate-200 rounded-lg p-3"><h4 className="font-bold text-slate-700 mb-2 flex items-center">ğŸš¶ è‡ªè¡Œå‰å¾€çµ„ ({selfUsers.length})</h4><div className="bg-slate-50 p-2 rounded text-xs text-slate-500 h-32 overflow-y-auto">{selfUsers.map(c => getFakeEmail(c.name)).join('; ')}</div><button className="mt-2 text-xs text-blue-600 hover:underline">è¤‡è£½æ‰€æœ‰ Email</button></div>
          </div>
        </div>
      );
    }
    return <div className="text-slate-500 text-center py-8">æ­¤ä»»å‹™æš«ç„¡ç‰¹æ®ŠåŸ·è¡Œå·¥å…·ï¼Œè«‹ä¾ç…§ä¸€èˆ¬æµç¨‹è™•ç†ã€‚</div>;
  };
  return (
    <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 animate-in zoom-in-95 duration-200">
      <div className="bg-white rounded-xl shadow-2xl w-full max-w-2xl overflow-hidden flex flex-col max-h-[90vh]">
        <div className="p-6 border-b border-slate-100 flex justify-between items-center"><div><div className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded inline-block mb-1">{eventData.date} â€¢ {eventData.eventName}</div><h3 className="text-xl font-bold text-slate-800">{task.name}</h3></div><button onClick={onClose}><X size={24} className="text-slate-400 hover:text-slate-600"/></button></div>
        <div className="p-6 overflow-y-auto">{renderContent()}</div>
      </div>
    </div>
  );
};

export default function OperationSystem() {
  const [user, setUser] = useState(null);
  const [activeTab, setActiveTab] = useState('tasks'); 
  const [csvInput, setCsvInput] = useState(''); 
  const [remoteCsvData, setRemoteCsvData] = useState(''); 
  const [projects, setProjects] = useState([]);
  const [eventConfigs, setEventConfigs] = useState({});
  const [customTemplates, setCustomTemplates] = useState([]); 
  const [loading, setLoading] = useState(true);
  const [isSaving, setIsSaving] = useState(false);
  const [editingEvent, setEditingEvent] = useState(null);
  const [activeTaskDetail, setActiveTaskDetail] = useState(null); 
  const [showCreateEvent, setShowCreateEvent] = useState(false);
  const [showDebug, setShowDebug] = useState(false); // Debug Panel
  const [eventsViewMode, setEventsViewMode] = useState('list'); 
  const [currentDate, setCurrentDate] = useState(new Date()); 
  const [parsedData, setParsedData] = useState([]);
  const [selectedCustomer, setSelectedCustomer] = useState('');

  useEffect(() => {
    const initAuth = async () => {
      try {
        await signInAnonymously(auth);
      } catch (error) {
        console.error("Auth Error:", error);
      }
    };
    initAuth();
    const unsubscribe = onAuthStateChanged(auth, (u) => setUser(u));
    return () => unsubscribe();
  }, []);

  useEffect(() => {
    if (!user) return;
    setLoading(true);
    const settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main');
    const templatesDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'templates'); 
    const projectsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'projects');
    const eventConfigsColRef = collection(db, 'artifacts', appId, 'public', 'data', 'event_configs');

    const unsubSettings = onSnapshot(settingsDocRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        const loadedData = data.csvData || '';
        setRemoteCsvData(loadedData);
        if (!csvInput) setCsvInput(loadedData);
      } else {
        setDoc(settingsDocRef, { csvData: INITIAL_CSV_DATA });
      }
    }, (error) => console.error("Firestore Error (Settings):", error));

    const unsubTemplates = onSnapshot(templatesDocRef, (docSnap) => {
      if (docSnap.exists()) {
        const data = docSnap.data();
        setCustomTemplates(data.list || []);
      } else {
        setDoc(templatesDocRef, { list: [] });
      }
    }, (error) => console.error("Firestore Error (Templates):", error));

    const unsubProjects = onSnapshot(projectsColRef, (snapshot) => {
      const projList = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
      if (projList.length === 0 && !snapshot.metadata.fromCache) {
        INITIAL_PROJECTS.forEach(p => addDoc(projectsColRef, p));
      } else {
        setProjects(projList);
      }
    }, (error) => console.error("Firestore Error (Projects):", error));

    const unsubEventConfigs = onSnapshot(eventConfigsColRef, (snapshot) => {
      const configs = {};
      snapshot.docs.forEach(doc => {
        configs[doc.id] = doc.data();
      });
      setEventConfigs(configs);
      setLoading(false);
    }, (error) => console.error("Firestore Error (EventConfigs):", error));

    return () => {
      unsubSettings();
      unsubTemplates();
      unsubProjects();
      unsubEventConfigs();
    };
  }, [user]);

  useEffect(() => {
    if (remoteCsvData) {
      try {
        const lines = remoteCsvData.trim().split('\n');
        const data = lines.slice(1).map((line, index) => {
          const values = line.split(',');
          if (values.length < 5) return null;
          return {
            id: index,
            date: values[0]?.trim() || '',
            eventName: values[1]?.trim() || 'æœªå‘½åæ´»å‹•',
            instructor: values[2]?.trim() || 'æœªå®š',
            customerName: values[3]?.trim() || 'é–‹æ”¾å ±åä¸­',
            price: parseInt(values[4]?.trim()) || 0,
            transport: values[5]?.trim() || 'æœªå®š',
            idNo: values[6]?.trim() || '',
            birthday: values[7]?.trim() || ''
          };
        }).filter(item => item !== null);
        setParsedData(data);
      } catch (e) {
        console.error("è§£æéŒ¯èª¤", e);
      }
    }
  }, [remoteCsvData]);

  const handleSaveCSV = async (newData) => {
    if (!user) return;
    setIsSaving(true);
    try {
      const settingsDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'main');
      await setDoc(settingsDocRef, { csvData: newData }, { merge: true });
    } catch (e) {
      console.error("å„²å­˜å¤±æ•—", e);
    } finally {
      setIsSaving(false);
    }
  };

  const handleCreateEvent = async (eventData) => {
    let newRows = '';
    const instructorStr = eventData.instructors.join(' & '); 
    eventData.dates.forEach(date => {
       newRows += `\n${date},${eventData.eventName},${instructorStr},é–‹æ”¾å ±åä¸­,0,,,`;
    });
    const updatedCSV = csvInput + newRows;
    setCsvInput(updatedCSV); 
    await handleSaveCSV(updatedCSV); 
    setShowCreateEvent(false);
  };

  const handleAddTemplate = async (newTemplate) => {
    if (!user) return;
    const templateWithId = { ...newTemplate, id: `custom_${Date.now()}` };
    const newList = [...customTemplates, templateWithId];
    const templatesDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'templates');
    await setDoc(templatesDocRef, { list: newList }, { merge: true });
  };

  const handleDeleteTemplate = async (templateId) => {
    if (!user) return;
    if (!confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¨¡æ¿å—ï¼Ÿ")) return;
    const newList = customTemplates.filter(t => t.id !== templateId);
    const templatesDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'templates');
    await setDoc(templatesDocRef, { list: newList }, { merge: true });
  };

  const handleToggleTaskInCenter = async (configKey, taskIndex) => {
    if (!user) return;
    const currentConfig = eventConfigs[configKey] || {};
    const tasks = currentConfig.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE));
    const newTasks = [...tasks];
    newTasks[taskIndex].completed = !newTasks[taskIndex].completed;
    const configDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'event_configs', configKey);
    await setDoc(configDocRef, { ...currentConfig, tasks: newTasks }, { merge: true });
  };

  const stats = useMemo(() => {
    const totalRevenue = parsedData.reduce((acc, curr) => acc + curr.price, 0);
    const uniqueEvents = new Set(parsedData.map(d => d.date + d.eventName)).size;
    const totalPax = parsedData.length;
    const instructorCounts = {};
    parsedData.forEach(curr => {
        if(curr.instructor){
            const instructors = curr.instructor.split(/[&,]/).map(s => s.trim());
            instructors.forEach(ins => {
                instructorCounts[ins] = (instructorCounts[ins] || 0) + 1;
            });
        }
    });
    const eventsGrouped = parsedData.reduce((acc, curr) => {
      const rawKey = `${curr.date}_${curr.eventName}_${curr.instructor}`;
      const configKey = rawKey.replace(/[\/\\#\?]/g, '-'); 
      if (!acc[configKey]) {
        acc[configKey] = { ...curr, count: 0, customers: [], configKey };
      }
      if (curr.customerName !== 'é–‹æ”¾å ±åä¸­') {
        acc[configKey].count += 1;
        acc[configKey].customers.push({
          name: curr.customerName,
          transport: curr.transport,
          id: curr.idNo,
          birthday: curr.birthday
        });
      }
      return acc;
    }, {});
    return { totalRevenue, uniqueEvents, totalPax, instructorCounts, eventsGrouped };
  }, [parsedData]);

  const availableInstructors = useMemo(() => Object.keys(stats.instructorCounts).sort(), [stats.instructorCounts]);

  const pendingTasksData = useMemo(() => {
    const list = [];
    Object.values(stats.eventsGrouped).forEach(evt => {
      const config = eventConfigs[evt.configKey] || {};
      const tasks = config.tasks || DEFAULT_TASKS_TEMPLATE; 
      tasks.forEach((task, idx) => {
        if (!task.completed) {
          const style = getTaskStatusStyle(task.type, evt.date);
          list.push({
            ...task,
            taskIndex: idx,
            eventDate: evt.date,
            eventName: evt.eventName,
            configKey: evt.configKey,
            style: style,
            fullEventData: evt 
          });
        }
      });
    });
    return list.sort((a, b) => new Date(a.eventDate) - new Date(b.eventDate));
  }, [stats.eventsGrouped, eventConfigs]);

  const uniqueCustomers = useMemo(() => [...new Set(parsedData.map(d => d.customerName))].filter(n => n !== 'é–‹æ”¾å ±åä¸­'), [parsedData]);
  const customerHistory = useMemo(() => {
    if (!selectedCustomer) return [];
    return parsedData.filter(d => d.customerName === selectedCustomer);
  }, [parsedData, selectedCustomer]);

  if (loading && !parsedData.length) {
    return (
      <div className="min-h-screen flex items-center justify-center bg-slate-50 flex-col space-y-4">
        <Loader2 className="animate-spin text-blue-600" size={48} />
        <p className="text-slate-500 font-medium">ç³»çµ±åŒæ­¥ä¸­...</p>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-slate-50 font-sans text-slate-800 flex">
      <aside className="w-64 bg-white border-r border-slate-200 p-4 flex flex-col hidden md:flex">
        <div className="mb-8 px-4 flex items-center space-x-2">
          <div className="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white font-bold text-xl">S</div>
          <h1 className="text-xl font-bold text-slate-800">SuperOps <span className="text-xs font-normal text-green-600 bg-green-100 px-1 rounded ml-1">Cloud</span></h1>
        </div>
        <nav className="space-y-2 flex-1">
          <NavItem id="dashboard" icon={TrendingUp} label="ç‡Ÿé‹å„€è¡¨æ¿" activeTab={activeTab} setActiveTab={setActiveTab} />
          <NavItem id="events" icon={CalendarIcon} label="æ´»å‹•å ´æ¬¡è¡¨" activeTab={activeTab} setActiveTab={setActiveTab} />
          <NavItem id="tasks" icon={CheckSquare} label="ä»»å‹™æŒ‡æ®ä¸­å¿ƒ" activeTab={activeTab} setActiveTab={setActiveTab} />
          <NavItem id="crm" icon={Users} label="å®¢æˆ¶ CRM" activeTab={activeTab} setActiveTab={setActiveTab} />
          <NavItem id="projects" icon={Briefcase} label="å°ˆæ¡ˆé€²åº¦" activeTab={activeTab} setActiveTab={setActiveTab} />
        </nav>
        <div className="pt-4 border-t border-slate-200">
          <button onClick={() => setShowDebug(true)} className="w-full flex items-center space-x-2 px-4 py-3 rounded-lg text-slate-500 hover:bg-slate-100 transition-colors text-sm mb-2">
             <Activity size={16} /> <span>ç³»çµ±é€£ç·šè¨ºæ–·</span>
          </button>
          <NavItem id="import" icon={FileText} label="åŒ¯å…¥/æ›´æ–°è³‡æ–™" activeTab={activeTab} setActiveTab={setActiveTab} />
        </div>
      </aside>

      <main className="flex-1 p-4 md:p-8 overflow-y-auto mt-12 md:mt-0 relative">
        <div className="md:hidden fixed top-0 left-0 w-full bg-white z-10 border-b p-4 flex justify-between"><h1 className="font-bold flex items-center">SuperOps</h1></div>
        
        {activeTab === 'dashboard' && (
          <div className="space-y-6">
            <header className="mb-6"><h2 className="text-2xl font-bold text-slate-800">ç‡Ÿé‹ç¸½è¦½</h2></header>
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><p className="text-sm font-medium text-slate-500">ç¸½ç‡Ÿæ”¶é ä¼°</p><h3 className="text-3xl font-bold text-slate-800 mt-2">${stats.totalRevenue.toLocaleString()}</h3></div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><p className="text-sm font-medium text-slate-500">ç¸½å ±åäººæ•¸</p><h3 className="text-3xl font-bold text-slate-800 mt-2">{stats.totalPax} äººæ¬¡</h3></div>
              <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-100"><p className="text-sm font-medium text-slate-500">æœ¬æœˆé–‹åœ˜æ•¸</p><h3 className="text-3xl font-bold text-slate-800 mt-2">{stats.uniqueEvents} å ´</h3></div>
            </div>
          </div>
        )}

        {activeTab === 'events' && (
          <div className="space-y-6">
            <header className="flex flex-col md:flex-row md:items-center justify-between gap-4">
               <div><h2 className="text-2xl font-bold text-slate-800">æ´»å‹•å ´æ¬¡åˆ—è¡¨</h2><p className="text-slate-500">æª¢è¦–æ‰€æœ‰é–‹åœ˜è³‡è¨Šèˆ‡å ±åè©³æƒ…</p></div>
               <div className="flex space-x-2">
                 <button onClick={() => setShowCreateEvent(true)} className="px-4 py-2 bg-blue-600 text-white rounded-md text-sm font-medium shadow-sm hover:bg-blue-700 flex items-center transition"><PlusCircle size={16} className="mr-2" />å¿«é€Ÿé–‹åœ˜</button>
                 <div className="flex bg-slate-100 p-1 rounded-lg">
                   <button onClick={() => setEventsViewMode('list')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center ${eventsViewMode === 'list' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><List size={16} className="mr-2" />åˆ—è¡¨</button>
                   <button onClick={() => setEventsViewMode('calendar')} className={`px-4 py-2 rounded-md text-sm font-medium transition-all flex items-center ${eventsViewMode === 'calendar' ? 'bg-white text-slate-800 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}><CalendarIcon size={16} className="mr-2" />æœˆæ›†</button>
                 </div>
               </div>
            </header>
            {eventsViewMode === 'list' && (
              <div className="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                <table className="w-full text-left">
                  <thead className="bg-slate-50 border-b border-slate-200"><tr><th className="px-6 py-4 text-sm font-semibold text-slate-600">æ—¥æœŸ</th><th className="px-6 py-4 text-sm font-semibold text-slate-600">æ´»å‹•åç¨±</th><th className="px-6 py-4 text-sm font-semibold text-slate-600">å ±åç‹€æ³</th><th className="px-6 py-4 text-sm font-semibold text-slate-600">æ“ä½œ</th></tr></thead>
                  <tbody className="divide-y divide-slate-100">
                    {Object.values(stats.eventsGrouped).map((evt, idx) => (
                      <tr key={idx} className="hover:bg-slate-50 transition-colors group">
                        <td className="px-6 py-4 text-sm text-slate-600">{evt.date}</td>
                        <td className="px-6 py-4"><span className="font-medium text-slate-800">{evt.eventName}</span><div className="text-xs text-slate-400">{evt.instructor}</div></td>
                        <td className="px-6 py-4"><span className="font-bold text-slate-800">{evt.count}</span><span className="text-xs text-slate-400"> äºº</span></td>
                        <td className="px-6 py-4"><button className="text-blue-600 font-medium text-sm flex items-center hover:bg-blue-50 px-3 py-1.5 rounded"><Settings size={14} className="mr-1"/> ç®¡ç†</button></td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>
            )}
            {eventsViewMode === 'calendar' && (<div className="bg-white p-8 text-center text-slate-500 border border-slate-200 rounded-xl">(æœˆæ›†è¦–åœ–ä»£ç¢¼ä¿æŒä¸è®Šï¼Œå¯åˆ‡æ›è‡³åˆ—è¡¨æŸ¥çœ‹æ–°æ´»å‹•)</div>)}
          </div>
        )}

        {activeTab === 'tasks' && (
          <div className="h-full flex flex-col">
            <header className="mb-6 flex justify-between items-center"><div><h2 className="text-2xl font-bold text-slate-800">ä»»å‹™æŒ‡æ®ä¸­å¿ƒ</h2><p className="text-slate-500">æ™ºæ…§è¿½è¹¤ç³»çµ±ï¼Œæ ¹æ“šæ´»å‹•æ—¥æœŸè‡ªå‹•è¨ˆç®—ç·Šæ€¥ç¨‹åº¦</p></div><div className="text-sm font-medium bg-white px-3 py-1 rounded-full border border-slate-200 text-slate-500">å¾…è™•ç†: <span className="text-blue-600 font-bold">{pendingTasksData.length}</span></div></header>
            {pendingTasksData.length === 0 ? (
              <div className="flex-1 flex flex-col items-center justify-center text-center animate-in zoom-in duration-500"><div className="w-24 h-24 bg-yellow-100 text-yellow-500 rounded-full flex items-center justify-center mb-6 shadow-lg animate-bounce"><PartyPopper size={48} /></div><h3 className="text-3xl font-bold text-slate-800 mb-2">ä»»å‹™æ¸…ç©ºï¼å¤§å‰å¤§åˆ©ï¼</h3></div>
            ) : (
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 auto-rows-min">
                 {pendingTasksData.map((task, idx) => (
                   <div key={`${task.configKey}-${task.taskIndex}`} onClick={() => setActiveTaskDetail(task)} className={`bg-white p-4 rounded-xl border shadow-sm hover:shadow-md transition-all cursor-pointer relative group ${task.style.bg} ${task.style.border}`}>
                     {task.style.label && (<div className={`absolute top-2 right-2 text-[10px] font-bold px-2 py-0.5 rounded-full bg-white/80 backdrop-blur border ${task.style.color} border-current`}>{task.style.label}</div>)}
                     <div className="flex justify-between items-start mb-3"><div className="bg-white/60 text-slate-600 text-xs px-2 py-1 rounded font-mono border border-slate-200/50">{task.eventDate}</div></div>
                     <div className="mb-1 text-xs text-slate-500 font-medium">{task.eventName}</div><h4 className={`font-bold text-lg mb-4 ${task.style.color}`}>{task.name}</h4>
                     <div className="flex space-x-2">
                       <button onClick={(e) => { e.stopPropagation(); handleToggleTaskInCenter(task.configKey, task.taskIndex); }} className="flex-1 py-2 rounded-lg bg-white border border-slate-200 text-slate-400 font-bold hover:bg-green-500 hover:text-white hover:border-green-500 transition-all flex items-center justify-center shadow-sm"><CheckCircle2 size={18} className="mr-2" />å®Œæˆ</button>
                       <button className="px-3 py-2 bg-white border border-slate-200 rounded-lg text-slate-400 hover:text-blue-600 hover:border-blue-300 transition-all"><ChevronRight size={18} /></button>
                     </div>
                   </div>
                 ))}
              </div>
            )}
          </div>
        )}

        {activeTab === 'crm' && (<div className="space-y-6"><header><h2 className="text-2xl font-bold text-slate-800">å®¢æˆ¶é—œä¿‚ç®¡ç†</h2></header><div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">(CRM ä»‹é¢ä¿ç•™ï¼Œæ”¯æ´èº«åˆ†è­‰ã€ç”Ÿæ—¥æª¢è¦–)</div></div>)}

        {activeTab === 'import' && (
          <div className="max-w-3xl mx-auto space-y-6">
            <header><h2 className="text-2xl font-bold text-slate-800">è³‡æ–™æ‰¹æ¬¡æ›´æ–°</h2></header>
            <div className="bg-white p-6 rounded-xl shadow-sm border border-slate-200">
               <label className="block text-sm font-medium text-slate-700 mb-2">CSV åŸå§‹æ•¸æ“š (å·²æ“´å……æ¬„ä½)</label>
               <textarea className="w-full h-64 p-4 font-mono text-sm bg-slate-50 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" value={csvInput} onChange={(e) => setCsvInput(e.target.value)} placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„æ•¸æ“š..." />
               <div className="mt-4 flex justify-between"><div className="text-sm text-slate-500 flex items-center"><AlertCircle size={16} className="mr-1" />è«‹è¨˜å¾—å„²å­˜</div><button onClick={() => handleSaveCSV(csvInput)} disabled={isSaving} className={`px-6 py-2 text-white font-medium rounded-lg flex items-center ${isSaving ? 'bg-slate-400' : 'bg-blue-600 hover:bg-blue-700'}`}>{isSaving ? <><Loader2 size={18} className="mr-2 animate-spin" />å„²å­˜ä¸­...</> : <><Save size={18} className="mr-2" />å„²å­˜ä¸¦åŒæ­¥</>}</button></div>
            </div>
          </div>
        )}
      </main>

      {showCreateEvent && (<CreateEventModal onClose={() => setShowCreateEvent(false)} onSave={handleCreateEvent} customTemplates={customTemplates} onAddTemplate={handleAddTemplate} onDeleteTemplate={handleDeleteTemplate} availableInstructors={availableInstructors} />)}
      {activeTaskDetail && (<TaskDetailModal task={activeTaskDetail} eventData={activeTaskDetail.fullEventData} onClose={() => setActiveTaskDetail(null)} />)}
      {showDebug && <DebugPanel onClose={() => setShowDebug(false)} />}
    </div>
  );
}
