<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperOps - å…¨æ–¹ä½ç‡Ÿé‹ç®¡ç†ç³»çµ±</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useMemo, useEffect, useRef } = React;
        
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- Icon å…ƒä»¶ ---
        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (!window.lucide) return;
                const { icons, createElement } = window.lucide;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconNode = icons[iconName];
                if (iconNode && containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const svgElement = createElement(iconNode);
                    svgElement.setAttribute('width', size);
                    svgElement.setAttribute('height', size);
                    const existingClass = svgElement.getAttribute('class') || '';
                    svgElement.setAttribute('class', `${existingClass} ${className}`.trim());
                    containerRef.current.appendChild(svgElement);
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        // --- Firebase è¨­å®š ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtfR8N9Dw9kG3jQSfJSs0p0MLvlQaOR74",
            authDomain: "crm-sys-4184a.firebaseapp.com",
            projectId: "crm-sys-4184a",
            storageBucket: "crm-sys-4184a.firebasestorage.app",
            messagingSenderId: "943273685158",
            appId: "1:943273685158:web:8ca441dd78dcb5b956c467",
            measurementId: "G-2M2W340ZKB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'crm-system-v1';

        // --- é è¨­è³‡æ–™ ---
        const INITIAL_CSV_DATA = `æ—¥æœŸ,æ´»å‹•åç¨±,è¬›å¸«,å®¢æˆ¶å§“å,é‡‘é¡,äº¤é€šæ–¹å¼,èº«åˆ†è­‰å­—è™Ÿ,ç”Ÿæ—¥
2023-11-05,é«˜å±±æ”å½±åœ˜,å¼µå¤§å¸«,ç‹å°æ˜,5000,å…±ä¹˜,A123456789,1990-05-20
2023-11-05,é«˜å±±æ”å½±åœ˜,å¼µå¤§å¸«,æå°ç¾,5000,è‡ªè¡Œå‰å¾€,B223456789,1992-08-15
2023-11-05,é«˜å±±æ”å½±åœ˜,å¼µå¤§å¸«,é™³å¤§æ–‡,4500,å…±ä¹˜,C123456789,1988-12-01`;

        const INITIAL_PROJECTS = [
            { name: '12æœˆè·¨å¹´æ´»å‹•ç±Œå‚™', owner: 'Alex', status: 'In Progress', deadline: '2023-12-15' },
            { name: 'å®˜ç¶²è¦–è¦ºå¤§æ”¹ç‰ˆ', owner: 'Sarah', status: 'Stuck', deadline: '2024-01-10' },
            { name: '2024 å¹´åº¦è¬›å¸«æ‹›å‹Ÿ', owner: 'Ken', status: 'Done', deadline: '2023-11-30' },
        ];

        const DEFAULT_TASKS_TEMPLATE = [
            { id: 'insurance', type: 'insurance', name: 'è¾¦ç†ä¿éšª', fields: [{ label: 'ä¿å–®è™Ÿç¢¼', value: '' }], completed: false },
            { id: 'pre_letter', type: 'pre_letter', name: 'å¯„é€è¡Œå‰ä¿¡', fields: [{ label: 'å¯„é€æ—¥æœŸ', value: '' }], completed: false },
            { id: 'post_letter', type: 'post_letter', name: 'å¯„é€èŠ±çµ®ä¿¡', fields: [{ label: 'ç…§ç‰‡é€£çµ', value: '' }], completed: false },
        ];

        const DEFAULT_EVENT_TEMPLATES = [
            { id: 'default_1', name: 'ç™»å±±åœ˜æ¨¡æ¿', eventName: 'é€±æœ«ç™»å±±åœ˜', instructor: 'å¼µå¤§å¸«', isSystem: true },
            { id: 'default_2', name: 'éœ²ç‡Ÿåœ˜æ¨¡æ¿', eventName: 'æ˜Ÿç©ºéœ²ç‡Ÿ', instructor: 'æ—åšå£«', isSystem: true },
            { id: 'default_3', name: 'èª²ç¨‹æ¨¡æ¿', eventName: 'æ”å½±æ•™å­¸', instructor: 'é™³æ•™ç·´', isSystem: true },
        ];

        // --- Helper Functions ---
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const getDaysDiff = (targetDateStr) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(targetDateStr);
            const diffTime = target.getTime() - today.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        const getTaskStatusStyle = (taskType, eventDateStr) => {
            const daysDiff = getDaysDiff(eventDateStr);
            if (taskType === 'insurance') {
                if (daysDiff <= 3 && daysDiff >= 0) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'æ€¥è¿«' };
                if (daysDiff < 0) return { color: 'text-slate-400', bg: 'bg-slate-100', border: 'border-slate-200', label: 'å·²é' };
                return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: 'å¾…è¾¦' };
            }
            if (taskType === 'post_letter') {
                const daysSinceEvent = -daysDiff; 
                if (daysSinceEvent < 1) return { color: 'text-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', label: 'æœªé–‹å§‹' };
                if (daysSinceEvent === 1) return { color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200', label: 'å»ºè­°å¯„é€' };
                if (daysSinceEvent >= 3) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'å»¶é²' };
            }
            return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: '' };
        };

        // --- Components ---

        const NavItem = ({ id, icon, label, activeTab, setActiveTab }) => (
            <button onClick={() => setActiveTab(id)} className={`flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 w-full ${activeTab === id ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'text-slate-500 hover:bg-white hover:shadow-sm'}`}>
                <Icon name={icon} size={20} />
                <span className="font-medium tracking-wide">{label}</span>
            </button>
        );

        const EventManagerModal = ({ event, config, onClose, onSaveConfig }) => {
            const [capacity, setCapacity] = useState(config?.capacity || 20);
            const [tasks, setTasks] = useState(config?.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE)));
            
            const handleTaskToggle = (index) => {
                const newTasks = [...tasks];
                newTasks[index].completed = !newTasks[index].completed;
                setTasks(newTasks);
            };

            const handleAddTask = () => {
                const name = prompt("è«‹è¼¸å…¥æ–°ä»»å‹™åç¨±:");
                if (name) setTasks([...tasks, { id: `custom_${Date.now()}`, name, fields: [], completed: false }]);
            };

            const handleDeleteTask = (index) => {
                if(confirm("ç¢ºå®šåˆªé™¤?")) {
                    const newTasks = [...tasks];
                    newTasks.splice(index, 1);
                    setTasks(newTasks);
                }
            };

            const handleSave = () => {
                onSaveConfig({ capacity: parseInt(capacity), tasks });
                onClose();
            };

            const progress = Math.round((tasks.filter(t => t.completed).length / Math.max(tasks.length, 1)) * 100);

            return (
                <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                            <div>
                                <div className="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded mb-1 inline-block">{event.date}</div>
                                <h3 className="text-xl font-bold text-slate-800">{event.eventName}</h3>
                            </div>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-6">
                            <section>
                                <h4 className="font-bold text-slate-700 mb-3 flex items-center"><Icon name="users" size={18} className="mr-2"/> äººæ•¸è¨­å®š</h4>
                                <div className="bg-slate-50 p-4 rounded-xl flex justify-between items-center border border-slate-200">
                                    <span className="text-slate-600">ç›®å‰å ±å: <strong className="text-slate-800">{event.count}</strong> äºº</span>
                                    <div className="flex items-center gap-2">
                                        <span className="text-sm text-slate-500">ä¸Šé™:</span>
                                        <input type="number" value={capacity} onChange={e=>setCapacity(e.target.value)} className="w-20 px-2 py-1 text-center border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500"/>
                                    </div>
                                </div>
                            </section>
                            <section>
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="font-bold text-slate-700 flex items-center"><Icon name="check-square" size={18} className="mr-2"/> åŸ·è¡Œä»»å‹™</h4>
                                    <button onClick={handleAddTask} className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 flex items-center"><Icon name="plus" size={14} className="mr-1"/> æ–°å¢</button>
                                </div>
                                <div className="w-full h-2 bg-slate-100 rounded-full mb-4 overflow-hidden"><div className="h-full bg-green-500 transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                                <div className="space-y-2">
                                    {tasks.map((t, i) => (
                                        <div key={i} className="flex items-center justify-between p-3 border border-slate-200 rounded-xl hover:bg-slate-50 group">
                                            <div className="flex items-center gap-3 cursor-pointer" onClick={()=>handleTaskToggle(i)}>
                                                <div className={`w-5 h-5 rounded border flex items-center justify-center ${t.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300'}`}>{t.completed && <Icon name="check" size={14}/>}</div>
                                                <span className={t.completed ? 'text-slate-400 line-through' : 'text-slate-700 font-medium'}>{t.name}</span>
                                            </div>
                                            <button onClick={()=>handleDeleteTask(i)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={16}/></button>
                                        </div>
                                    ))}
                                </div>
                            </section>
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50/50 rounded-b-2xl flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                            <button onClick={handleSave} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        };

        const DebugPanel = ({ onClose }) => { 
            const [logs, setLogs] = useState([]);
            const [status, setStatus] = useState({ auth: 'checking', firestore: 'checking', network: 'online' });
            const addLog = (msg, type = 'info') => setLogs(p => [...p, { msg, type, time: new Date().toLocaleTimeString() }]);
            useEffect(() => {
                const run = async () => {
                    addLog("ç³»çµ±å•Ÿå‹•...", 'info');
                    try {
                        await signInAnonymously(auth);
                        setStatus(s => ({...s, auth: 'success'}));
                        addLog("Auth OK", 'success');
                    } catch(e) { setStatus(s => ({...s, auth: 'error'})); addLog(e.message, 'error'); }
                    try {
                        await setDoc(doc(db, `artifacts/${appId}/public/ping`), {t:Date.now()});
                        setStatus(s => ({...s, firestore: 'success'}));
                        addLog("DB Write OK", 'success');
                    } catch(e) { setStatus(s => ({...s, firestore: 'error'})); addLog(e.message, 'error'); }
                };
                run();
            }, []);
            return (
                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
                    <div className="bg-slate-900 text-green-400 rounded-xl w-full max-w-lg h-96 flex flex-col p-4 font-mono text-xs overflow-auto">
                        <div className="flex justify-between border-b border-slate-700 pb-2 mb-2"><span>DIAGNOSTICS</span><button onClick={onClose}>X</button></div>
                        {logs.map((l,i)=><div key={i} className={l.type==='error'?'text-red-400':''}>{`> ${l.msg}`}</div>)}
                    </div>
                </div>
            );
        };

        const CreateEventModal = ({ onClose, onSave, customTemplates, onAddTemplate, onDeleteTemplate, availableInstructors }) => {
            const [mode, setMode] = useState('template'); 
            const [isCreatingTemplate, setIsCreatingTemplate] = useState(false);
            const [calendarMonth, setCalendarMonth] = useState(new Date());
            const [formData, setFormData] = useState({ dates: [], eventName: '', instructors: [] });
            const [tempInstructor, setTempInstructor] = useState('');
            const [newTemplateData, setNewTemplateData] = useState({ name: '', eventName: '', instructor: '' });

            const handleTemplateSelect = (tpl) => {
                let tplInstructors = [];
                if (tpl.instructor) tplInstructors = tpl.instructor.split(/[&,]/).map(s => s.trim());
                setFormData({ ...formData, eventName: tpl.eventName, instructors: tplInstructors });
            };

            const toggleDate = (year, month, day) => {
                const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                let newDates = formData.dates.includes(dateStr) ? formData.dates.filter(d => d !== dateStr) : [...formData.dates, dateStr].sort();
                setFormData({ ...formData, dates: newDates });
            };

            const addInstructor = (name) => {
                const clean = name.trim();
                if (clean && !formData.instructors.includes(clean)) setFormData({ ...formData, instructors: [...formData.instructors, clean] });
                setTempInstructor('');
            };

            const removeInstructor = (name) => {
                setFormData({ ...formData, instructors: formData.instructors.filter(i => i !== name) });
            };

            const handleSubmitEvent = () => {
                if (formData.dates.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸ"); return; }
                onSave(formData);
            };

            const handleSaveNewTemplate = () => {
                if (!newTemplateData.name) { alert("è«‹è¼¸å…¥æ¨¡æ¿åç¨±"); return; }
                onAddTemplate(newTemplateData);
                setIsCreatingTemplate(false);
                setNewTemplateData({ name: '', eventName: '', instructor: '' });
            };

            const renderCalendar = () => {
                const year = calendarMonth.getFullYear();
                const month = calendarMonth.getMonth();
                const daysInMonth = getDaysInMonth(year, month);
                const firstDay = getFirstDayOfMonth(year, month);
                const days = Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1));

                return (
                    <div className="bg-slate-50 p-4 rounded-xl border border-slate-200">
                        <div className="flex justify-between items-center mb-4">
                            <button onClick={() => setCalendarMonth(new Date(year, month - 1))}><Icon name="chevron-left" size={20}/></button>
                            <span className="font-bold text-slate-700">{year}å¹´ {month + 1}æœˆ</span>
                            <button onClick={() => setCalendarMonth(new Date(year, month + 1))}><Icon name="chevron-right" size={20}/></button>
                        </div>
                        <div className="grid grid-cols-7 text-center mb-2 text-xs font-bold text-slate-400">
                           {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}
                        </div>
                        <div className="grid grid-cols-7 gap-1">
                            {days.map((day, i) => (
                                <div key={i} className="aspect-square flex items-center justify-center">
                                    {day && (
                                        <button onClick={() => toggleDate(year, month, day)} className={`w-8 h-8 rounded-full text-sm transition-all ${formData.dates.includes(`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`) ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-blue-100 text-slate-600'}`}>
                                            {day}
                                        </button>
                                    )}
                                </div>
                            ))}
                        </div>
                    </div>
                );
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                            <h3 className="text-xl font-bold flex items-center gap-2"><Icon name="zap" className="text-yellow-500"/> å¿«é€Ÿé–‹åœ˜</h3>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-6">
                            {!isCreatingTemplate ? (
                                <>
                                    <div className="flex bg-slate-100 p-1 rounded-lg">
                                        {['template','custom'].map(m => (
                                            <button key={m} onClick={()=>setMode(m)} className={`flex-1 py-1.5 text-sm rounded-md transition-all ${mode===m?'bg-white shadow text-blue-600':'text-slate-500'}`}>{m==='template'?'ä½¿ç”¨æ¨¡æ¿':'å®Œå…¨è‡ªè¨‚'}</button>
                                        ))}
                                    </div>
                                    {mode === 'template' && (
                                        <div className="grid grid-cols-3 gap-3">
                                            {[...DEFAULT_EVENT_TEMPLATES, ...customTemplates].map((tpl, i) => (
                                                <div key={i} onClick={()=>handleTemplateSelect(tpl)} className={`border rounded-xl p-3 cursor-pointer text-center hover:bg-blue-50 transition-all ${formData.eventName===tpl.eventName?'border-blue-500 ring-1 ring-blue-500 bg-blue-50':'border-slate-200'}`}>
                                                    <div className="font-bold text-slate-700 text-sm mb-1">{tpl.name}</div>
                                                    <div className="text-xs text-slate-500">{tpl.instructor}</div>
                                                </div>
                                            ))}
                                            <button onClick={()=>setIsCreatingTemplate(true)} className="border border-dashed border-slate-300 rounded-xl p-3 flex flex-col items-center justify-center text-slate-400 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all">
                                                <Icon name="plus-circle" className="mb-1"/><span className="text-xs">æ–°å¢æ¨¡æ¿</span>
                                            </button>
                                        </div>
                                    )}
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-slate-100">
                                        <div><label className="block text-sm font-medium text-slate-700 mb-2">1. é¸æ“‡æ—¥æœŸ (å¤šé¸)</label>{renderCalendar()}</div>
                                        <div className="space-y-4">
                                            <div><label className="block text-sm font-medium text-slate-700 mb-1">2. æ´»å‹•åç¨±</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={formData.eventName} onChange={e=>setFormData({...formData, eventName: e.target.value})} placeholder="è¼¸å…¥åç¨±..."/></div>
                                            <div>
                                                <label className="block text-sm font-medium text-slate-700 mb-1">3. å¸¶åœ˜è¬›å¸«</label>
                                                <div className="flex flex-wrap gap-2 mb-2 min-h-[38px] p-2 bg-white border border-slate-200 rounded-lg">
                                                    {formData.instructors.map(ins=><div key={ins} className="flex items-center bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm"><span className="mr-1">{ins}</span><button onClick={()=>setFormData({...formData, instructors: formData.instructors.filter(i=>i!==ins)})}><Icon name="x" size={14}/></button></div>)}
                                                </div>
                                                <div className="flex gap-2"><input type="text" className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" value={tempInstructor} onChange={e=>setTempInstructor(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addInstructor(tempInstructor)} placeholder="è¼¸å…¥åå­—..."/><button onClick={()=>addInstructor(tempInstructor)} className="px-3 bg-slate-100 rounded-lg hover:bg-slate-200"><Icon name="plus" size={18}/></button></div>
                                                <div className="flex flex-wrap gap-2 mt-2">{availableInstructors.slice(0,6).map(i=><button key={i} onClick={()=>addInstructor(i)} className="text-xs px-2 py-1 bg-slate-50 border rounded-full hover:bg-blue-50">+ {i}</button>)}</div>
                                            </div>
                                        </div>
                                    </div>
                                </>
                            ) : (
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3">
                                    <div className="flex justify-between"><h4 className="font-bold">å»ºç«‹æ–°æ¨¡æ¿</h4><button onClick={()=>setIsCreatingTemplate(false)} className="text-sm text-slate-500">å–æ¶ˆ</button></div>
                                    <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="æ¨¡æ¿åç¨± (å¦‚: è±ªè¯åœ˜)" value={newTemplateData.name} onChange={e=>setNewTemplateData({...newTemplateData, name: e.target.value})}/>
                                    <div className="grid grid-cols-2 gap-3">
                                        <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="é è¨­æ´»å‹•åç¨±" value={newTemplateData.eventName} onChange={e=>setNewTemplateData({...newTemplateData, eventName: e.target.value})}/>
                                        <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="é è¨­è¬›å¸«" value={newTemplateData.instructor} onChange={e=>setNewTemplateData({...newTemplateData, instructor: e.target.value})}/>
                                    </div>
                                    <button onClick={()=>{ if(newTemplateData.name){ onAddTemplate(newTemplateData); setIsCreatingTemplate(false); } }} className="w-full py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">å„²å­˜æ¨¡æ¿</button>
                                </div>
                            )}
                        </div>
                        {!isCreatingTemplate && <div className="p-4 border-t border-slate-100 flex justify-end items-center gap-4 bg-slate-50/50 rounded-b-2xl"><span className="text-xs text-slate-500">å°‡å»ºç«‹ {formData.dates.length} å ´æ´»å‹•</span><button onClick={()=>onSave(formData)} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md">æ‰¹é‡å»ºç«‹</button></div>}
                    </div>
                </div>
            );
        };

        const TaskDetailModal = ({ task, eventData, onClose }) => {
            const [copied, setCopied] = useState(false);
            const renderContent = () => {
                if (task.type === 'insurance') {
                    const copyText = eventData.customers.map(c => `${c.name}\t${c.id}\t${c.birthday}`).join('\n');
                    const handleCopy = () => { navigator.clipboard.writeText(copyText); setCopied(true); setTimeout(() => setCopied(false), 2000); };
                    return <div className="space-y-4"><div className="bg-amber-50 border border-amber-200 p-3 rounded-lg flex gap-3"><Icon name="shield-check" className="text-amber-600"/><div className="text-sm text-amber-800"><p className="font-bold">ä¿éšªè³‡è¨Š</p><p>è«‹è¤‡è£½ä¸‹åˆ—åå–®æä¾›çµ¦ä¿éšªæ¥­å‹™ (å§“å/èº«åˆ†è­‰/ç”Ÿæ—¥)ã€‚</p></div></div><div className="relative"><button onClick={handleCopy} className="absolute top-2 right-2 flex items-center px-3 py-1 bg-white border rounded text-xs shadow-sm">{copied?<Icon name="check" size={14} className="text-green-600"/>:<Icon name="copy" size={14}/>} è¤‡è£½</button><div className="bg-slate-100 p-4 rounded-lg font-mono text-sm max-h-60 overflow-y-auto whitespace-pre">{eventData.customers.map(c=>`${c.name}\t${c.id}\t${c.birthday}`).join('\n')}</div></div></div>;
                }
                if (task.type === 'pre_letter') {
                    const car = eventData.customers.filter(c=>c.transport==='å…±ä¹˜');
                    const self = eventData.customers.filter(c=>c.transport!=='å…±ä¹˜');
                    return <div className="space-y-4"><div className="bg-blue-50 border border-blue-200 p-3 rounded-lg flex gap-3"><Icon name="mail" className="text-blue-600"/><div className="text-sm text-blue-800"><p className="font-bold">è¡Œå‰ä¿¡å¯„é€</p><p>å·²è‡ªå‹•åˆ†æµå…±ä¹˜èˆ‡è‡ªè¡Œå‰å¾€çš„å®¢æˆ¶ã€‚</p></div></div><div className="grid grid-cols-2 gap-4"><div className="border p-3 rounded-lg"><h4 className="font-bold mb-2">ğŸš— å…±ä¹˜ ({car.length})</h4><div className="bg-slate-50 p-2 rounded text-xs h-32 overflow-y-auto">{car.map(c=>c.name).join(', ')}</div></div><div className="border p-3 rounded-lg"><h4 className="font-bold mb-2">ğŸš¶ è‡ªè¡Œ ({self.length})</h4><div className="bg-slate-50 p-2 rounded text-xs h-32 overflow-y-auto">{self.map(c=>c.name).join(', ')}</div></div></div></div>;
                }
                return <div className="text-center text-slate-500 py-8">ç„¡ç‰¹æ®Šå·¥å…·ï¼Œè«‹ä¾ä¸€èˆ¬æµç¨‹åŸ·è¡Œã€‚</div>;
            };
            return <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl"><div className="p-6 border-b flex justify-between items-center"><div><div className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded inline-block mb-1">{eventData.date}</div><h3 className="text-xl font-bold">{task.name}</h3></div><button onClick={onClose}><Icon name="x"/></button></div><div className="p-6 overflow-y-auto">{renderContent()}</div></div></div>;
        };

        const MainApp = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('tasks');
            const [loading, setLoading] = useState(true);
            const [showDebug, setShowDebug] = useState(false);
            const [showCreateEvent, setShowCreateEvent] = useState(false);
            const [editingEvent, setEditingEvent] = useState(null); 
            const [eventsViewMode, setEventsViewMode] = useState('calendar');
            
            const [csvInput, setCsvInput] = useState('');
            const [parsedData, setParsedData] = useState([]);
            const [eventConfigs, setEventConfigs] = useState({});
            const [customTemplates, setCustomTemplates] = useState([]);
            const [projects, setProjects] = useState([]);
            
            const [activeTaskDetail, setActiveTaskDetail] = useState(null);
            const [selectedCustomer, setSelectedCustomer] = useState('');
            const [currentDate, setCurrentDate] = useState(new Date());

            // [æ–°å¢] æ–°å ±åè¡¨å–® State
            const [newReg, setNewReg] = useState({
                date: '', eventName: '', instructor: '', customerName: '', 
                price: '', transport: '', idNo: '', birthday: ''
            });

            useEffect(() => {
                signInAnonymously(auth).catch(console.error);
                return onAuthStateChanged(auth, u => setUser(u));
            }, []);

            useEffect(() => {
                if (!user) return;
                setLoading(true);
                const basePath = `artifacts/${appId}/public/data`;
                
                const updateParsedData = (raw) => {
                    try {
                        const lines = raw.trim().split('\n');
                        const data = lines.slice(1).map((line, i) => {
                            const v = line.split(',');
                            if(v.length < 5) return null;
                            return {
                                id: i, date: v[0]?.trim(), eventName: v[1]?.trim(), instructor: v[2]?.trim(),
                                customerName: v[3]?.trim(), price: parseInt(v[4])||0, transport: v[5]?.trim(),
                                idNo: v[6]?.trim(), birthday: v[7]?.trim()
                            };
                        }).filter(Boolean);
                        setParsedData(data);
                    } catch(e) { console.error(e); }
                };

                const unsub1 = onSnapshot(doc(db, basePath, 'settings', 'main'), s => {
                    if(s.exists()) {
                        const d = s.data().csvData || '';
                        if(d !== csvInput) { setCsvInput(d); updateParsedData(d); }
                    } else { setDoc(doc(db, basePath, 'settings', 'main'), { csvData: INITIAL_CSV_DATA }); }
                    setLoading(false);
                });
                const unsub2 = onSnapshot(doc(db, basePath, 'settings', 'templates'), s => setCustomTemplates(s.data()?.list || []));
                const unsub3 = onSnapshot(collection(db, basePath, 'event_configs'), s => {
                    const cfgs = {}; s.forEach(d => cfgs[d.id] = d.data()); setEventConfigs(cfgs);
                });
                const unsub4 = onSnapshot(collection(db, basePath, 'projects'), s => {
                    const p = []; s.forEach(d => p.push({id: d.id, ...d.data()})); 
                    if(p.length===0 && !s.metadata.fromCache) INITIAL_PROJECTS.forEach(ip=>addDoc(collection(db, basePath, 'projects'), ip));
                    setProjects(p);
                });

                return () => { unsub1(); unsub2(); unsub3(); unsub4(); };
            }, [user]);

            const handleSaveCSV = async (newData) => {
                if(!user) return;
                try {
                    const lines = newData.trim().split('\n');
                    const data = lines.slice(1).map((line, i) => {
                        const v = line.split(',');
                        if(v.length < 5) return null;
                        return {
                            id: i, date: v[0]?.trim(), eventName: v[1]?.trim(), instructor: v[2]?.trim(),
                            customerName: v[3]?.trim(), price: parseInt(v[4])||0, transport: v[5]?.trim(),
                            idNo: v[6]?.trim(), birthday: v[7]?.trim()
                        };
                    }).filter(Boolean);
                    setParsedData(data);
                } catch(e) {}
                setCsvInput(newData);
                await setDoc(doc(db, `artifacts/${appId}/public/data`, 'settings', 'main'), { csvData: newData }, { merge: true });
            };

            const handleAddManualReg = async () => {
                if(!newReg.date || !newReg.eventName || !newReg.customerName) {
                    alert("è«‹å¡«å¯«å¿…è¦æ¬„ä½ (æ—¥æœŸ, æ´»å‹•åç¨±, å®¢æˆ¶å§“å)");
                    return;
                }
                // æ ¼å¼: æ—¥æœŸ,æ´»å‹•åç¨±,è¬›å¸«,å®¢æˆ¶å§“å,é‡‘é¡,äº¤é€šæ–¹å¼,èº«åˆ†è­‰å­—è™Ÿ,ç”Ÿæ—¥
                const newRow = `\n${newReg.date},${newReg.eventName},${newReg.instructor},${newReg.customerName},${newReg.price},${newReg.transport},${newReg.idNo},${newReg.birthday}`;
                const updatedCSV = csvInput + newRow;
                
                await handleSaveCSV(updatedCSV);
                
                // Clear form
                setNewReg({
                    date: '', eventName: '', instructor: '', customerName: '', 
                    price: '', transport: '', idNo: '', birthday: ''
                });
                alert("æ–°å¢æˆåŠŸï¼");
            };

            const handleCreateEvent = async ({ dates, eventName, instructors }) => {
                let rows = '';
                const instr = instructors.join(' & ');
                dates.forEach(d => rows += `\n${d},${eventName},${instr},é–‹æ”¾å ±åä¸­,0,,,`);
                await handleSaveCSV(csvInput + rows);
                setShowCreateEvent(false);
            };

            const handleAddTemplate = (tpl) => {
                const newList = [...customTemplates, { ...tpl, id: `custom_${Date.now()}` }];
                setDoc(doc(db, `artifacts/${appId}/public/data`, 'settings', 'templates'), { list: newList }, { merge: true });
            };
            const onDeleteTemplate = (id) => {
                if(confirm("ç¢ºå®šåˆªé™¤?")) setDoc(doc(db, `artifacts/${appId}/public/data`, 'settings', 'templates'), { list: customTemplates.filter(t=>t.id!==id) }, { merge: true });
            };

            const handleSaveEventConfig = async (eventId, newConfig) => {
                await setDoc(doc(db, `artifacts/${appId}/public/data`, 'event_configs', eventId), newConfig, { merge: true });
            };

            const handleProjectStatus = async (pid, status) => {
                const next = status === 'Stuck' ? 'To Do' : status === 'To Do' ? 'In Progress' : status === 'In Progress' ? 'Done' : 'Stuck';
                await updateDoc(doc(db, `artifacts/${appId}/public/data`, 'projects', pid), { status: next });
            };
            const handleAddProject = async () => {
                const name = prompt("å°ˆæ¡ˆåç¨±:");
                if(name) await addDoc(collection(db, `artifacts/${appId}/public/data`, 'projects'), { name, owner: 'Team', status: 'To Do', deadline: new Date().toISOString().split('T')[0] });
            };
            const handleDeleteProject = async (pid) => { if(confirm("åˆªé™¤å°ˆæ¡ˆ?")) await deleteDoc(doc(db, `artifacts/${appId}/public/data`, 'projects', pid)); };

            const stats = useMemo(() => {
                const totalRev = parsedData.reduce((a,c) => a + c.price, 0);
                const events = {};
                const instrs = {};
                parsedData.forEach(c => {
                    const key = `${c.date}_${c.eventName}_${c.instructor}`.replace(/[\/\\#\?]/g, '-');
                    if(!events[key]) events[key] = { ...c, count: 0, customers: [], key };
                    if(c.customerName !== 'é–‹æ”¾å ±åä¸­') {
                        events[key].count++;
                        events[key].customers.push(c);
                    }
                    if(c.instructor) c.instructor.split(/[&,]/).forEach(i => {
                        const name = i.trim();
                        if(name && name !== 'æœªå®š') instrs[name] = (instrs[name]||0)+1;
                    });
                });
                return { totalRev, totalPax: parsedData.length, events, instrs };
            }, [parsedData]);

            const tasks = useMemo(() => {
                const list = [];
                Object.values(stats.events).forEach(evt => {
                    const cfg = eventConfigs[evt.key] || {};
                    const tList = cfg.tasks || DEFAULT_TASKS_TEMPLATE;
                    tList.forEach((t, i) => {
                        if(!t.completed) list.push({ ...t, taskIdx: i, evtDate: evt.date, evtName: evt.eventName, cfgKey: evt.key, style: getTaskStatusStyle(t.type, evt.date), fullEvent: evt });
                    });
                });
                return list.sort((a,b) => new Date(a.evtDate) - new Date(b.evtDate));
            }, [stats.events, eventConfigs]);

            const toggleTask = async (key, idx) => {
                const cfg = eventConfigs[key] || {};
                const tList = cfg.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE));
                tList[idx].completed = !tList[idx].completed;
                await setDoc(doc(db, `artifacts/${appId}/public/data`, 'event_configs', key), { ...cfg, tasks: tList }, { merge: true });
            };

            const uniqueCustomers = [...new Set(parsedData.map(d => d.customerName))].filter(n => n !== 'é–‹æ”¾å ±åä¸­');
            const customerHistory = selectedCustomer ? parsedData.filter(d => d.customerName === selectedCustomer) : [];

            // Calendar View Helpers
            const calendarDays = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const daysInMonth = getDaysInMonth(year, month);
                const firstDay = getFirstDayOfMonth(year, month);
                return Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1));
            }, [currentDate]);

            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));

            if(loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-400"><Icon name="loader-2" className="animate-spin mr-2"/> è¼‰å…¥ä¸­...</div>;

            return (
                <div className="flex min-h-screen">
                    <aside className="w-64 bg-white border-r border-slate-200 flex flex-col p-4 hidden md:flex sticky top-0 h-screen">
                        <div className="flex items-center space-x-2 px-4 mb-8 mt-2">
                            <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">S</div>
                            <span className="font-bold text-lg tracking-tight">SuperOps</span>
                        </div>
                        <nav className="space-y-1 flex-1">
                            <NavItem id="tasks" icon="check-square" label="ä»»å‹™æŒ‡æ®ä¸­å¿ƒ" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="events" icon="calendar" label="æ´»å‹•å ´æ¬¡è¡¨" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="projects" icon="briefcase" label="å°ˆæ¡ˆé€²åº¦" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="dashboard" icon="trending-up" label="ç‡Ÿé‹å„€è¡¨æ¿" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="crm" icon="users" label="å®¢æˆ¶ CRM" activeTab={activeTab} setActiveTab={setActiveTab} />
                        </nav>
                        <div className="pt-4 border-t border-slate-100">
                            <button onClick={()=>setShowDebug(true)} className="w-full flex items-center gap-2 px-4 py-3 text-slate-400 hover:text-slate-600 transition-all text-sm mb-1">
                                <Icon name="activity" size={16}/> <span>é€£ç·šè¨ºæ–·</span>
                            </button>
                            <NavItem id="import" icon="file-text" label="è³‡æ–™åº«ç®¡ç†" activeTab={activeTab} setActiveTab={setActiveTab} />
                        </div>
                    </aside>

                    <main className="flex-1 p-6 md:p-10 overflow-y-auto bg-slate-50/50 relative">
                        <div className="md:hidden mb-6 flex justify-between items-center"><span className="font-bold text-lg">SuperOps</span><button onClick={()=>setShowDebug(true)}><Icon name="activity"/></button></div>

                        {activeTab === 'tasks' && (
                            <div className="max-w-6xl mx-auto fade-in">
                                <header className="mb-8 flex justify-between items-end">
                                    <div><h2 className="text-2xl font-bold text-slate-800 mb-1">ä»»å‹™æŒ‡æ®ä¸­å¿ƒ</h2><p className="text-slate-500 text-sm">æ™ºæ…§è¿½è¹¤ç³»çµ±ï¼Œæ ¹æ“šæ´»å‹•æ—¥æœŸè‡ªå‹•æ’åº</p></div>
                                    <div className="bg-white px-4 py-2 rounded-full border text-sm font-medium">å¾…è™•ç†: <span className="text-blue-600 font-bold ml-1">{tasks.length}</span></div>
                                </header>
                                {tasks.length===0 ? <div className="text-center py-20"><div className="text-6xl mb-4">ğŸ‰</div><h3 className="text-xl font-bold text-slate-700">å¤ªæ£’äº†ï¼ä»»å‹™å·²æ¸…ç©º</h3></div> : 
                                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                    {tasks.map((t, i) => (
                                        <div key={`${t.cfgKey}-${t.taskIdx}`} onClick={() => setActiveTaskDetail(t)} className={`bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden`}>
                                            <div className={`absolute top-0 left-0 w-1 h-full ${t.style.bg.replace('bg-', 'bg-')==='bg-white'?'bg-slate-200':t.style.bg.replace('bg','bg').replace('50','400')}`}></div>
                                            <div className="flex justify-between mb-3 pl-2"><span className="bg-slate-100 text-slate-600 text-xs font-mono px-2 py-1 rounded">{t.evtDate}</span>{t.style.label&&<span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${t.style.color} ${t.style.border} ${t.style.bg}`}>{t.style.label}</span>}</div>
                                            <div className="pl-2"><div className="text-xs text-slate-500 mb-1 truncate">{t.evtName}</div><h4 className={`font-bold text-lg mb-4 ${t.style.color}`}>{t.name}</h4>
                                            <button onClick={(e)=>{e.stopPropagation();toggleTask(t.cfgKey,t.taskIdx)}} className="w-full py-2 rounded-xl bg-slate-50 text-slate-400 hover:bg-green-500 hover:text-white transition-all flex justify-center gap-2"><Icon name="check-circle-2" size={18}/> æ¨™ç¤ºå®Œæˆ</button></div>
                                        </div>
                                    ))}
                                </div>}
                            </div>
                        )}

                        {activeTab === 'events' && (
                            <div className="fade-in max-w-6xl mx-auto">
                                <header className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">æ´»å‹•å ´æ¬¡</h2>
                                    <div className="flex gap-3">
                                        <button onClick={()=>setShowCreateEvent(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-md"><Icon name="plus" size={18}/> å¿«é€Ÿé–‹åœ˜</button>
                                        <div className="bg-white p-1 rounded-lg border flex">
                                            <button onClick={()=>setEventsViewMode('list')} className={`p-2 rounded-md ${eventsViewMode==='list'?'bg-slate-100':''}`}><Icon name="list" size={18}/></button>
                                            <button onClick={()=>setEventsViewMode('calendar')} className={`p-2 rounded-md ${eventsViewMode==='calendar'?'bg-slate-100':''}`}><Icon name="calendar" size={18}/></button>
                                        </div>
                                    </div>
                                </header>
                                {eventsViewMode === 'list' && (
                                    <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                        <table className="w-full text-left">
                                            <thead className="bg-slate-50 border-b border-slate-100 text-slate-500 text-sm"><tr><th className="px-6 py-4">æ—¥æœŸ</th><th className="px-6 py-4">æ´»å‹•</th><th className="px-6 py-4">å ±å</th><th className="px-6 py-4">æ“ä½œ</th></tr></thead>
                                            <tbody className="divide-y divide-slate-100">
                                                {Object.values(stats.events).map((e, i) => {
                                                    const cfg = eventConfigs[e.key] || {};
                                                    const cap = cfg.capacity || 20;
                                                    const isFull = e.count >= cap;
                                                    return (
                                                        <tr key={i} className="hover:bg-slate-50/80">
                                                            <td className="px-6 py-4 text-slate-600">{e.date}</td>
                                                            <td className="px-6 py-4"><div className="font-bold text-slate-800">{e.eventName}</div><div className="text-xs text-slate-400 mt-0.5">{e.instructor}</div></td>
                                                            <td className="px-6 py-4"><div className="flex items-center gap-2"><span className={`font-bold ${isFull?'text-red-500':'text-slate-700'}`}>{e.count}</span><span className="text-xs text-slate-400">/ {cap}</span><div className="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${isFull?'bg-red-500':'bg-green-500'}`} style={{width:`${Math.min((e.count/cap)*100,100)}%`}}></div></div></div></td>
                                                            <td className="px-6 py-4"><button onClick={()=>setEditingEvent(e)} className="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded flex items-center gap-1 text-sm"><Icon name="settings" size={14}/> ç®¡ç†</button></td>
                                                        </tr>
                                                    );
                                                })}
                                            </tbody>
                                        </table>
                                    </div>
                                )}
                                {eventsViewMode === 'calendar' && (
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                        <div className="flex justify-between items-center mb-6">
                                            <button onClick={prevMonth} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevron-left"/></button>
                                            <h3 className="text-xl font-bold text-slate-800">{currentDate.getFullYear()}å¹´ {currentDate.getMonth()+1}æœˆ</h3>
                                            <button onClick={nextMonth} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevron-right"/></button>
                                        </div>
                                        <div className="grid grid-cols-7 mb-2 text-center text-sm font-bold text-slate-400">
                                            {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}
                                        </div>
                                        <div className="grid grid-cols-7 auto-rows-[120px] border-t border-l border-slate-200">
                                            {calendarDays.map((day, i) => {
                                                const dateStr = day ? `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}` : '';
                                                const dayEvents = day ? Object.values(stats.events).filter(e => e.date === dateStr) : [];
                                                const isToday = day && new Date().toDateString() === new Date(currentDate.getFullYear(), currentDate.getMonth(), day).toDateString();
                                                return (
                                                    <div key={i} className={`border-b border-r border-slate-200 p-2 relative ${day ? 'hover:bg-slate-50' : 'bg-slate-50/50'}`}>
                                                        {day && (
                                                            <>
                                                                <div className={`text-sm font-medium mb-1 ${isToday ? 'bg-blue-600 text-white w-6 h-6 rounded-full flex items-center justify-center' : 'text-slate-500'}`}>{day}</div>
                                                                <div className="space-y-1 overflow-y-auto max-h-[80px] no-scrollbar">
                                                                    {dayEvents.map((e, idx) => (
                                                                        <div key={idx} onClick={()=>setEditingEvent(e)} className="text-xs bg-blue-50 text-blue-700 px-1.5 py-1 rounded border border-blue-100 truncate cursor-pointer hover:bg-blue-100 transition">
                                                                            {e.eventName}
                                                                        </div>
                                                                    ))}
                                                                </div>
                                                            </>
                                                        )}
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    </div>
                                )}
                            </div>
                        )}

                        {activeTab === 'projects' && (
                            <div className="fade-in max-w-6xl mx-auto">
                                <header className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">å°ˆæ¡ˆé€²åº¦</h2><button onClick={handleAddProject} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"><Icon name="plus" size={18}/> æ–°å¢ä»»å‹™</button></header>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    {['To Do', 'In Progress', 'Done'].map(status => (
                                        <div key={status} className="bg-slate-100/50 p-4 rounded-2xl border border-slate-200/60">
                                            <h3 className="text-sm font-bold text-slate-500 uppercase mb-4 flex justify-between">{status} <span className="bg-white px-2 py-0.5 rounded shadow-sm text-slate-800">{projects.filter(p => { if(status==='To Do') return p.status==='To Do'||p.status==='Stuck'; if(status==='In Progress') return p.status==='In Progress'; return p.status==='Done'; }).length}</span></h3>
                                            <div className="space-y-3">
                                                {projects.filter(p => { if(status==='To Do') return p.status==='To Do'||p.status==='Stuck'; if(status==='In Progress') return p.status==='In Progress'; return p.status==='Done'; }).map(p => (
                                                    <div key={p.id} onClick={()=>handleProjectStatus(p.id, p.status)} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition cursor-pointer group relative">
                                                        <button onClick={(e)=>{e.stopPropagation();handleDeleteProject(p.id)}} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icon name="trash-2" size={14}/></button>
                                                        <div className={`text-[10px] font-bold px-2 py-0.5 rounded w-fit mb-2 ${p.status==='Stuck'?'bg-red-100 text-red-600':p.status==='Done'?'bg-green-100 text-green-600':'bg-blue-50 text-blue-600'}`}>{p.status}</div>
                                                        <div className="font-bold text-slate-800">{p.name}</div>
                                                        <div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-50">
                                                            <div className="text-xs text-slate-400 flex items-center gap-1"><Icon name="clock" size={12}/> {p.deadline}</div>
                                                            <div className="w-6 h-6 bg-slate-100 rounded-full flex items-center justify-center text-xs font-bold text-slate-600">{p.owner?.[0]}</div>
                                                        </div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )}

                        {activeTab === 'dashboard' && <div className="fade-in max-w-6xl mx-auto space-y-6"><h2 className="text-2xl font-bold">æ•¸æ“šç¸½è¦½</h2><div className="grid grid-cols-3 gap-6"><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><div className="text-sm text-slate-500">ç¸½ç‡Ÿæ”¶</div><div className="text-3xl font-bold">${stats.totalRev.toLocaleString()}</div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><div className="text-sm text-slate-500">ç¸½äººæ¬¡</div><div className="text-3xl font-bold">{stats.totalPax}</div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><div className="text-sm text-slate-500">å ´æ¬¡</div><div className="text-3xl font-bold">{Object.keys(stats.events).length}</div></div></div></div>}
                        {activeTab === 'crm' && <div className="fade-in max-w-6xl mx-auto"><h2 className="text-2xl font-bold mb-6">å®¢æˆ¶ CRM</h2><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><select className="w-full p-3 border rounded-xl mb-6" value={selectedCustomer} onChange={e=>setSelectedCustomer(e.target.value)}><option value="">æœå°‹å®¢æˆ¶...</option>{uniqueCustomers.map(c=><option key={c} value={c}>{c}</option>)}</select>{selectedCustomer && <div><div className="text-xl font-bold mb-4">{selectedCustomer}</div><div className="space-y-2">{customerHistory.map((h,i)=><div key={i} className="flex justify-between p-3 border rounded-lg bg-slate-50"><span>{h.date} {h.eventName}</span><span>${h.price}</span></div>)}</div></div>}</div></div>}
                        {activeTab === 'import' && (
                            <div className="fade-in max-w-4xl mx-auto space-y-8">
                                {/* New Registration Form */}
                                <section>
                                    <h2 className="text-2xl font-bold mb-6">æ–°å¢å ±åè³‡æ–™</h2>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ *</label><input type="date" className="w-full p-2 border rounded-lg" value={newReg.date} onChange={e=>setNewReg({...newReg, date: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">æ´»å‹•åç¨± *</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="ä¾‹å¦‚: ç™»å±±åœ˜" value={newReg.eventName} onChange={e=>setNewReg({...newReg, eventName: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">è¬›å¸«</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="è¬›å¸«å§“å" value={newReg.instructor} onChange={e=>setNewReg({...newReg, instructor: e.target.value})} /></div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">å®¢æˆ¶å§“å *</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="ç‹å°æ˜" value={newReg.customerName} onChange={e=>setNewReg({...newReg, customerName: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">é‡‘é¡</label><input type="number" className="w-full p-2 border rounded-lg" placeholder="3000" value={newReg.price} onChange={e=>setNewReg({...newReg, price: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">äº¤é€šæ–¹å¼</label>
                                                <select className="w-full p-2 border rounded-lg" value={newReg.transport} onChange={e=>setNewReg({...newReg, transport: e.target.value})}>
                                                    <option value="">æœªå®š</option>
                                                    <option value="å…±ä¹˜">å…±ä¹˜</option>
                                                    <option value="è‡ªè¡Œå‰å¾€">è‡ªè¡Œå‰å¾€</option>
                                                </select>
                                            </div>
                                        </div>
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">èº«åˆ†è­‰å­—è™Ÿ</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="A123456789" value={newReg.idNo} onChange={e=>setNewReg({...newReg, idNo: e.target.value})} /></div>
                                            <div><label className="block text-xs font-bold text-slate-500 mb-1">ç”Ÿæ—¥</label><input type="date" className="w-full p-2 border rounded-lg" value={newReg.birthday} onChange={e=>setNewReg({...newReg, birthday: e.target.value})} /></div>
                                        </div>
                                        <div className="flex justify-end pt-2">
                                            <button onClick={handleAddManualReg} disabled={isSaving} className="bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 hover:bg-blue-700 transition-colors">
                                                {isSaving ? <Icon name="loader-2" className="animate-spin"/> : <Icon name="plus"/>}
                                                æ–°å¢ä¸€ç­†å ±å
                                            </button>
                                        </div>
                                    </div>
                                </section>

                                {/* Raw CSV Edit */}
                                <section>
                                    <h2 className="text-xl font-bold mb-4 text-slate-700">é€²éšï¼šåŸå§‹è³‡æ–™ç·¨è¼¯ (CSV)</h2>
                                    <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <label className="block text-sm font-medium text-slate-700 mb-3">CSV åŸå§‹æ•¸æ“š</label>
                                    <textarea className="w-full h-64 p-4 font-mono text-sm bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none" value={csvInput} onChange={e=>setCsvInput(e.target.value)} placeholder="è«‹åœ¨æ­¤è²¼ä¸Šæ‚¨çš„æ•¸æ“š..." />
                                    <div className="mt-4 flex justify-between items-center">
                                        <div className="text-sm text-slate-500 flex items-center gap-1"><Icon name="alert-circle" size={16} /> ä¿®æ”¹åŸå§‹è³‡æ–™è«‹è¬¹æ…</div>
                                        <button onClick={() => handleSaveCSV(csvInput)} disabled={isSaving} className="bg-slate-800 text-white px-6 py-2 rounded-xl flex items-center gap-2 hover:bg-slate-900">
                                            {isSaving ? <Icon name="loader-2" className="animate-spin"/> : <Icon name="save"/>}
                                            <span>å„²å­˜è®Šæ›´</span>
                                        </button>
                                    </div>
                                    </div>
                                </section>
                            </div>
                        )}

                    </main>

                    {showDebug && <DebugPanel onClose={()=>setShowDebug(false)} />}
                    {showCreateEvent && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in"><div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl"><CreateEventModal onClose={()=>setShowCreateEvent(false)} onSave={handleCreateEvent} customTemplates={customTemplates} onAddTemplate={handleAddTemplate} onDeleteTemplate={onDeleteTemplate} availableInstructors={Object.keys(stats.instrs).sort()} /></div></div>}
                    {activeTaskDetail && <TaskDetailModal task={activeTaskDetail} eventData={activeTaskDetail.fullEvent} onClose={()=>setActiveTaskDetail(null)} />}
                    {editingEvent && <EventManagerModal event={editingEvent} config={eventConfigs[editingEvent.key]} onClose={()=>setEditingEvent(null)} onSaveConfig={(cfg)=>handleSaveEventConfig(editingEvent.key, cfg)} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
