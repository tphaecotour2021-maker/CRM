<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TPHA å°åŒ—åŸå¸‚ç‹©çµæ´»å‹•è¡Œç¨‹è¡¨</title>
    
    <!-- 1. è¼‰å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. è¼‰å…¥ React å…¨åŸŸè®Šæ•¸ç‰ˆæœ¬ (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. è¼‰å…¥ Babel (ç¿»è­¯ JSX) -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- 4. è¼‰å…¥ Lucide åœ–æ¨™ -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- 5. è¼‰å…¥ Firebase Compat ç‰ˆæœ¬ -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; -webkit-tap-highlight-color: transparent; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(226, 232, 240, 0.8); }
        .table-container { overflow-x: auto; -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        // --- 1. å®‰å…¨å•Ÿå‹• React ---
        // ç›´æ¥ä½¿ç”¨ React å…¨åŸŸç‰©ä»¶ï¼Œé¿å…è§£æ§‹éŒ¯èª¤
        const { useState, useMemo, useEffect, useRef } = React;

        // --- 2. Firebase è¨­å®šèˆ‡å®¹éŒ¯è™•ç† ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtfR8N9Dw9kG3jQSfJSs0p0MLvlQaOR74", // è«‹ç¢ºèªé€™æ˜¯æ­£ç¢ºçš„ API Key
            authDomain: "crm-sys-4184a.firebaseapp.com",
            projectId: "crm-sys-4184a",
            storageBucket: "crm-sys-4184a.firebasestorage.app",
            messagingSenderId: "943273685158",
            appId: "1:943273685158:web:8ca441dd78dcb5b956c467",
            measurementId: "G-2M2W340ZKB"
        };

        // å®‰å…¨åˆå§‹åŒ– Firebase
        let app, auth, db;
        try {
            if (!firebase.apps.length) {
                app = firebase.initializeApp(firebaseConfig);
            } else {
                app = firebase.app();
            }
            auth = firebase.auth();
            db = firebase.firestore();
            console.log("Firebase initialized successfully");
        } catch (e) {
            console.error("Firebase initialization failed:", e);
            alert("è³‡æ–™åº«é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥ç¶²è·¯æˆ– Configã€‚");
        }

        // --- 3. Firebase èªæ³•ç›¸å®¹å±¤ (Adapter) ---
        // è§£æ±º s.exists is not a function ä¸¦å¢åŠ éŒ¯èª¤è™•ç†
        const wrapSnapshot = (snap) => {
            if (!snap) return null;
            if (snap.docs) return snap; // QuerySnapshot
            return {
                id: snap.id,
                ref: snap.ref,
                metadata: snap.metadata,
                data: () => snap.data(),
                exists: () => snap.exists, // ä¿®æ­£é»ï¼šå°‡å±¬æ€§è½‰ç‚ºå‡½å¼
                _original: snap
            };
        };

        const collection = (dbInstance, ...pathSegments) => {
            if (!dbInstance) return null;
            return dbInstance.collection(pathSegments.join('/'));
        };
        
        const doc = (dbInstance, ...pathSegments) => {
            if (!dbInstance) return null;
            // è™•ç† db æˆ– collection reference
            return dbInstance.doc ? dbInstance.doc(pathSegments.join('/')) : db.doc(pathSegments.join('/'));
        };

        const setDoc = async (docRef, data, options) => {
            if (!docRef) return;
            return docRef.set(data, options);
        };

        const updateDoc = async (docRef, data) => {
            if (!docRef) return;
            return docRef.update(data);
        };

        const deleteDoc = async (docRef) => {
            if (!docRef) return;
            return docRef.delete();
        };

        const addDoc = async (collRef, data) => {
            if (!collRef) return;
            return collRef.add(data);
        };

        const writeBatch = (dbInstance) => dbInstance.batch();

        // å®‰å…¨çš„ onSnapshotï¼ŒåŒ…å«éŒ¯èª¤æ””æˆª
        const onSnapshot = (ref, callback) => {
            if (!ref) return () => {};
            return ref.onSnapshot(
                (snap) => callback(wrapSnapshot(snap)),
                (error) => {
                    console.warn("Firestore è®€å–å¤±æ•— (å¯èƒ½æ˜¯æ¬Šé™æˆ–è·¯å¾‘ä¸å­˜åœ¨):", error);
                    // ä¸æ‹‹å‡ºéŒ¯èª¤ï¼Œé¿å… React å´©æ½°
                }
            );
        };

        const signInAnonymously = (authInstance) => authInstance.signInAnonymously();
        const onAuthStateChanged = (authInstance, callback) => authInstance.onAuthStateChanged(callback);
        const initializeFirestore = () => db;
        const getAuth = () => auth;

        const defaultAppId = 'default-app-id';
        const CSV_HEADER = "æ—¥æœŸ,æ´»å‹•åç¨±,è¬›å¸«,å®¢æˆ¶å§“å,é‡‘é¡,äº¤é€šæ–¹å¼,èº«åˆ†è­‰å­—è™Ÿ,ç”Ÿæ—¥,Email,å ±åç®¡é“,ç¤¾ç¾¤æš±ç¨±,å‚™è¨»,è¨‚è³¼æ—¥,æ‰‹æ©Ÿ,å ±åˆ°ç‹€æ…‹";
        
        // --- UI Components ---
        const Logo = ({ className }) => {
            return (
                <div className={`flex items-center justify-center ${className}`}>
                    {/* ç§»é™¤æ­£æ–¹å½¢é™åˆ¶èˆ‡ç‰¹æ•ˆï¼Œæ”¹ç‚ºé«˜åº¦å›ºå®šã€å¯¬åº¦è‡ªå‹•ï¼Œé¡¯ç¤ºå®Œæ•´åŸåœ– */}
                    <img src="LOGOä¿®å¾©æª”.png" className="h-8 w-auto object-contain" alt="Logo" />
                </div>
            );
        };

        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);
            useEffect(() => {
                if (!window.lucide) return;
                const { icons, createElement } = window.lucide;
                const iconName = name.split('-').map(part => part.charAt(0).toUpperCase() + part.slice(1)).join('');
                const iconNode = icons[iconName];
                if (iconNode && containerRef.current) {
                    containerRef.current.innerHTML = '';
                    const svgElement = createElement(iconNode);
                    svgElement.setAttribute('width', size);
                    svgElement.setAttribute('height', size);
                    const existingClass = svgElement.getAttribute('class') || '';
                    svgElement.setAttribute('class', `${existingClass} ${className}`.trim());
                    containerRef.current.appendChild(svgElement);
                }
            }, [name, size, className]);
            return <span ref={containerRef} className="inline-flex items-center justify-center shrink-0"></span>;
        };

        // --- Constants & Helpers ---
        const DebugPanel = ({ onClose }) => (
            <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4">
                <div className="bg-white p-6 rounded-xl shadow-2xl max-w-sm w-full">
                    <h3 className="font-bold text-lg mb-2">ç³»çµ±ç‹€æ…‹</h3>
                    <div className="bg-slate-100 p-3 rounded text-xs font-mono text-slate-600 mb-4">
                        Status: Online (Safe Mode)<br/>Version: 3.5.0<br/>Firebase: Compat
                    </div>
                    <button onClick={onClose} className="w-full bg-slate-800 text-white py-2 rounded-lg text-sm">é—œé–‰</button>
                </div>
            </div>
        );

        const DEFAULT_TASKS_TEMPLATE = [
            { id: 'insurance', type: 'insurance', name: 'è¾¦ç†ä¿éšª', fields: [{ label: 'ä¿å–®è™Ÿç¢¼', value: '' }], completed: false },
            { id: 'pre_letter', type: 'pre_letter', name: 'å¯„é€è¡Œå‰ä¿¡', fields: [{ label: 'å¯„é€æ—¥æœŸ', value: '' }], completed: false },
            { id: 'post_letter', type: 'post_letter', name: 'å¯„é€èŠ±çµ®ä¿¡', fields: [{ label: 'ç…§ç‰‡é€£çµ', value: '' }], completed: false },
        ];

        const DEFAULT_STATUS_RULES = [
            { min: 0, max: 10, label: 'å ±åä¸­', color: 'green' },
            { min: 11, max: 20, label: 'æœ€å¾Œå¸­æ¬¡', color: 'orange' },
            { min: 21, max: 999, label: 'å·²é¡æ»¿', color: 'red' }
        ];

        const COLOR_OPTIONS = [
            { value: 'blue', label: 'è—è‰² (æ­£å¸¸)', bg: 'bg-blue-50', border: 'border-blue-100', text: 'text-blue-600', hover: 'hover:bg-blue-100' },
            { value: 'green', label: 'ç¶ è‰² (å……è¶³)', bg: 'bg-green-50', border: 'border-green-100', text: 'text-green-600', hover: 'hover:bg-green-100' },
            { value: 'orange', label: 'æ©˜è‰² (ç·Šå¼µ)', bg: 'bg-orange-50', border: 'border-orange-100', text: 'text-orange-600', hover: 'hover:bg-orange-100' },
            { value: 'red', label: 'ç´…è‰² (æ»¿å“¡)', bg: 'bg-red-50', border: 'border-red-100', text: 'text-red-600', hover: 'hover:bg-red-100' },
            { value: 'purple', label: 'ç´«è‰² (ç‰¹åˆ¥)', bg: 'bg-purple-50', border: 'border-purple-100', text: 'text-purple-600', hover: 'hover:bg-purple-100' },
            { value: 'slate', label: 'ç°è‰² (æˆªæ­¢)', bg: 'bg-slate-50', border: 'border-slate-200', text: 'text-slate-500', hover: 'hover:bg-slate-100' },
        ];

        const TASK_GROUP_COLORS = [
            { border: 'border-blue-200', bg: 'bg-blue-50', text: 'text-blue-800', icon: 'text-blue-500' },
            { border: 'border-emerald-200', bg: 'bg-emerald-50', text: 'text-emerald-800', icon: 'text-emerald-500' },
            { border: 'border-amber-200', bg: 'bg-amber-50', text: 'text-amber-800', icon: 'text-amber-500' },
            { border: 'border-purple-200', bg: 'bg-purple-50', text: 'text-purple-800', icon: 'text-purple-500' },
            { border: 'border-rose-200', bg: 'bg-rose-50', text: 'text-rose-800', icon: 'text-rose-500' },
            { border: 'border-cyan-200', bg: 'bg-cyan-50', text: 'text-cyan-800', icon: 'text-cyan-500' },
        ];

        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const toCSVField = (text) => {
            if (!text) return '';
            const str = String(text);
            if (str.includes(',') || str.includes('"') || str.includes('\n')) {
                return `"${str.replace(/"/g, '""')}"`;
            }
            return str;
        };

        const getTaskStatusStyle = (taskType, eventDateStr) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(eventDateStr);
            const diffTime = target.getTime() - today.getTime();
            const daysDiff = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            if (taskType === 'insurance') {
                if (daysDiff <= 3 && daysDiff >= 0) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'æ€¥è¿«' };
                if (daysDiff < 0) return { color: 'text-slate-400', bg: 'bg-slate-100', border: 'border-slate-200', label: 'å·²é' };
                return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: 'å¾…è¾¦' };
            }
            if (taskType === 'post_letter') {
                const daysSinceEvent = -daysDiff; 
                if (daysSinceEvent < 1) return { color: 'text-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', label: 'æœªé–‹å§‹' };
                if (daysSinceEvent === 1) return { color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200', label: 'å»ºè­°å¯„é€' };
                if (daysSinceEvent >= 3) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'å»¶é²' };
            }
            return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: '' };
        };

        const getPromiseStatus = (date, time) => {
            if (!date) return { status: 'normal', color: 'text-slate-600', bg: 'bg-white' };
            const now = new Date();
            const dueStr = time ? `${date}T${time}` : `${date}T23:59`;
            const due = new Date(dueStr);
            const diffMs = due - now;
            const diffHrs = diffMs / (1000 * 60 * 60);
            if (diffMs < 0) return { status: 'overdue', color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'å·²éæœŸ' };
            if (diffHrs < 24) return { status: 'urgent', color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200', label: '24hå…§' };
            return { status: 'future', color: 'text-green-700', bg: 'bg-green-50', border: 'border-green-200', label: 'é€²è¡Œä¸­' };
        };

        // [ä¿®æ”¹] æ”¯æ´æ—¥æœŸåˆ¤æ–·(å·²çµæŸ)èˆ‡å…¨åŸŸè¦å‰‡
        const getEventStatus = (count, capacity, config, dateStr, globalRules) => {
            // 1. åˆ¤æ–·æ˜¯å¦éæœŸ
            if (dateStr) {
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                const evtDate = new Date(dateStr);
                if (evtDate < today) {
                    return { label: 'ğŸ”š å·²çµæŸ', color: 'slate', colorObj: COLOR_OPTIONS.find(c => c.value === 'slate'), isFull: true, isEnded: true };
                }
            }
            // 2. åˆ¤æ–·æ˜¯å¦é¡æ»¿
            if (capacity > 0 && count >= capacity) {
                return { label: 'ğŸˆµ å·²é¡æ»¿', color: 'slate', colorObj: COLOR_OPTIONS.find(c => c.value === 'slate'), isFull: true };
            }
            // 3. åˆ¤æ–·è‡ªå®šç¾©è¦å‰‡ (å„ªå…ˆæ¬Š: æ´»å‹•å€‹åˆ¥è¨­å®š > å…¨åŸŸè¨­å®š > ç³»çµ±é è¨­)
            const rules = (config && config.statusRules && config.statusRules.length > 0) ? config.statusRules : (globalRules || DEFAULT_STATUS_RULES);
            
            const matchedRule = rules.find(r => count >= parseInt(r.min) && count <= parseInt(r.max));
            
            if (matchedRule) {
                const colorObj = COLOR_OPTIONS.find(c => c.value === matchedRule.color) || COLOR_OPTIONS[0];
                return { label: matchedRule.label, color: matchedRule.color, colorObj, isFull: false };
            }
            return { label: 'å ±åä¸­', color: 'blue', colorObj: COLOR_OPTIONS[0], isFull: false };
        };

        const downloadCSV = (csvContent, filename = 'export.csv') => {
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
        };

        const NavItem = ({ id, icon, label, activeTab, setActiveTab, onClick }) => (
            <button onClick={() => { setActiveTab(id); if(onClick) onClick(); }} className={`flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 w-full text-left ${activeTab === id ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'text-slate-500 hover:bg-white hover:shadow-sm'}`}>
                <Icon name={icon} size={20} />
                <span className="font-medium tracking-wide">{label}</span>
            </button>
        );

        // --- Modals ---
        const LoginModal = ({ onClose, onLogin }) => {
            const [password, setPassword] = useState('');
            const [error, setError] = useState(false);
            const handleSubmit = (e) => { e.preventDefault(); onLogin(password, (isSuccess) => { if (!isSuccess) setError(true); }); };
            return (
                <div className="fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-sm p-8 shadow-2xl"><div className="flex flex-col items-center mb-6"><div className="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 mb-3"><Icon name="lock" size={24} /></div><h3 className="text-xl font-bold text-slate-800">ç®¡ç†å“¡ç™»å…¥</h3><p className="text-sm text-slate-500">è«‹è¼¸å…¥å¯†ç¢¼ä»¥å­˜å–å¾Œå°</p></div><form onSubmit={handleSubmit} className="space-y-4"><div><input type="password" className={`w-full p-3 border rounded-xl outline-none transition-all text-center tracking-widest font-bold text-lg ${error ? 'border-red-500 bg-red-50' : 'border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200'}`} placeholder="è¼¸å…¥å¯†ç¢¼" value={password} onChange={e => { setPassword(e.target.value); setError(false); }} autoFocus />{error && <p className="text-red-500 text-xs text-center mt-2">å¯†ç¢¼éŒ¯èª¤ï¼Œè«‹é‡è©¦</p>}</div><div className="flex gap-2"><button type="button" onClick={onClose} className="flex-1 py-2 text-slate-500 hover:bg-slate-100 rounded-lg transition-colors">å–æ¶ˆ</button><button type="submit" className="flex-1 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-bold shadow-md transition-colors">ç™»å…¥</button></div></form></div></div>
            );
        };

        const AddPromiseModal = ({ onClose, onSave }) => {
            const [form, setForm] = useState({ content: '', who: '', date: new Date().toISOString().split('T')[0], time: '12:00' });
            return (<div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl"><div className="flex justify-between items-center mb-6"><h3 className="text-xl font-bold text-slate-800 flex items-center gap-2"><Icon name="message-square" className="text-purple-500"/> æ–°å¢æ‰¿è«¾</h3><button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button></div><div className="space-y-4"><div><label className="block text-xs font-bold text-slate-500 mb-1">å…§å®¹</label><textarea className="w-full p-3 border rounded-xl resize-none h-24" value={form.content} onChange={e=>setForm({...form, content: e.target.value})}></textarea></div><div><label className="block text-xs font-bold text-slate-500 mb-1">å°è±¡</label><input type="text" className="w-full p-3 border rounded-xl" value={form.who} onChange={e=>setForm({...form, who: e.target.value})} /></div><div className="grid grid-cols-2 gap-3"><input type="date" className="w-full p-3 border rounded-xl" value={form.date} onChange={e=>setForm({...form, date: e.target.value })} /><input type="time" className="w-full p-3 border rounded-xl" value={form.time} onChange={e=>setForm({...form, time: e.target.value })} /></div><button onClick={()=>{if(!form.content)return;onSave(form)}} className="w-full py-3 bg-purple-600 text-white rounded-xl font-bold shadow-lg shadow-purple-200 mt-2">å»ºç«‹</button></div></div></div>);
        };

        const InstructorScheduleModal = ({ date, availableInstructors, restingList, onClose, onToggle }) => {
            return (<div className="fixed inset-0 bg-black/50 z-[90] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl"><div className="flex justify-between items-center mb-4"><h3 className="text-lg font-bold text-slate-800 flex items-center gap-2"><Icon name="calendar-days" className="text-blue-600"/> {date} æ’ç­</h3><button onClick={onClose}><Icon name="x" className="text-slate-400"/></button></div><p className="text-xs text-slate-500 mb-4">é»æ“Šåˆ‡æ›ä¸Šå·¥ç‹€æ…‹ (ğŸ”´ ä¼‘å‡ / ğŸŸ¢ å¯ä¸Šå·¥)</p><div className="space-y-2 max-h-60 overflow-y-auto">{availableInstructors.map(name => { const isResting = restingList.includes(name); return (<div key={name} onClick={() => onToggle(date, name)} className={`flex justify-between items-center p-3 rounded-xl border cursor-pointer transition-all ${isResting ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'}`}><span className={`font-bold ${isResting ? 'text-red-700' : 'text-green-700'}`}>{name}</span><span className={`text-xs px-2 py-1 rounded-full font-bold ${isResting ? 'bg-red-100 text-red-600' : 'bg-green-100 text-green-600'}`}>{isResting ? 'ä¼‘å‡' : 'å¯ä¸Šå·¥'}</span></div>); })} {availableInstructors.length === 0 && <div className="text-center text-slate-400 py-4">æš«ç„¡è¬›å¸«è³‡æ–™ï¼Œè«‹å…ˆå»ºç«‹æ´»å‹•æˆ–æ‰‹å‹•è¼¸å…¥ã€‚</div>}</div><div className="mt-4 pt-4 border-t flex justify-end"><button onClick={onClose} className="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm">å®Œæˆ</button></div></div></div>);
        };
// [æ–°å¢] å…¨åŸŸç‹€æ…‹è¦å‰‡è¨­å®šè¦–çª—
        const GlobalRulesModal = ({ currentRules, onClose, onSave }) => {
            const [rules, setRules] = useState(currentRules || DEFAULT_STATUS_RULES);
            const [newRule, setNewRule] = useState({ min: 0, max: 10, label: '', color: 'blue' });

            const addRule = () => {
                if (!newRule.label) return alert("è«‹è¼¸å…¥é¡¯ç¤ºæ–‡å­—");
                const updated = [...rules, newRule].sort((a,b) => parseInt(a.min) - parseInt(b.min));
                setRules(updated);
                setNewRule({ min: parseInt(newRule.max) + 1, max: parseInt(newRule.max) + 10, label: '', color: 'blue' });
            };
            const removeRule = (idx) => setRules(rules.filter((_, i) => i !== idx));

            return (
                <div className="fixed inset-0 bg-black/50 z-[100] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-md p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="text-lg font-bold text-slate-800">è¨­å®šå…¨åŸŸé è¨­ç‹€æ…‹è¦å‰‡</h3>
                            <button onClick={onClose}><Icon name="x" className="text-slate-400"/></button>
                        </div>
                        <p className="text-xs text-slate-500 mb-4 bg-yellow-50 p-2 rounded text-yellow-700">æ³¨æ„ï¼šé€™è£¡çš„è¨­å®šå°‡å¥—ç”¨åˆ°ã€Œæœªå€‹åˆ¥è¨­å®šè¦å‰‡ã€çš„æ‰€æœ‰æ´»å‹•ã€‚å¦‚æœæ‚¨åœ¨å€‹åˆ¥æ´»å‹•ä¸­è¨­å®šäº†è¦å‰‡ï¼Œå°‡ä»¥å€‹åˆ¥æ´»å‹•ç‚ºæº–ã€‚</p>
                        
                        <div className="bg-slate-50 p-3 rounded-lg border border-slate-200 mb-4">
                            <div className="space-y-2 mb-3 max-h-60 overflow-y-auto">
                                {rules.map((rule, idx) => (
                                    <div key={idx} className="flex items-center gap-2 text-xs bg-white p-2 rounded border">
                                        <span className="w-16 text-center bg-slate-100 rounded py-1">{rule.min}-{rule.max}äºº</span>
                                        <span className={`flex-1 px-2 py-1 rounded text-center ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.bg} ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.text}`}>{rule.label}</span>
                                        <button onClick={()=>removeRule(idx)} className="text-slate-400 hover:text-red-500"><Icon name="trash-2" size={14}/></button>
                                    </div>
                                ))}
                            </div>
                            <div className="grid grid-cols-4 gap-2 items-end border-t pt-2 border-slate-200">
                                <div><span className="text-[10px] text-slate-400">Min</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.min} onChange={e=>setNewRule({...newRule, min: e.target.value})}/></div>
                                <div><span className="text-[10px] text-slate-400">Max</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.max} onChange={e=>setNewRule({...newRule, max: e.target.value})}/></div>
                                <div className="col-span-2"><span className="text-[10px] text-slate-400">æ–‡å­—</span><input type="text" className="w-full p-1 text-xs border rounded" placeholder="å¦‚: ç†±è³£ä¸­" value={newRule.label} onChange={e=>setNewRule({...newRule, label: e.target.value})}/></div>
                                <div className="col-span-3"><span className="text-[10px] text-slate-400">é¡è‰²</span><select className="w-full p-1 text-xs border rounded" value={newRule.color} onChange={e=>setNewRule({...newRule, color: e.target.value})}>{COLOR_OPTIONS.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}</select></div>
                                <button onClick={addRule} className="h-[26px] bg-slate-800 text-white text-xs rounded hover:bg-slate-700">æ–°å¢</button>
                            </div>
                        </div>
                        <div className="flex justify-end gap-2">
                            <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg text-sm">å–æ¶ˆ</button>
                            <button onClick={()=>onSave(rules)} className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm shadow-md">å„²å­˜è¨­å®š</button>
                        </div>
                    </div>
                </div>
            );
        };
        // EventManagerModal with Status Rules Editor
        // [ä¿®æ”¹] æ¥æ”¶ globalRules åƒæ•¸
        // [ä¿®æ”¹] æ´»å‹•ç®¡ç†è¦–çª—ï¼šå¢åŠ  onEditCustomer åƒæ•¸ï¼Œä¸¦åœ¨åå–®å³å´åŠ å…¥ç·¨è¼¯æŒ‰éˆ•
        const EventManagerModal = ({ event, config, onClose, onSaveConfig, availableInstructors, instructorSchedule, onCheckInToggle, onDeleteEvent, globalRules, onEditCustomer }) => {
            const [capacity, setCapacity] = useState(config?.capacity || 20);
            const [eventNote, setEventNote] = useState(config?.note || '');
            const [eventTime, setEventTime] = useState(config?.time || '');
            const [eventLink, setEventLink] = useState(config?.link || '');
            const [displayName, setDisplayName] = useState(config?.displayName || '');
            const [tasks, setTasks] = useState(config?.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE)));
            const [instructors, setInstructors] = useState(event.instructor ? event.instructor.split(/[&,]/).map(s=>s.trim()) : []);
            const [tempInstructor, setTempInstructor] = useState('');
            const [statusRules, setStatusRules] = useState(config?.statusRules || globalRules || DEFAULT_STATUS_RULES);
            const [newRule, setNewRule] = useState({ min: 0, max: 10, label: '', color: 'blue' });

            const sortedCustomers = useMemo(() => {
                if (!event.customers) return [];
                return [...event.customers].sort((a, b) => {
                    if (a.transport === 'å…±ä¹˜' && b.transport !== 'å…±ä¹˜') return -1;
                    if (a.transport !== 'å…±ä¹˜' && b.transport === 'å…±ä¹˜') return 1;
                    return 0;
                });
            }, [event.customers]);
            const carpoolCount = event.customers ? event.customers.filter(c => c.transport === 'å…±ä¹˜').length : 0;
            const checkedInCount = event.customers ? event.customers.filter(c => c.isCheckedIn).length : 0;

            const handleTaskToggle = (index) => { const newTasks = [...tasks]; newTasks[index].completed = !newTasks[index].completed; setTasks(newTasks); };
            const handleAddTask = () => { const name = prompt("ä»»å‹™åç¨±:"); if(name) setTasks([...tasks, { id: `custom_${Date.now()}`, name, fields: [], completed: false }]); };
            const handleDeleteTask = (index) => { if(confirm("åˆªé™¤?")) { const n=[...tasks]; n.splice(index,1); setTasks(n); } };
            const addInstructor = (name) => { const clean = name.trim(); if(!clean) return; const isResting = instructorSchedule[event.date] && instructorSchedule[event.date].includes(clean); if (isResting) { if(!confirm(`${clean} åœ¨ ${event.date} å·²æ’ä¼‘ï¼Œç¢ºå®šè¦æ’å…¥å—ï¼Ÿ`)) return; } if (!instructors.includes(clean)) setInstructors([...instructors, clean]); setTempInstructor(''); };
            const removeInstructor = (name) => { setInstructors(instructors.filter(i => i !== name)); };
            const addStatusRule = () => { if (!newRule.label) return alert("è«‹è¼¸å…¥é¡¯ç¤ºæ–‡å­—"); const updatedRules = [...statusRules, newRule].sort((a,b) => parseInt(a.min) - parseInt(b.min)); setStatusRules(updatedRules); setNewRule({ min: parseInt(newRule.max) + 1, max: parseInt(newRule.max) + 10, label: '', color: 'blue' }); };
            const removeStatusRule = (idx) => { setStatusRules(statusRules.filter((_, i) => i !== idx)); };

            const handleSave = () => { 
                const newInstructorStr = instructors.join(' & ');
                onSaveConfig({ capacity: parseInt(capacity), tasks, note: eventNote, time: eventTime, link: eventLink, statusRules, displayName: displayName }, newInstructorStr); 
                onClose(); 
            };
            const handleExportList = () => {
                let csv = "\uFEFFå§“å,æ‰‹æ©Ÿ,Email,èº«åˆ†è­‰å­—è™Ÿ,ç”Ÿæ—¥,äº¤é€š,å‚™è¨»,å ±åˆ°ç‹€æ…‹\n";
                sortedCustomers.forEach(c => { const status = c.isCheckedIn ? 'å·²å ±åˆ°' : 'æœªå ±åˆ°'; csv += `${c.customerName},${c.phone},${c.email},${c.idNo},${c.birthday},${c.transport},${toCSVField(c.notes)},${status}\n`; });
                downloadCSV(csv, `${event.eventName}_${event.date}_åå–®.csv`);
            };
            const progress = Math.round((tasks.filter(t => t.completed).length / Math.max(tasks.length, 1)) * 100);

            return (
                <div className="fixed inset-0 bg-black/50 z-[70] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl m-auto">
                        <div className="p-6 border-b border-slate-100 flex justify-between items-center">
                            <div><div className="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded mb-1 inline-block">{event.date}</div><h3 className="text-xl font-bold text-slate-800">{event.eventName}</h3></div><button onClick={onClose}><Icon name="x" className="text-slate-400 hover:text-slate-600"/></button>
                        </div>
                        <div className="p-6 overflow-y-auto space-y-6">
                            <section>
                                <h4 className="font-bold text-slate-700 mb-2 flex items-center"><Icon name="user" size={18} className="mr-2"/> å¸¶åœ˜è¬›å¸«</h4>
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200">
                                    <div className="flex flex-wrap gap-2 mb-2">{instructors.map(ins=><div key={ins} className="flex items-center bg-white text-blue-700 px-2 py-1 rounded-md text-sm border border-blue-100 shadow-sm"><span className="mr-1">{ins}</span><button onClick={()=>removeInstructor(ins)}><Icon name="x" size={14} className="text-slate-400 hover:text-red-500"/></button></div>)}{instructors.length===0 && <span className="text-xs text-slate-400 py-1">æœªæŒ‡å®šè¬›å¸«</span>}</div>
                                    <div className="flex gap-2 mb-2"><input type="text" className="flex-1 px-3 py-1.5 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" value={tempInstructor} onChange={e=>setTempInstructor(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addInstructor(tempInstructor)} placeholder="è¼¸å…¥åå­—..."/><button onClick={()=>addInstructor(tempInstructor)} className="px-3 bg-blue-100 text-blue-600 rounded-lg hover:bg-blue-200"><Icon name="plus" size={16}/></button></div>
                                    <div className="flex flex-wrap gap-2">{availableInstructors.slice(0,5).map(i=><button key={i} onClick={()=>addInstructor(i)} className="text-xs px-2 py-1 bg-white border rounded-full hover:bg-blue-50 text-slate-600">+ {i}</button>)}</div>
                                </div>
                            </section>
                            <section>
                                <div className="flex justify-between items-center mb-3">
                                    <h4 className="font-bold text-slate-700 flex items-center"><Icon name="users" size={18} className="mr-2"/> å ±ååå–® ({checkedInCount}/{event.count})</h4>
                                    <div className="flex gap-2"><button onClick={handleExportList} className="text-xs bg-slate-800 text-white px-2 py-1 rounded hover:bg-slate-700 flex items-center"><Icon name="download" size={12} className="mr-1"/> åŒ¯å‡º</button><span className="text-xs font-bold text-orange-600 bg-orange-50 px-2 py-1 rounded-full flex items-center">å…±ä¹˜: {carpoolCount}</span></div>
                                </div>
                                <div className="bg-slate-50 p-3 rounded-xl border border-slate-200 max-h-60 overflow-y-auto">
                                    {sortedCustomers.length > 0 ? (
                                        <ul className="space-y-2">
                                            {sortedCustomers.map((c, i) => (
                                                <li key={i} className={`flex justify-between items-center text-sm p-2 rounded-lg ${c.transport === 'å…±ä¹˜' ? 'bg-white border border-orange-100 shadow-sm' : 'border-b border-slate-100'}`}>
                                                    <div className="flex items-center gap-3">
                                                        <button onClick={(e)=>{e.stopPropagation(); onCheckInToggle(c.id, c.isCheckedIn);}} className={`w-5 h-5 rounded flex items-center justify-center border transition-colors ${c.isCheckedIn ? 'bg-green-500 border-green-500 text-white' : 'bg-white border-slate-300 text-transparent hover:border-blue-400'}`}><Icon name="check" size={14} /></button>
                                                        <div className="flex flex-col"><span className={`font-medium ${c.isCheckedIn ? 'text-green-700' : 'text-slate-700'}`}>{c.customerName}</span><span className="text-[10px] text-slate-400">{c.phone || 'ç„¡æ‰‹æ©Ÿ'}</span></div>
                                                    </div>
                                                    <div className="flex items-center gap-2">
                                                        <div className="flex flex-col items-end">
                                                            {c.transport === 'å…±ä¹˜' && <span className="text-[10px] text-orange-500 flex items-center mb-0.5"><Icon name="car" size={10} className="mr-0.5"/> å…±ä¹˜</span>}
                                                            <span className="text-xs text-slate-400">{c.source || '-'}</span>
                                                        </div>
                                                        {c.isCheckedIn && <span className="text-[10px] bg-green-100 text-green-700 px-1.5 py-0.5 rounded">å·²å ±åˆ°</span>}
                                                        {/* [æ–°å¢] ç·¨è¼¯æŒ‰éˆ• */}
                                                        <button onClick={(e)=>{e.stopPropagation(); onEditCustomer(c);}} className="p-1.5 text-slate-400 hover:text-blue-600 hover:bg-blue-50 rounded-full transition-colors ml-1">
                                                            <Icon name="edit-2" size={14} />
                                                        </button>
                                                    </div>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : <div className="text-slate-400 text-center text-sm py-2">ç›®å‰å°šç„¡å ±å</div>}
                                </div>
                            </section>
                            <section>
                                <h4 className="font-bold text-slate-700 mb-3 flex items-center"><Icon name="settings" size={18} className="mr-2"/> æ´»å‹•è¨­å®š</h4>
                                <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-4">
                                    <div className="grid grid-cols-2 gap-4"><div><span className="text-slate-500 text-xs font-bold mb-1 block">æ´»å‹•æ™‚é–“</span><input type="time" value={eventTime} onChange={e=>setEventTime(e.target.value)} className="w-full px-2 py-1.5 text-center border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-white"/></div><div><span className="text-slate-500 text-xs font-bold mb-1 block">äººæ•¸ä¸Šé™</span><input type="number" value={capacity} onChange={e=>setCapacity(e.target.value)} className="w-full px-2 py-1.5 text-center border border-slate-300 rounded-lg font-bold outline-none focus:ring-2 focus:ring-blue-500 bg-white"/></div></div>
                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">å‰å°é¡¯ç¤ºåç¨±</label><input type="text" className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚: å†¬å­£å¤œè¨ªè›™é¡" value={displayName} onChange={e=>setDisplayName(e.target.value)} /></div>
                                    <div className="bg-white border border-slate-200 rounded-lg p-3"><label className="text-xs font-bold text-slate-500 mb-2 block flex justify-between"><span>è‡ªå®šç¾©ç‹€æ…‹è¦å‰‡ (ä¾ç…§äººæ•¸é¡¯ç¤º)</span><span className="text-[10px] bg-slate-100 px-1 rounded font-normal">å¾ä¸Šåˆ°ä¸‹åŒ¹é…</span></label><div className="space-y-2 mb-3">{statusRules.map((rule, idx) => (<div key={idx} className="flex items-center gap-2 text-xs"><span className="w-12 text-center bg-slate-100 rounded py-1">{rule.min}-{rule.max}äºº</span><span className={`flex-1 px-2 py-1 rounded border text-center ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.bg} ${COLOR_OPTIONS.find(c=>c.value===rule.color)?.text}`}>{rule.label}</span><button onClick={()=>removeStatusRule(idx)} className="text-slate-400 hover:text-red-500"><Icon name="trash-2" size={14}/></button></div>))}</div><div className="grid grid-cols-4 gap-2 items-end bg-slate-50 p-2 rounded border border-slate-100"><div><span className="text-[10px] text-slate-400">Min</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.min} onChange={e=>setNewRule({...newRule, min: e.target.value})}/></div><div><span className="text-[10px] text-slate-400">Max</span><input type="number" className="w-full p-1 text-xs border rounded" value={newRule.max} onChange={e=>setNewRule({...newRule, max: e.target.value})}/></div><div className="col-span-2"><span className="text-[10px] text-slate-400">é¡¯ç¤ºæ–‡å­—</span><input type="text" className="w-full p-1 text-xs border rounded" placeholder="å¦‚: å ±åä¸­" value={newRule.label} onChange={e=>setNewRule({...newRule, label: e.target.value})}/></div><div className="col-span-2"><span className="text-[10px] text-slate-400">é¡è‰²</span><select className="w-full p-1 text-xs border rounded" value={newRule.color} onChange={e=>setNewRule({...newRule, color: e.target.value})}>{COLOR_OPTIONS.map(c=><option key={c.value} value={c.value}>{c.label}</option>)}</select></div><div className="col-span-2"><button onClick={addStatusRule} className="w-full py-1 bg-slate-800 text-white text-xs rounded hover:bg-slate-700">æ–°å¢è¦å‰‡</button></div></div></div>
                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">æ´»å‹•å ±åé€£çµ</label><input type="text" className="w-full px-3 py-2 text-sm border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://..." value={eventLink} onChange={e=>setEventLink(e.target.value)} /></div>
                                    <div><label className="text-xs font-bold text-slate-500 mb-1 block">æ´»å‹•å°ˆå±¬å‚™è¨»</label><textarea className="w-full p-2 border border-slate-300 rounded-lg text-sm h-20 resize-none focus:ring-2 focus:ring-blue-500 outline-none" placeholder="ä¾‹å¦‚: è¨˜å¾—å¸¶ç„¡ç·šé›»..." value={eventNote} onChange={e=>setEventNote(e.target.value)}></textarea></div>
                                </div>
                            </section>
                            <section>
                                <div className="flex justify-between items-center mb-2"><h4 className="font-bold text-slate-700 flex items-center"><Icon name="check-square" size={18} className="mr-2"/> åŸ·è¡Œä»»å‹™</h4><button onClick={handleAddTask} className="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200 flex items-center"><Icon name="plus" size={14} className="mr-1"/> æ–°å¢</button></div>
                                <div className="w-full h-1.5 bg-slate-100 rounded-full mb-4 overflow-hidden"><div className="h-full bg-green-500 transition-all duration-500" style={{width: `${progress}%`}}></div></div>
                                <div className="space-y-2">{tasks.map((t, i) => (<div key={i} className="flex items-center justify-between p-2.5 border border-slate-200 rounded-lg hover:bg-slate-50 group"><div className="flex items-center gap-3 cursor-pointer" onClick={()=>handleTaskToggle(i)}><div className={`w-4 h-4 rounded border flex items-center justify-center ${t.completed ? 'bg-green-500 border-green-500 text-white' : 'border-slate-300'}`}>{t.completed && <Icon name="check" size={12}/>}</div><span className={`text-sm ${t.completed ? 'text-slate-400 line-through' : 'text-slate-700 font-medium'}`}>{t.name}</span></div><button onClick={()=>handleDeleteTask(i)} className="text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100 transition-opacity"><Icon name="trash-2" size={14}/></button></div>))}</div>
                            </section>
                        </div>
                        <div className="p-4 border-t border-slate-100 bg-slate-50/50 rounded-b-2xl flex justify-between items-center">
                            <button onClick={onDeleteEvent} className="px-4 py-2 text-red-600 hover:bg-red-50 rounded-lg flex items-center gap-1 font-bold text-sm">
                                <Icon name="trash-2" size={16}/> åˆªé™¤æ­¤æ´»å‹•
                            </button>
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                                <button onClick={handleSave} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md">å„²å­˜è¨­å®š</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        // CreateEventModal 
        const CreateEventModal = ({ onClose, onSave, customTemplates, onSaveTemplate, onDeleteTemplate, availableInstructors, instructorSchedule }) => {
            const [mode, setMode] = useState('template'); 
            const [isCreatingTemplate, setIsCreatingTemplate] = useState(false); 
            const [calendarMonth, setCalendarMonth] = useState(new Date()); 
            const [formData, setFormData] = useState({ dates: [], eventName: '', instructors: [], time: '', link: '', displayName: '' }); 
            const [tempInstructor, setTempInstructor] = useState(''); 
            const [newTemplateData, setNewTemplateData] = useState({ id: null, name: '', eventName: '', instructor: '', time: '', link: '', displayName: '' });
            const unavailableInstructors = useMemo(() => { const unavailable = new Set(); formData.dates.forEach(date => { const resting = instructorSchedule[date] || []; resting.forEach(name => unavailable.add(name)); }); return unavailable; }, [formData.dates, instructorSchedule]);
            const handleTemplateSelect = (tpl) => { let tplInstructors = []; if (tpl.instructor) tplInstructors = tpl.instructor.split(/[&,]/).map(s => s.trim()); setFormData({ ...formData, eventName: tpl.eventName, instructors: tplInstructors, time: tpl.time || '', link: tpl.link || '', displayName: tpl.displayName || '' }); };
            const handleEditTemplate = (e, tpl) => { e.stopPropagation(); setNewTemplateData({ id: tpl.id, name: tpl.name, eventName: tpl.eventName, instructor: tpl.instructor, time: tpl.time || '', link: tpl.link || '', displayName: tpl.displayName || '' }); setIsCreatingTemplate(true); };
            const toggleDate = (year, month, day) => { const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`; let newDates = formData.dates.includes(dateStr) ? formData.dates.filter(d => d !== dateStr) : [...formData.dates, dateStr].sort(); setFormData({ ...formData, dates: newDates }); };
            const addInstructor = (name) => { const clean = name.trim(); const isResting = formData.dates.some(d => instructorSchedule[d] && instructorSchedule[d].includes(clean)); if (isResting) { if(!confirm(`${clean} åœ¨éƒ¨åˆ†é¸å®šçš„æ—¥æœŸå·²æ’ä¼‘ï¼Œç¢ºå®šè¦æ’å…¥å—ï¼Ÿ`)) return; } if (clean && !formData.instructors.includes(clean)) setFormData({ ...formData, instructors: [...formData.instructors, clean] }); setTempInstructor(''); };
            const removeInstructor = (name) => { setFormData({ ...formData, instructors: formData.instructors.filter(i => i !== name) }); };
            const handleSubmitEvent = () => { if (formData.dates.length === 0) { alert("è«‹è‡³å°‘é¸æ“‡ä¸€å€‹æ—¥æœŸ"); return; } onSave(formData); };
            const handleSaveNewTemplate = () => { if (!newTemplateData.name) { alert("è«‹è¼¸å…¥æ¨¡æ¿åç¨±"); return; } onSaveTemplate(newTemplateData); setIsCreatingTemplate(false); setNewTemplateData({ id: null, name: '', eventName: '', instructor: '', time: '', link: '', displayName: '' }); };
            const renderCalendar = () => { const year = calendarMonth.getFullYear(); const month = calendarMonth.getMonth(); const daysInMonth = getDaysInMonth(year, month); const firstDay = getFirstDayOfMonth(year, month); const days = Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1)); return ( <div className="bg-slate-50 p-4 rounded-xl border border-slate-200"> <div className="flex justify-between items-center mb-4"> <button onClick={() => setCalendarMonth(new Date(year, month - 1))}><Icon name="chevron-left" size={20}/></button> <span className="font-bold text-slate-700">{year}å¹´ {month + 1}æœˆ</span> <button onClick={() => setCalendarMonth(new Date(year, month + 1))}><Icon name="chevron-right" size={20}/></button> </div> <div className="grid grid-cols-7 text-center mb-2 text-xs font-bold text-slate-400">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}</div> <div className="grid grid-cols-7 gap-1"> {days.map((day, i) => ( <div key={i} className="aspect-square flex items-center justify-center"> {day && (<button onClick={() => toggleDate(year, month, day)} className={`w-8 h-8 rounded-full text-sm transition-all ${formData.dates.includes(`${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')}`) ? 'bg-blue-600 text-white shadow-md' : 'hover:bg-blue-100 text-slate-600'}`}>{day}</button>)} </div> ))} </div> </div> ); };
            return ( <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm"> <div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl m-auto"> <div className="p-6 border-b border-slate-100 flex justify-between items-center"><h3 className="text-xl font-bold flex items-center gap-2"><Icon name="zap" className="text-yellow-500"/> å¿«é€Ÿé–‹åœ˜</h3><button onClick={onClose}><Icon name="x" className="text-slate-400"/></button></div> <div className="p-6 overflow-y-auto space-y-6"> {!isCreatingTemplate ? ( <> <div className="flex bg-slate-100 p-1 rounded-lg"><button onClick={()=>setMode('template')} className={`flex-1 py-1.5 text-sm rounded-md transition-all ${mode==='template'?'bg-white shadow text-blue-600':'text-slate-500'}`}>ä½¿ç”¨æ¨¡æ¿</button><button onClick={()=>setMode('custom')} className={`flex-1 py-1.5 text-sm rounded-md transition-all ${mode==='custom'?'bg-white shadow text-blue-600':'text-slate-500'}`}>å®Œå…¨è‡ªè¨‚</button></div> {mode === 'template' && ( 
                <div className="grid grid-cols-3 gap-3"> {customTemplates.length === 0 && <div className="col-span-3 text-center text-slate-400 text-sm py-4">å°šç„¡æ¨¡æ¿ï¼Œè«‹é»æ“Šä¸‹æ–¹æ–°å¢</div>} {[...customTemplates].map((tpl, i) => ( <div key={i} onClick={()=>handleTemplateSelect(tpl)} className={`relative border rounded-xl p-3 cursor-pointer text-center hover:bg-blue-50 transition-all group ${formData.eventName===tpl.eventName?'border-blue-500 ring-1 ring-blue-500 bg-blue-50':'border-slate-200'}`}> <div className="font-bold text-slate-700 text-sm mb-1">{tpl.name}</div><div className="text-xs text-slate-500">{tpl.instructor}</div><div className="text-[10px] text-slate-400 mt-1">{tpl.time ? `â° ${tpl.time}` : ''}</div> <button onClick={(e)=>handleEditTemplate(e, tpl)} className="absolute top-1 right-1 p-1 bg-white rounded-full shadow-sm text-slate-300 hover:text-blue-500 opacity-0 group-hover:opacity-100 transition"><Icon name="edit-2" size={12}/></button> </div> ))} <button onClick={()=>setIsCreatingTemplate(true)} className="border border-dashed border-slate-300 rounded-xl p-3 flex flex-col items-center justify-center text-slate-400 hover:border-blue-400 hover:text-blue-500 hover:bg-blue-50 transition-all"><Icon name="plus-circle" className="mb-1"/><span className="text-xs">æ–°å¢æ¨¡æ¿</span></button> </div> 
            )} <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t border-slate-100"> <div><label className="block text-sm font-medium text-slate-700 mb-2">1. é¸æ“‡æ—¥æœŸ (å¤šé¸)</label>{renderCalendar()}</div> <div className="space-y-4"> <div><label className="block text-sm font-medium text-slate-700 mb-1">2. æ´»å‹•åç¨±</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={formData.eventName} onChange={e=>setFormData({...formData, eventName: e.target.value})} placeholder="è¼¸å…¥åç¨±..."/></div> <div> <label className="block text-sm font-medium text-slate-700 mb-1">3. å¸¶åœ˜è¬›å¸«</label> <div className="flex flex-wrap gap-2 mb-2 min-h-[38px] p-2 bg-white border border-slate-200 rounded-lg">{formData.instructors.map(ins=><div key={ins} className="flex items-center bg-blue-50 text-blue-700 px-2 py-1 rounded text-sm"><span className="mr-1">{ins}</span><button onClick={()=>setFormData({...formData, instructors: formData.instructors.filter(i=>i!==ins)})}><Icon name="x" size={14}/></button></div>)}</div> <div className="flex gap-2"><input type="text" className="flex-1 px-3 py-2 border border-slate-300 rounded-lg text-sm outline-none focus:ring-2 focus:ring-blue-500" value={tempInstructor} onChange={e=>setTempInstructor(e.target.value)} onKeyDown={e=>e.key==='Enter'&&addInstructor(tempInstructor)} placeholder="è¼¸å…¥åå­—..."/><button onClick={()=>addInstructor(tempInstructor)} className="px-3 bg-slate-100 rounded-lg hover:bg-slate-200"><Icon name="plus" size={18}/></button></div> <div className="flex flex-wrap gap-2 mt-2">{availableInstructors.slice(0,6).map(i=><button key={i} onClick={()=>addInstructor(i)} className={`text-xs px-2 py-1 border rounded-full transition ${unavailableInstructors.has(i)?'bg-slate-100 text-slate-400 border-slate-200':'bg-slate-50 hover:bg-blue-50 text-slate-600'}`}>+ {i}</button>)}</div> </div> <div><label className="block text-sm font-medium text-slate-700 mb-1">4. æ´»å‹•æ™‚é–“</label><input type="time" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={formData.time} onChange={e=>setFormData({...formData, time: e.target.value})}/></div><div><label className="block text-sm font-medium text-slate-700 mb-1">5. æ´»å‹•ç¶²å€ (é¸å¡«)</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="https://..." value={formData.link} onChange={e=>setFormData({...formData, link: e.target.value})}/></div><div><label className="block text-sm font-medium text-slate-700 mb-1">6. å‰å°é¡¯ç¤ºåç¨± (é¸å¡«)</label><input type="text" className="w-full px-3 py-2 border border-slate-300 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="ä¾‹å¦‚: å†¬å­£å¤œè¨ªè›™é¡" value={formData.displayName} onChange={e=>setFormData({...formData, displayName: e.target.value})}/></div></div> </div> </> ) : ( <div className="bg-slate-50 p-4 rounded-xl border border-slate-200 space-y-3"> <div className="flex justify-between"><h4 className="font-bold">{newTemplateData.id ? 'ç·¨è¼¯æ¨¡æ¿' : 'å»ºç«‹æ–°æ¨¡æ¿'}</h4><button onClick={()=>{setIsCreatingTemplate(false);setNewTemplateData({id:null,name:'',eventName:'',instructor:'',time:'',link:'',displayName:''})}} className="text-sm text-slate-500">å–æ¶ˆ</button></div> <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="æ¨¡æ¿åç¨± (å¦‚: è±ªè¯åœ˜)" value={newTemplateData.name} onChange={e=>setNewTemplateData({...newTemplateData, name: e.target.value})}/> <div className="grid grid-cols-2 gap-3"> <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="é è¨­æ´»å‹•åç¨±" value={newTemplateData.eventName} onChange={e=>setNewTemplateData({...newTemplateData, eventName: e.target.value})}/> <input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="é è¨­è¬›å¸«" value={newTemplateData.instructor} onChange={e=>setNewTemplateData({...newTemplateData, instructor: e.target.value})}/> </div> <div className="grid grid-cols-2 gap-3"><div><label className="block text-xs font-bold text-slate-500 mb-1">é è¨­æ™‚é–“</label><input type="time" className="w-full px-3 py-2 text-sm border rounded-lg" value={newTemplateData.time} onChange={e=>setNewTemplateData({...newTemplateData, time: e.target.value})}/></div><div><label className="block text-xs font-bold text-slate-500 mb-1">é è¨­ç¶²å€</label><input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="https://..." value={newTemplateData.link} onChange={e=>setNewTemplateData({...newTemplateData, link: e.target.value})}/></div></div><div><label className="block text-xs font-bold text-slate-500 mb-1">é è¨­å‰å°åç¨±</label><input type="text" className="w-full px-3 py-2 text-sm border rounded-lg" placeholder="ä¾‹å¦‚: å†¬å­£å¤œè¨ªè›™é¡" value={newTemplateData.displayName} onChange={e=>setNewTemplateData({...newTemplateData, displayName: e.target.value})}/></div><div className="flex gap-2">{newTemplateData.id && <button onClick={()=>{if(confirm("ç¢ºå®šåˆªé™¤?")){onDeleteTemplate(newTemplateData.id);setIsCreatingTemplate(false);setNewTemplateData({id:null,name:'',eventName:'',instructor:'',time:'',link:'',displayName:''})}}} className="flex-1 py-2 bg-red-100 text-red-600 rounded-lg text-sm">åˆªé™¤</button>}<button onClick={handleSaveNewTemplate} className="flex-[2] py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm">å„²å­˜æ¨¡æ¿</button></div> </div> )} </div> {!isCreatingTemplate && <div className="p-4 border-t border-slate-100 flex justify-end items-center gap-4 bg-slate-50/50 rounded-b-2xl"><span className="text-xs text-slate-500">å°‡å»ºç«‹ {formData.dates.length} å ´æ´»å‹•</span><button onClick={()=>onSave(formData)} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-medium shadow-md">æ‰¹é‡å»ºç«‹</button></div>} </div> </div> );
        };

        const TaskDetailModal = ({ task, eventData, onClose }) => { return <div className="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-lg flex flex-col max-h-[90vh] shadow-2xl"><div className="p-6 border-b flex justify-between items-center"><div><div className="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-0.5 rounded inline-block mb-1">{eventData.date}</div><h3 className="text-xl font-bold">{task.name}</h3></div><button onClick={onClose}><Icon name="x"/></button></div><div className="p-6 overflow-y-auto"><div className="text-center text-slate-500 py-8">ä»»å‹™è©³ç´°å…§å®¹åŠŸèƒ½å€ (å¯åœ¨æ­¤æ“´å……)</div></div></div></div>; };
        const MonthlyReport = ({ month, data }) => { const [expanded, setExpanded] = useState(false); const stats = useMemo(() => { const rev = data.reduce((a,c)=>a+c.price,0); const pax = data.length; const sources = {}; const activities = {}; data.forEach(c => { sources[c.source || 'æœªçŸ¥'] = (sources[c.source || 'æœªçŸ¥'] || 0) + 1; if (!activities[c.eventName]) { activities[c.eventName] = { count: 0, revenue: 0, dates: new Set() }; } activities[c.eventName].count += 1; activities[c.eventName].revenue += c.price; if (c.date) activities[c.eventName].dates.add(c.date + c.instructor); }); return { rev, pax, sources, activities }; }, [data]); return ( <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden mb-4 transition-all"> <div className="p-4 flex justify-between items-center cursor-pointer hover:bg-slate-50" onClick={()=>setExpanded(!expanded)}> <div className="flex items-center gap-4"> <div className="text-lg font-bold text-slate-700">{month}</div> <div className="text-sm text-slate-500 bg-slate-100 px-2 py-0.5 rounded">ç¸½æ”¶ ${stats.rev.toLocaleString()}</div> <div className="text-sm text-slate-500">({stats.pax} äºº)</div> </div> <Icon name={expanded ? 'chevron-up' : 'chevron-down'} className="text-slate-400"/> </div> {expanded && ( <div className="p-4 border-t border-slate-100 bg-slate-50/50 animate-in fade-in space-y-6"> <div> <h5 className="text-xs font-bold text-slate-500 mb-3 uppercase flex items-center"><Icon name="activity" size={14} className="mr-1"/> å„é …æ´»å‹•è¡¨ç¾</h5> <div className="bg-white border border-slate-200 rounded-xl overflow-hidden"> <table className="w-full text-left text-sm"> <thead className="bg-slate-50 border-b border-slate-100 text-slate-500"><tr><th className="px-4 py-2">æ´»å‹•åç¨±</th><th className="px-4 py-2">å ´æ¬¡</th><th className="px-4 py-2">äººæ•¸</th><th className="px-4 py-2">å¹³å‡äººæ•¸</th><th className="px-4 py-2 text-right">ç‡Ÿæ”¶</th></tr></thead> <tbody className="divide-y divide-slate-100"> {Object.entries(stats.activities).map(([name, s], i) => { const sessionCount = s.dates.size || 1; return (<tr key={i} className="hover:bg-slate-50"><td className="px-4 py-2 font-medium text-slate-700">{name}</td><td className="px-4 py-2 text-slate-500">{sessionCount}</td><td className="px-4 py-2 text-slate-500">{s.count}</td><td className="px-4 py-2 text-slate-500">{(s.count / sessionCount).toFixed(1)}</td><td className="px-4 py-2 text-right font-mono text-slate-600">${s.revenue.toLocaleString()}</td></tr>); })} </tbody> </table> </div> </div> <div> <h5 className="text-xs font-bold text-slate-500 mb-2 uppercase flex items-center"><Icon name="share-2" size={14} className="mr-1"/> å ±åç®¡é“åˆ†æ</h5> <div className="flex flex-wrap gap-2">{Object.entries(stats.sources).map(([src, count]) => (<div key={src} className="text-xs px-3 py-1.5 bg-white border rounded-lg shadow-sm flex gap-2"><span className="text-slate-600">{src}</span><span className="font-bold text-blue-600">{count}</span><span className="text-slate-400">({Math.round(count/stats.pax*100)}%)</span></div>))}</div> </div> <div className="flex justify-end pt-2"><button onClick={(e)=>{e.stopPropagation(); downloadCSV(data.map(d=>Object.values(d).join(',')).join('\n'), `${month}_report.csv`)}} className="text-xs text-blue-600 hover:underline flex items-center bg-blue-50 px-3 py-1.5 rounded border border-blue-100"><Icon name="download" size={12} className="mr-1"/> ä¸‹è¼‰æ­¤æœˆè©³ç´°å ±è¡¨</button></div> </div> )} </div> ); };
        // [ä¿®æ”¹] ç·¨è¼¯è¦–çª—ï¼šäº¤é€šæ–¹å¼æ”¹ç‚ºå‹¾é¸å¼ (Toggle)ï¼Œä¸¦ä¿ç•™åˆªé™¤åŠŸèƒ½
        const EditRowModal = ({ rowData, onClose, onSave, onDelete, existingTransports }) => { 
            const [form, setForm] = useState({ ...rowData }); 
            
            // åˆ‡æ›äº¤é€šæ–¹å¼çš„å‡½å¼
            const toggleTransport = () => {
                setForm(prev => ({
                    ...prev,
                    transport: prev.transport === 'å…±ä¹˜' ? 'è‡ªè¡Œå‰å¾€' : 'å…±ä¹˜'
                }));
            };

            return (
                <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                    <div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
                        <div className="flex justify-between items-center mb-6">
                            <h3 className="text-xl font-bold">ç·¨è¼¯å ±åè³‡æ–™</h3>
                            <button onClick={onClose}><Icon name="x"/></button>
                        </div>
                        
                        <div className="space-y-4 max-h-[70vh] overflow-y-auto p-1"> 
                            {/* ç¬¬ä¸€åˆ—ï¼šæ—¥æœŸèˆ‡æ´»å‹•åç¨± */}
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-xs font-bold">æ—¥æœŸ</label><input type="date" className="w-full p-2 border rounded" value={form.date} onChange={e=>setForm({...form, date:e.target.value})}/></div>
                                <div><label className="text-xs font-bold">æ´»å‹•åç¨±</label><input type="text" className="w-full p-2 border rounded" value={form.eventName} onChange={e=>setForm({...form, eventName:e.target.value})}/></div>
                            </div> 
                            
                            {/* ç¬¬äºŒåˆ—ï¼šå®¢æˆ¶å§“å */}
                            <div><label className="text-xs font-bold">å®¢æˆ¶å§“å</label><input type="text" className="w-full p-2 border rounded" value={form.customerName} onChange={e=>setForm({...form, customerName:e.target.value})}/></div> 
                            
                            {/* ç¬¬ä¸‰åˆ—ï¼šé‡‘é¡èˆ‡äº¤é€š (äº¤é€šæ”¹ç‚ºå‹¾é¸å¼æŒ‰éˆ•) */}
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-xs font-bold">é‡‘é¡</label><input type="number" className="w-full p-2 border rounded" value={form.price} onChange={e=>setForm({...form, price:e.target.value})}/></div>
                                
                                {/* [ä¿®æ”¹é‡é»] äº¤é€šæ–¹å¼ï¼šæ”¹ç‚ºå‹¾é¸æŒ‰éˆ•æ¨£å¼ */}
                                <div>
                                    <label className="text-xs font-bold mb-1.5 block">äº¤é€š</label>
                                    <div 
                                        onClick={toggleTransport}
                                        className={`w-full p-2 border rounded cursor-pointer flex items-center gap-2 select-none transition-all ${
                                            form.transport === 'å…±ä¹˜' 
                                            ? 'bg-orange-50 border-orange-300 shadow-sm' 
                                            : 'bg-white border-slate-300 hover:bg-slate-50'
                                        }`}
                                    >
                                        <div className={`w-5 h-5 rounded border flex items-center justify-center transition-all flex-shrink-0 ${
                                            form.transport === 'å…±ä¹˜' 
                                            ? 'bg-orange-500 border-orange-500 text-white' 
                                            : 'bg-white border-slate-300'
                                        }`}>
                                            {form.transport === 'å…±ä¹˜' && <Icon name="check" size={14} />}
                                        </div>
                                        <span className={`text-sm ${form.transport === 'å…±ä¹˜' ? 'text-orange-700 font-bold' : 'text-slate-500'}`}>
                                            {form.transport === 'å…±ä¹˜' ? 'å…±ä¹˜' : 'è‡ªè¡Œå‰å¾€'}
                                        </span>
                                    </div>
                                </div>
                            </div> 
                            
                            {/* ç¬¬å››åˆ—ï¼šEmailèˆ‡æ‰‹æ©Ÿ */}
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-xs font-bold">Email</label><input type="email" className="w-full p-2 border rounded" value={form.email||''} onChange={e=>setForm({...form, email:e.target.value})}/></div>
                                <div><label className="text-xs font-bold">æ‰‹æ©Ÿ</label><input type="text" className="w-full p-2 border rounded" value={form.phone||''} onChange={e=>setForm({...form, phone:e.target.value})}/></div>
                            </div> 
                            
                            {/* ç¬¬äº”åˆ—ï¼šè¨‚è³¼æ—¥èˆ‡èº«åˆ†è­‰ */}
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-xs font-bold">è¨‚è³¼æ—¥</label><input type="date" className="w-full p-2 border rounded" value={form.orderDate||''} onChange={e=>setForm({...form, orderDate:e.target.value})}/></div>
                                <div><label className="text-xs font-bold">èº«åˆ†è­‰</label><input type="text" className="w-full p-2 border rounded" value={form.idNo||''} onChange={e=>setForm({...form, idNo:e.target.value})}/></div>
                            </div> 
                            
                            {/* ç¬¬å…­åˆ—ï¼šç”Ÿæ—¥èˆ‡ç¤¾ç¾¤æš±ç¨± */}
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-xs font-bold">ç”Ÿæ—¥</label><input type="date" className="w-full p-2 border rounded" value={form.birthday||''} onChange={e=>setForm({...form, birthday:e.target.value})}/></div>
                                <div><label className="text-xs font-bold">ç¤¾ç¾¤æš±ç¨±</label><input type="text" className="w-full p-2 border rounded" value={form.socialName||''} onChange={e=>setForm({...form, socialName:e.target.value})}/></div>
                            </div> 
                            
                            {/* ç¬¬ä¸ƒåˆ—ï¼šå ±åç®¡é“èˆ‡å‚™è¨» */}
                            <div className="grid grid-cols-2 gap-3">
                                <div><label className="text-xs font-bold">å ±åç®¡é“</label><input type="text" className="w-full p-2 border rounded" value={form.source||''} onChange={e=>setForm({...form, source:e.target.value})}/></div>
                                <div><label className="text-xs font-bold">å‚™è¨»</label><input type="text" className="w-full p-2 border rounded" value={form.notes||''} onChange={e=>setForm({...form, notes:e.target.value})}/></div>
                            </div> 
                        </div>
                        
                        <div className="flex justify-between mt-6 pt-4 border-t border-slate-100">
                            <button onClick={()=>onDelete(rowData.id)} className="px-4 py-2 text-red-500 hover:bg-red-50 rounded-lg flex items-center gap-1 font-bold text-xs">
                                <Icon name="trash-2" size={14}/> åˆªé™¤è³‡æ–™
                            </button>
                            <div className="flex gap-2">
                                <button onClick={onClose} className="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg">å–æ¶ˆ</button>
                                <button onClick={()=>onSave(form)} className="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 shadow-md">å„²å­˜è®Šæ›´</button>
                            </div>
                        </div>
                    </div>
                </div>
            ); 
        };
        const BulkImportModal = ({ onClose, onImport, existingData }) => { return <div className="fixed inset-0 bg-black/50 z-[80] flex items-center justify-center p-4 fade-in backdrop-blur-sm"><div className="bg-white rounded-2xl w-full max-w-2xl h-[85vh] flex flex-col shadow-2xl"><div className="p-6 border-b flex justify-between items-center"><h3 className="text-xl font-bold">æ‰¹é‡åŒ¯å…¥åŠŸèƒ½é–‹ç™¼ä¸­...</h3><button onClick={onClose}><Icon name="x"/></button></div><div className="p-8 text-center text-slate-500">æ­¤åŠŸèƒ½å³å°‡æ¨å‡ºï¼Œæ•¬è«‹æœŸå¾…</div></div></div>; };
        const DataRescueTab = ({ currentAppId, onSwitch }) => { const options = [ { id: 'crm-system-v1', label: 'v1 (æ‚¨çš„çœŸå¯¦è³‡æ–™)' }, { id: 'default-app-id', label: 'Default (èˆŠç‰ˆæ¸¬è©¦)' } ]; return ( <div className="bg-white p-6 rounded-2xl shadow-sm border border-orange-200"> <div className="flex items-start gap-4"> <div className="bg-orange-100 p-3 rounded-full text-orange-600"><Icon name="life-buoy" size={24}/></div> <div className="flex-1"> <h3 className="text-xl font-bold text-slate-800 mb-2">è³‡æ–™åº«æ•‘æ´æ§åˆ¶å°</h3> <p className="text-sm text-slate-500 mb-4">å¦‚æœæ‚¨ç™¼ç¾è³‡æ–™éºå¤±ï¼Œè«‹å˜—è©¦åˆ‡æ›ä¸‹æ–¹çš„è³‡æ–™ä¾†æºã€‚é€™é€šå¸¸ç™¼ç”Ÿåœ¨ç³»çµ±æ›´æ–°å¾Œã€‚</p> <div className="grid grid-cols-1 md:grid-cols-2 gap-4"> {options.map(opt => ( <div key={opt.id} onClick={() => onSwitch(opt.id)} className={`p-4 rounded-xl border cursor-pointer transition-all flex justify-between items-center ${currentAppId === opt.id ? 'bg-orange-50 border-orange-400 ring-1 ring-orange-400' : 'hover:bg-slate-50 border-slate-200'}`} > <div> <div className="font-bold text-slate-700">{opt.label}</div> <div className="text-xs text-slate-400 font-mono">{opt.id}</div> </div> {currentAppId === opt.id && <Icon name="check-circle" className="text-orange-500" size={20}/>} </div> ))} </div> </div> </div> </div> ); };

        const MainApp = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('events'); 
            const [loading, setLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);
            const [showDebug, setShowDebug] = useState(false);
            const [showCreateEvent, setShowCreateEvent] = useState(false);
            const [showAddPromise, setShowAddPromise] = useState(false); 
            const [showBulkImport, setShowBulkImport] = useState(false); 
            const [showScheduleModal, setShowScheduleModal] = useState(false); 
            const [scheduleDate, setScheduleDate] = useState(''); 
            const [editingEvent, setEditingEvent] = useState(null); 
            const [editingRow, setEditingRow] = useState(null); 
            const [eventsViewMode, setEventsViewMode] = useState('calendar');
            const [importSearch, setImportSearch] = useState(''); 
            const [promiseSearch, setPromiseSearch] = useState(''); // [è£œå›] æ‰¿è«¾ç‰†æœå°‹
            const [publicSearchTerm, setPublicSearchTerm] = useState(''); // [è£œå›] å‰å°æœå°‹
            const [globalRules, setGlobalRules] = useState(null); // [æ–°å¢] å…¨åŸŸè¦å‰‡ç‹€æ…‹
            const [showGlobalRules, setShowGlobalRules] = useState(false); // [æ–°å¢] é¡¯ç¤ºè¦å‰‡è¦–çª—
            const [selectedPublicDate, setSelectedPublicDate] = useState(new Date().toISOString().split('T')[0]);

            const [dbSource, setDbSource] = useState(() => localStorage.getItem('crm_db_source') || defaultAppId);

            const [isEditingCSV, setIsEditingCSV] = useState(false);
            const isEditingRef = useRef(false);

            const [csvInput, setCsvInput] = useState('');
            const [parsedData, setParsedData] = useState([]);
            const [eventConfigs, setEventConfigs] = useState({});
            const [customTemplates, setCustomTemplates] = useState([]);
            const [projects, setProjects] = useState([]); 
            const [promises, setPromises] = useState([]);
            const [instructorSchedule, setInstructorSchedule] = useState({}); 
            
            const [newPasswordInput, setNewPasswordInput] = useState('');
            const [passwordSaveStatus, setPasswordSaveStatus] = useState('idle'); 
            const [addRegStatus, setAddRegStatus] = useState('idle'); 
            const [csvSaveStatus, setCsvSaveStatus] = useState('idle');

            const [viewMode, setViewMode] = useState('public');
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [adminPassword, setAdminPassword] = useState('');

            const [activeTaskDetail, setActiveTaskDetail] = useState(null);
            const [selectedCustomer, setSelectedCustomer] = useState('');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [crmSearchTerm, setCrmSearchTerm] = useState('');
            const [showCrmDropdown, setShowCrmDropdown] = useState(false);
            const [newReg, setNewReg] = useState({
                date: new Date().toISOString().split('T')[0], eventName: '', instructor: '', customerName: '', 
                price: '', transport: '', idNo: '', birthday: '', email: '', source: '', orderDate: new Date().toISOString().split('T')[0], phone: ''
            });
            
            const [mobileMenuOpen, setMobileMenuOpen] = useState(false);
            
            const handleDbSourceChange = (newSource) => {
                setDbSource(newSource);
                localStorage.setItem('crm_db_source', newSource);
            };

            const uniqueTransports = useMemo(() => {
                const defaults = ['å…±ä¹˜', 'è‡ªè¡Œå‰å¾€'];
                const existing = new Set(parsedData.map(r => r.transport).filter(Boolean));
                return Array.from(new Set([...defaults, ...existing]));
            }, [parsedData]);

            useEffect(() => {
                if (auth) {
                    signInAnonymously(auth).catch(console.error);
                    return onAuthStateChanged(auth, u => setUser(u));
                } else {
                    // Demo Mode / No DB
                    setUser({ isAnonymous: true, uid: 'demo' });
                }
            }, []);

            useEffect(() => {
                if (!user) return;
                setLoading(true);
                const basePath = `artifacts/${dbSource}/public/data`;
                
                if (db) {
                    // Normal Firestore Mode
                    const settingsRef = doc(db, basePath, 'settings', 'auth');
                    if (settingsRef) {
                        // We try to listen, if it fails, the wrapper logs error and we proceed
                        onSnapshot(settingsRef, s => {
                            if (s && s.exists()) {
                                setAdminPassword(s.data().password || '8888');
                            } else {
                                setAdminPassword('8888'); 
                            }
                        });
                    }

                    const updateParsedData = (raw) => {
                        try {
                            const lines = raw.trim().split('\n');
                            const data = lines.slice(1).map((line, i) => {
                                const v = line.split(',');
                                if(v.length < 5) return null;
                                return {
                                    id: i, date: v[0]?.trim(), eventName: v[1]?.trim(), instructor: v[2]?.trim(),
                                    customerName: v[3]?.trim(), price: parseInt(v[4])||0, transport: v[5]?.trim(),
                                    idNo: v[6]?.trim(), birthday: v[7]?.trim(), email: v[8]?.trim(), source: v[9]?.trim(),
                                    socialName: v[10]?.trim(), notes: v[11]?.trim(), orderDate: v[12]?.trim(), phone: v[13]?.trim(),
                                    isCheckedIn: v[14]?.trim() === '1' 
                                };
                            }).filter(Boolean);
                            setParsedData(data);
                        } catch(e) { console.error(e); }
                    };

                    const mainRef = doc(db, basePath, 'settings', 'main');
                    const unsub1 = onSnapshot(mainRef, s => {
                        if(s && s.exists()) {
                            const data = s.data();
                            const d = data.csvData || '';
                            // [æ–°å¢] è®€å–å…¨åŸŸè¦å‰‡
                            if (data.globalRules) setGlobalRules(data.globalRules);
                            
                            if (!isEditingRef.current) {
                                setCsvInput(d);
                                updateParsedData(d);
                            }
                        }
                        setLoading(false);
                    });
                    
                    const templatesRef = doc(db, basePath, 'settings', 'templates');
                    const unsub2 = onSnapshot(templatesRef, s => {
                        if(s && s.exists()) setCustomTemplates(s.data()?.list || [])
                    });
                    
                    const configsRef = collection(db, basePath, 'event_configs');
                    const unsub3 = onSnapshot(configsRef, s => {
                        const cfgs = {}; 
                        if(s) s.forEach(d => cfgs[d.id] = d.data()); 
                        setEventConfigs(cfgs);
                    });
                    
                    const projectsRef = collection(db, basePath, 'projects');
                    const unsub4 = onSnapshot(projectsRef, s => {
                        const p = []; 
                        if(s) s.forEach(d => p.push({id: d.id, ...d.data()})); 
                        setProjects(p);
                    });
                    
                    const promisesRef = collection(db, basePath, 'promises');
                    const unsub5 = onSnapshot(promisesRef, s => { 
                        const p = []; 
                        if(s) s.forEach(d => p.push({id: d.id, ...d.data()})); 
                        setPromises(p.sort((a,b) => new Date(a.date+'T'+a.time) - new Date(b.date+'T'+b.time)));
                    });
                    
                    const scheduleRef = doc(db, basePath, 'settings', 'schedule');
                    const unsub6 = onSnapshot(scheduleRef, s => {
                        if (s && s.exists()) setInstructorSchedule(s.data().resting || {});
                    });

                    return () => { 
                        if(unsub1) unsub1(); 
                        if(unsub2) unsub2(); 
                        if(unsub3) unsub3(); 
                        if(unsub4) unsub4(); 
                        if(unsub5) unsub5(); 
                        if(unsub6) unsub6(); 
                    };
                } else {
                    // No DB Mode (Safe Fallback)
                    setLoading(false);
                    console.warn("Running in offline/demo mode");
                }
            }, [user, dbSource]);

            const handleVerifyLogin = (inputPwd, callback) => {
                if (inputPwd === adminPassword) {
                    setViewMode('admin');
                    setShowLoginModal(false);
                    callback(true);
                } else {
                    callback(false);
                }
            };

            const handleUpdatePassword = async () => {
                if (!newPasswordInput) return;
                setPasswordSaveStatus('saving');
                try {
                    const ref = doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'auth');
                    if(ref) await setDoc(ref, { password: newPasswordInput }, { merge: true });
                    setNewPasswordInput('');
                    setPasswordSaveStatus('success');
                    setTimeout(() => setPasswordSaveStatus('idle'), 2000);
                } catch (e) {
                    console.error("Password update failed", e);
                    setPasswordSaveStatus('idle'); 
                }
            };

            const handleToggleInstructorRest = async (date, name) => { if (!user || !db) return; const currentResting = instructorSchedule[date] || []; let newResting; if (currentResting.includes(name)) { newResting = currentResting.filter(n => n !== name); } else { newResting = [...currentResting, name]; } const newSchedule = { ...instructorSchedule }; if (newResting.length > 0) { newSchedule[date] = newResting; } else { delete newSchedule[date]; } await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'schedule'), { resting: newSchedule }, { merge: true }); };
            
            const handleSaveCSV = async (newData) => { 
                if(!user || !db) return; 
                setCsvSaveStatus('saving'); 
                setIsSaving(true); 
                try { 
                    isEditingRef.current = false; 
                    await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { csvData: newData }, { merge: true }); 
                    setCsvInput(newData); 
                    setCsvSaveStatus('success'); 
                    setTimeout(() => setCsvSaveStatus('idle'), 3000); 
                } catch(e) { 
                    console.error(e); 
                    setCsvSaveStatus('error'); 
                } finally { 
                    setIsSaving(false); 
                } 
            };

            const arrayToCSV = (dataArray) => { let csv = CSV_HEADER + '\n'; dataArray.forEach(row => { const check = row.isCheckedIn ? '1' : '0'; const line = `${row.date||''},${row.eventName||''},${row.instructor||''},${row.customerName||''},${row.price||0},${row.transport||''},${row.idNo||''},${row.birthday||''},${row.email||''},${row.source||''},${row.socialName||''},${toCSVField(row.notes)},${row.orderDate||''},${row.phone||''},${check}`; csv += line + '\n'; }); return csv; };
            const handleUpdateRow = async (newRowData) => { const newData = parsedData.map(row => row.id === newRowData.id ? newRowData : row); await handleSaveCSV(arrayToCSV(newData)); setEditingRow(null); };
            const handleDeleteRow = async (id) => { if(!confirm("ç¢ºå®šåˆªé™¤æ­¤ç­†è³‡æ–™ï¼Ÿ")) return; const newData = parsedData.filter(row => row.id !== id); await handleSaveCSV(arrayToCSV(newData)); };
            const handleBulkImport = async (newRows) => { const currentRows = [...parsedData]; const formattedNewRows = newRows.map(r => ({ date: r.date || '', eventName: r.eventName || '', instructor: r.instructor || '', customerName: r.customerName || '', price: r.price || 0, transport: '', idNo: r.idNo || '', birthday: r.birthday || '', email: r.email || '', source: r.source || '', socialName: r.socialName || '', notes: r.notes || '', orderDate: new Date().toISOString().split('T')[0], phone: r.phone || '' })); const finalData = [...currentRows, ...formattedNewRows]; await handleSaveCSV(arrayToCSV(finalData)); };
            
            const handleAddManualReg = async () => { 
                if(!newReg.date || !newReg.eventName || !newReg.customerName) { return; } 
                setAddRegStatus('saving');
                let currentData = csvInput.trim(); 
                if (!currentData || !currentData.startsWith("æ—¥æœŸ")) { currentData = CSV_HEADER + "\n" + currentData; } 
                const newRow = `\n${newReg.date},${newReg.eventName},${newReg.instructor},${newReg.customerName},${newReg.price},${newReg.transport},${newReg.idNo},${newReg.birthday},${newReg.email},${newReg.source},,${newReg.orderDate},${newReg.phone},0`; 
                const updatedCSV = currentData + newRow; 
                await handleSaveCSV(updatedCSV); 
                setNewReg({ date: '', eventName: '', instructor: '', customerName: '', price: '', transport: '', idNo: '', birthday: '', email: '', source: '', orderDate: new Date().toISOString().split('T')[0], phone: '' }); 
                setAddRegStatus('success');
                setTimeout(() => setAddRegStatus('idle'), 2000);
            };
            
            const handleCreateEvent = async ({ dates, eventName, instructors, time, link, displayName }) => { 
                let rows = '';
                const instr = instructors.join(' & ');
                dates.forEach(d => rows += `\n${d},${eventName},${instr},é–‹æ”¾å ±åä¸­,0,,,,,,,,,0`);
                await handleSaveCSV(csvInput + rows);
                const batch = writeBatch(db);
                dates.forEach(d => {
                    const key = `${d}_${eventName}_${instr}`.replace(/[\/\\#\?]/g, '-');
                    const ref = doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', key);
                    setDoc(ref, { time: time || '', link: link || '', displayName: displayName || '' }, { merge: true });
                });
                await batch.commit();
                setShowCreateEvent(false);
            };

            const handleCheckInToggle = async (customerId, currentStatus) => { const row = parsedData.find(r => r.id === customerId); if (row) { await handleUpdateRow({ ...row, isCheckedIn: !currentStatus }); } };
            const handleSaveEventConfig = async (oldEventKey, newConfig, newInstructorStr) => { const affectedRows = parsedData.filter(r => { const key = `${r.date}_${r.eventName}_${r.instructor}`.replace(/[\/\\#\?]/g, '-'); return key === oldEventKey; }); if (newInstructorStr !== undefined) { const newRows = parsedData.map(r => { const key = `${r.date}_${r.eventName}_${r.instructor}`.replace(/[\/\\#\?]/g, '-'); if (key === oldEventKey) { return { ...r, instructor: newInstructorStr }; } return r; }); await handleSaveCSV(arrayToCSV(newRows)); if (affectedRows.length > 0) { const evt = affectedRows[0]; const newKey = `${evt.date}_${evt.eventName}_${newInstructorStr}`.replace(/[\/\\#\?]/g, '-'); if (newKey !== oldEventKey) { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', newKey), newConfig, { merge: true }); } else { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', oldEventKey), newConfig, { merge: true }); } } } else { await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', oldEventKey), newConfig, { merge: true }); } };
            const handleSaveTemplate = (tpl) => { let newList; if (tpl.id) { newList = customTemplates.map(t => t.id === tpl.id ? t : t); } else { newList = [...customTemplates, { ...tpl, id: `custom_${Date.now()}` }]; } setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'templates'), { list: newList }, { merge: true }); };
            const handleAddTemplate = (tpl) => handleSaveTemplate(tpl);
            const onDeleteTemplate = (id) => { if(confirm("ç¢ºå®šåˆªé™¤?")) setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'templates'), { list: customTemplates.filter(t=>t.id!==id) }, { merge: true }); };
            const handleProjectStatus = async (pid, status) => { const next = status === 'Stuck' ? 'To Do' : status === 'To Do' ? 'In Progress' : status === 'In Progress' ? 'Done' : 'Stuck'; await updateDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', pid), { status: next }); };
            const handleAddProject = async () => { const name = prompt("å°ˆæ¡ˆåç¨±:"); if(name) await addDoc(collection(db, `artifacts/${dbSource}/public/data`, 'projects'), { name, owner: 'Team', status: 'To Do', deadline: new Date().toISOString().split('T')[0] }); };
            const handleDeleteProject = async (pid) => { if(confirm("åˆªé™¤å°ˆæ¡ˆ?")) await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'projects', pid)); };
            const handleAddPromise = async (data) => { await addDoc(collection(db, `artifacts/${dbSource}/public/data`, 'promises'), { ...data, status: 'pending', createdAt: new Date().toISOString() }); setShowAddPromise(false); };
            const handleTogglePromise = async (id, currentStatus) => { await updateDoc(doc(db, `artifacts/${dbSource}/public/data`, 'promises', id), { status: currentStatus === 'done' ? 'pending' : 'done' }); };
            const handleDeletePromise = async (id) => { if(confirm("åˆªé™¤æ­¤æ‰¿è«¾ï¼Ÿ")) await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'promises', id)); };

            const handleDeleteEvent = async () => {
                if (!editingEvent) return;
                const { date, eventName, instructor, key } = editingEvent;
                if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${date} ${eventName}ã€å—ï¼Ÿ\nâš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒåˆªé™¤è©²å ´æ¬¡çš„æ‰€æœ‰å ±åè³‡æ–™ï¼Œç„¡æ³•å¾©åŸï¼`)) return;
                
                const newRows = parsedData.filter(r => {
                    const rowKey = `${r.date}_${r.eventName}_${r.instructor}`.replace(/[\/\\#\?]/g, '-');
                    return rowKey !== key;
                });
                
                await handleSaveCSV(arrayToCSV(newRows));
                
                try {
                    await deleteDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', key));
                } catch(e) {
                    console.log('Config removal optional', e);
                }
                
                setEditingEvent(null);
            };

            const stats = useMemo(() => { const totalRev = parsedData.reduce((a,c) => a + c.price, 0); const events = {}; const instrs = {}; parsedData.forEach(c => { const key = `${c.date}_${c.eventName}_${c.instructor}`.replace(/[\/\\#\?]/g, '-'); if(!events[key]) events[key] = { ...c, count: 0, customers: [], key }; if(c.customerName !== 'é–‹æ”¾å ±åä¸­') { events[key].count++; events[key].customers.push(c); } if(c.instructor) c.instructor.split(/[&,]/).forEach(i => { const name = i.trim(); if(name && name !== 'æœªå®š') instrs[name] = (instrs[name]||0)+1; }); }); return { totalRev, totalPax: parsedData.length, events, instrs }; }, [parsedData]);
            const dashboardData = useMemo(() => { const now = new Date(); const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`; const monthlyGroups = {}; parsedData.forEach(c => { if (!c.date) return; const m = c.date.substring(0, 7); if (c.customerName === 'é–‹æ”¾å ±åä¸­') return; if (!monthlyGroups[m]) monthlyGroups[m] = []; monthlyGroups[m].push(c); }); const currentMonthData = monthlyGroups[currentMonthStr] || []; const currentMonthRev = currentMonthData.reduce((a,c)=>a+c.price,0); const currentMonthPax = currentMonthData.length; return { monthlyGroups, currentMonthRev, currentMonthPax }; }, [parsedData]);
            const tasks = useMemo(() => { const list = []; Object.values(stats.events).forEach(evt => { const cfg = eventConfigs[evt.key] || {}; const tList = cfg.tasks || DEFAULT_TASKS_TEMPLATE; tList.forEach((t, i) => { if(!t.completed) list.push({ ...t, taskIdx: i, evtDate: evt.date, evtName: evt.eventName, cfgKey: evt.key, style: getTaskStatusStyle(t.type, evt.date), fullEvent: evt }); }); }); return list.sort((a,b) => new Date(a.evtDate) - new Date(b.evtDate)); }, [stats.events, eventConfigs]);
            const toggleTask = async (key, idx) => { const cfg = eventConfigs[key] || {}; const tList = cfg.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE)); tList[idx].completed = !tList[idx].completed; await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'event_configs', key), { ...cfg, tasks: tList }, { merge: true }); };
            // --- [LTV é€²éšç‰ˆ] æ™‚é–“ç¯©é¸èˆ‡çµ±è¨ˆé‚è¼¯ ---
            const [ltvTimeframe, setLtvTimeframe] = useState('all'); // all, year, quarter, month

            const ltvStats = useMemo(() => {
                const now = new Date();
                const map = {}; // å®¢æˆ¶åç¨± -> é‡‘é¡
                const countMap = {}; // å®¢æˆ¶åç¨± -> æ¶ˆè²»æ¬¡æ•¸
                let periodRevenue = 0;
                let periodPax = 0;

                parsedData.forEach(d => {
                    const name = d.customerName;
                    if (!name || name === 'é–‹æ”¾å ±åä¸­') return;

                    // æ™‚é–“éæ¿¾
                    let include = true;
                    if (ltvTimeframe !== 'all') {
                        const date = new Date(d.date);
                        const diffTime = Math.abs(now - date);
                        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                        if (ltvTimeframe === 'year' && diffDays > 365) include = false;
                        if (ltvTimeframe === 'quarter' && diffDays > 90) include = false;
                        if (ltvTimeframe === 'month' && diffDays > 30) include = false;
                    }

                    if (include) {
                        const price = parseInt(d.price) || 0;
                        map[name] = (map[name] || 0) + price;
                        countMap[name] = (countMap[name] || 0) + 1;
                        periodRevenue += price;
                        periodPax++;
                    }
                });

                // æ’åºåå–®
                const sortedCustomers = Object.keys(map).sort((a, b) => map[b] - map[a]);
                const activeCustomerCount = sortedCustomers.length;
                const avgLtv = activeCustomerCount > 0 ? Math.round(periodRevenue / activeCustomerCount) : 0;

                // å…¨æ™‚æ®µç¸½é¡ (ç”¨æ–¼æœå°‹æ™‚é¡¯ç¤ºç¸½èº«åƒ¹)
                // ç‚ºäº†è®“æœå°‹æ¬„ä½ä¸ç®¡é¸å“ªå€‹æ™‚é–“éƒ½èƒ½é¡¯ç¤ºè©²å®¢æˆ¶çš„"ç¸½"èº«åƒ¹ï¼Œæˆ‘å€‘å¦å¤–ç®—ä¸€å€‹å…¨æ™‚æ®µ Map
                // ä½†ç‚ºäº†æ•ˆèƒ½ï¼Œé€™è£¡æš«æ™‚å¾©ç”¨é¡¯ç¤ºçš„æ•¸å€¼ï¼Œæˆ–è€…æ‚¨å¯ä»¥ä¿ç•™èˆŠçš„é‚è¼¯åšç‚ºå‚™ç”¨
                
                return { map, countMap, sortedCustomers, avgLtv, periodRevenue, activeCustomerCount };
            }, [parsedData, ltvTimeframe]);

            // æœå°‹éæ¿¾ (ä½¿ç”¨è¨ˆç®—å¾Œçš„åå–®)
            const filteredCrmCustomers = ltvStats.sortedCustomers.filter(c => c.toLowerCase().includes(crmSearchTerm.toLowerCase()));
            // ----------------------------------------
            const customerProfile = useMemo(() => { if (!selectedCustomer) return null; const history = parsedData.filter(d => d.customerName === selectedCustomer); const totalSpend = history.reduce((a,c)=>a+c.price,0); const avgSpend = history.length ? Math.round(totalSpend / history.length) : 0; const lastReg = history[history.length-1]; return { history, totalSpend, avgSpend, email: lastReg?.email, source: lastReg?.source, idNo: lastReg?.idNo, birthday: lastReg?.birthday, transport: lastReg?.transport, phone: lastReg?.phone, socialName: lastReg?.socialName, notes: lastReg?.notes, latestRecord: lastReg }; }, [selectedCustomer, parsedData]);
            const calendarDays = useMemo(() => { const year = currentDate.getFullYear(); const month = currentDate.getMonth(); const daysInMonth = getDaysInMonth(year, month); const firstDay = getFirstDayOfMonth(year, month); return Array(firstDay).fill(null).concat([...Array(daysInMonth).keys()].map(i => i + 1)); }, [currentDate]);
            const nextMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 1));
            const prevMonth = () => setCurrentDate(new Date(currentDate.getFullYear(), currentDate.getMonth() - 1, 1));

            const groupedTasks = useMemo(() => {
                return tasks.reduce((acc, task) => {
                    const groupKey = task.name; 
                    if (!acc[groupKey]) {
                        acc[groupKey] = [];
                    }
                    acc[groupKey].push(task);
                    return acc;
                }, {});
            }, [tasks]);

            // [ä¿®æ­£] å°‡è·¨æœˆä»½æœå°‹é‚è¼¯ç§»è‡³ loading åˆ¤æ–·ä¹‹å‰ï¼Œè§£æ±º Hook Error #310
            const matchingDates = useMemo(() => {
                if (!publicSearchTerm) return [];
                return Object.values(stats.events)
                    .filter(e => {
                        const cfg = eventConfigs[e.key] || {};
                        const nameToCheck = cfg.displayName || e.eventName; 
                        return nameToCheck.includes(publicSearchTerm) || (e.instructor && e.instructor.includes(publicSearchTerm));
                    })
                    .map(e => e.date)
                    .sort();
            }, [publicSearchTerm, stats.events, eventConfigs]);

            const matchingMonths = useMemo(() => {
                const months = new Set(matchingDates.map(d => d.substring(0, 7))); // "YYYY-MM"
                return Array.from(months);
            }, [matchingDates]);

            if(loading) return <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-400"><Icon name="loader-2" className="animate-spin mr-2"/> è¼‰å…¥ä¸­...</div>;
            
            const activeEditingEvent = editingEvent && stats.events[editingEvent.key] ? stats.events[editingEvent.key] : editingEvent;

            if (viewMode === 'public') {
                const selectedDayEvents = Object.values(stats.events).filter(e => e.date === selectedPublicDate);
                const currentMonthStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}`;

                return (
                    <div className="min-h-screen bg-white pb-20">
                        <nav className="glass-nav sticky top-0 z-50 px-6 py-4 flex justify-between items-center">
                            <Logo className="h-8 w-auto" />
                            <button 
                                onClick={() => setShowLoginModal(true)}
                                className="text-sm text-slate-500 hover:text-blue-600 flex items-center gap-1 px-3 py-1.5 rounded-lg hover:bg-slate-50 transition-colors"
                            >
                                <Icon name="lock" size={14}/> ç®¡ç†å“¡ç™»å…¥
                            </button>
                        </nav>
                        
                        {/* [æ–°å¢] å…è²¬è²æ˜ */}
                        <div className="bg-amber-50 text-amber-800 text-xs py-2 px-4 text-center font-bold border-b border-amber-100 flex items-center justify-center gap-2">
                             <Icon name="alert-circle" size={14}/> ç³»çµ±äººæ•¸æ›´æ–°å¯èƒ½æœ‰å»¶é²ï¼Œæº–ç¢ºåé¡è«‹ä»¥é»æ“Šã€Œå‰å¾€å ±åã€å¾Œçš„è¡¨å–®ç‚ºä¸»
                        </div>

                        <main className="max-w-2xl mx-auto p-6">
                            <div className="mb-6 text-center">
                                <h1 className="text-2xl font-bold text-slate-800 mb-2">æ´»å‹•å ´æ¬¡è¡¨</h1>
                                <p className="text-slate-500 text-sm">æ­¡è¿æŸ¥çœ‹æœ€æ–°çš„æ´»å‹•è³‡è¨Š</p>
                            </div>

                            <div className="relative mb-2">
                                <Icon name="search" className="absolute left-4 top-3 text-slate-400" size={20}/>
                                <input 
                                    type="text" 
                                    placeholder="æœå°‹æ´»å‹•é—œéµå­— (ä¾‹å¦‚ï¼šé£›é¼ ã€è›™ã€å†¬å­£ã€éœ²ç‡Ÿ)..." 
                                    className="w-full pl-12 pr-4 py-3 bg-slate-100 border-none rounded-2xl outline-none focus:ring-2 focus:ring-blue-500 transition-all text-slate-700"
                                    value={publicSearchTerm}
                                    onChange={e => setPublicSearchTerm(e.target.value)}
                                />
                            </div>

                            {/* [æ–°å¢] è·¨æœˆä»½æœå°‹çµæœæç¤ºèˆ‡è·³è½‰æŒ‰éˆ• */}
                            {publicSearchTerm && matchingMonths.length > 0 && (
                                <div className="mb-6 flex flex-wrap gap-2 animate-in fade-in slide-in-from-top-2">
                                    <span className="text-xs text-slate-400 py-1.5 flex items-center"><Icon name="search" size={12} className="mr-1"/> æœå°‹çµæœåˆ†å¸ƒæ–¼ï¼š</span>
                                    {matchingMonths.sort().map(m => {
                                        const isCurrentView = m === currentMonthStr;
                                        return (
                                            <button 
                                                key={m}
                                                onClick={() => {
                                                    const [y, mon] = m.split('-');
                                                    setCurrentDate(new Date(parseInt(y), parseInt(mon)-1, 1));
                                                }}
                                                className={`text-xs px-3 py-1.5 rounded-full font-bold transition-all flex items-center gap-1 ${isCurrentView ? 'bg-slate-800 text-white shadow-md ring-2 ring-slate-200' : 'bg-yellow-100 text-yellow-700 hover:bg-yellow-200'}`}
                                            >
                                                {m} {!isCurrentView && <Icon name="arrow-right" size={12}/>}
                                            </button>
                                        );
                                    })}
                                </div>
                            )}

                            {!publicSearchTerm && <div className="flex justify-center gap-4 mb-4 text-xs text-slate-400">
                                <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-blue-500"></span> æœ‰æ´»å‹•</div>
                                <div className="flex items-center gap-1"><span className="w-2 h-2 rounded-full bg-yellow-400"></span> ç¬¦åˆæœå°‹</div>
                            </div>}

                            <div className="bg-white rounded-3xl shadow-lg border border-slate-100 overflow-hidden mb-8">
                                <div className="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
                                    <div className="flex items-center gap-4 w-full justify-between px-2">
                                        <button onClick={prevMonth} className="p-2 hover:bg-white hover:shadow-sm rounded-full transition-all text-slate-500"><Icon name="chevron-left"/></button>
                                        <h2 className="text-lg font-bold text-slate-800">{currentDate.getFullYear()}å¹´ {currentDate.getMonth()+1}æœˆ</h2>
                                        <button onClick={nextMonth} className="p-2 hover:bg-white hover:shadow-sm rounded-full transition-all text-slate-500"><Icon name="chevron-right"/></button>
                                    </div>
                                </div>
                                <div className="grid grid-cols-7 text-center py-3 text-xs font-bold text-slate-400 bg-white border-b border-slate-100">
                                    {['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}
                                </div>
                                <div className="grid grid-cols-7 auto-rows-[50px] bg-white">
                                    {calendarDays.map((day, i) => {
                                        const dateStr = day ? `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}` : '';
                                        const dayEvents = day ? Object.values(stats.events).filter(e => e.date === dateStr) : [];
                                        const hasEvents = dayEvents.length > 0;
                                        const isSelected = dateStr === selectedPublicDate;
                                        
                                        const isMatch = publicSearchTerm && matchingDates.includes(dateStr);

                                        let cellClass = "hover:bg-slate-50 cursor-pointer flex flex-col items-center justify-center relative transition-all";
                                        let numClass = "text-sm font-medium text-slate-700";
                                        
                                        if (isSelected) {
                                            cellClass += " bg-slate-800 text-white hover:bg-slate-900 rounded-xl mx-1 my-1 shadow-md transform scale-105 z-10";
                                            numClass = "text-white font-bold";
                                        } else if (isMatch) {
                                            cellClass += " bg-yellow-100 text-yellow-800 rounded-xl mx-1 my-1";
                                        }

                                        return (
                                            <div key={i} onClick={() => day && setSelectedPublicDate(dateStr)} className={cellClass}>
                                                {day && (
                                                    <>
                                                        <div className={numClass}>{day}</div>
                                                        {hasEvents && !isMatch && !isSelected && (
                                                            <div className="w-1.5 h-1.5 bg-blue-500 rounded-full mt-1"></div>
                                                        )}
                                                    </>
                                                )}
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="space-y-4 fade-in">
                                <h3 className="font-bold text-slate-800 text-lg flex items-center gap-2 border-l-4 border-blue-500 pl-3">
                                    {selectedPublicDate} æ´»å‹•åˆ—è¡¨
                                </h3>
                                {selectedDayEvents.length > 0 ? (
                                    selectedDayEvents.map((e, idx) => {
                                        const cfg = eventConfigs[e.key] || {};
                                        
                                        // [ä¿®æ”¹] å‚³å…¥æ—¥æœŸèˆ‡å…¨åŸŸè¦å‰‡ï¼Œå–å¾—æ­£ç¢ºç‹€æ…‹ (å«éæœŸåˆ¤æ–·)
                                        const status = getEventStatus(e.count, cfg.capacity, cfg, e.date, globalRules);
                                        const displayName = cfg.displayName || e.eventName;

                                        let cardClass = 'bg-white border-slate-100 shadow-sm hover:shadow-md border-l-4';
                                        
                                        // å‹•æ…‹è¨­ç½®é¡è‰²é‚Šæ¡†
                                        const borderColor = status.colorObj ? status.colorObj.border.replace('border-', 'border-l-') : 'border-l-blue-500';
                                        
                                        // å¦‚æœé¡æ»¿æˆ–ç‹€æ…‹é¡è‰²ç‰¹æ®Š
                                        if (status.isFull) cardClass = 'bg-slate-50 border-slate-200 border-l-slate-400 opacity-70';
                                        else cardClass = `bg-white border-slate-100 shadow-sm hover:shadow-md border-l-4 ${borderColor.replace('border-l-100', 'border-l-500')}`;

                                        // ç‰¹åˆ¥è™•ç† Tailwind class çµ„åˆå•é¡Œ (ç°¡åŒ–)
                                        const statusBadgeClass = status.isFull 
                                            ? "bg-slate-600 text-white" 
                                            : `${status.colorObj.bg} ${status.colorObj.text}`;

                                        return (
                                            <div 
                                                key={idx} 
                                                onClick={() => cfg.link ? window.open(cfg.link, '_blank') : null}
                                                className={`p-5 rounded-2xl border transition-all cursor-pointer group relative ${cardClass}`}
                                            >
                                                <div className="flex justify-between items-start mb-3">
                                                    <div className="font-bold text-lg text-slate-800">{displayName}</div>
                                                    <div className="flex flex-col items-end gap-1">
                                                        <span className={`text-xs px-2 py-1 rounded-lg font-bold ${statusBadgeClass}`}>
                                                            {status.label}
                                                        </span>
                                                        {/* [æ–°å¢] é¡¯ç¤ºç›®å‰å ±åäººæ•¸ (é™¤éæ´»å‹•å·²çµæŸ) */}
                                                        {!status.isEnded && (
                                                            <span className="text-[10px] text-slate-500 font-bold bg-slate-50 px-1.5 py-0.5 rounded border border-slate-100">
                                                                ç›®å‰: <span className="text-blue-600">{e.count}</span> äºº
                                                            </span>
                                                        )}
                                                    </div>
                                                </div>
                                                
                                                <div className="space-y-2 text-sm text-slate-600">
                                                    <div className="flex items-center gap-2">
                                                        <Icon name="user" size={16} className="text-slate-400"/> 
                                                        <span>è¬›å¸«ï¼š{e.instructor || 'æœªå®š'}</span>
                                                    </div>
                                                    {cfg.time && (
                                                        <div className="flex items-center gap-2">
                                                            <Icon name="clock" size={16} className="text-slate-400"/> 
                                                            <span>æ™‚é–“ï¼š{cfg.time}</span>
                                                        </div>
                                                    )}
                                                </div>

                                                {cfg.link && !status.isFull && (
                                                    <div className="mt-4 pt-4 border-t border-slate-200/50 flex justify-end">
                                                        <span className="text-blue-600 font-bold text-sm flex items-center gap-1 group-hover:translate-x-1 transition-transform">
                                                            å‰å¾€å ±å <Icon name="arrow-right" size={16}/>
                                                        </span>
                                                    </div>
                                                )}
                                            </div>
                                        );
                                    })
                                ) : (
                                    <div className="text-center py-12 bg-slate-50 rounded-3xl border border-dashed border-slate-200">
                                        <div className="text-4xl mb-2">ğŸ“…</div>
                                        <div className="text-slate-400 font-medium">æœ¬æ—¥ç„¡æ´»å‹•</div>
                                        <div className="text-slate-300 text-sm mt-1">è«‹é»é¸å…¶ä»–æœ‰è—é»çš„æ—¥æœŸ</div>
                                    </div>
                                )}
                            </div>
                        </main>
                        {showLoginModal && <LoginModal onClose={() => setShowLoginModal(false)} onLogin={handleVerifyLogin} />}
                    </div>
                );
            }

            return (
                <div className="flex min-h-screen">
                    {mobileMenuOpen && (
                        <div className="fixed inset-0 z-50 bg-slate-800/50 backdrop-blur-sm md:hidden" onClick={() => setMobileMenuOpen(false)}>
                            <div className="absolute top-0 left-0 w-64 h-full bg-white shadow-xl p-4" onClick={e => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <Logo className="h-6 w-auto" />
                                    <button onClick={() => setMobileMenuOpen(false)} className="p-2 text-slate-500"><Icon name="x" /></button>
                                </div>
                                <nav className="space-y-1">
                                    <NavItem id="tasks" icon="check-square" label="ä»»å‹™æŒ‡æ®ä¸­å¿ƒ" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="promises" icon="message-square" label="æ‰¿è«¾ç‰†" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="events" icon="calendar" label="æ´»å‹•å ´æ¬¡è¡¨" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="projects" icon="briefcase" label="å°ˆæ¡ˆé€²åº¦" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="dashboard" icon="trending-up" label="ç‡Ÿé‹å„€è¡¨æ¿" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <NavItem id="crm" icon="users" label="å®¢æˆ¶ CRM" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                    <div className="border-t border-slate-100 my-2 pt-2">
                                         <NavItem id="import" icon="database" label="è³‡æ–™åº«ç®¡ç†" activeTab={activeTab} setActiveTab={setActiveTab} onClick={() => setMobileMenuOpen(false)} />
                                         <button 
                                            onClick={() => { setViewMode('public'); setMobileMenuOpen(false); }}
                                            className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all text-left"
                                        >
                                            <Icon name="eye" size={20} />
                                            <span className="font-medium tracking-wide">é è¦½å‰å°</span>
                                        </button>
                                    </div>
                                </nav>
                            </div>
                        </div>
                    )}

                    <aside className="w-64 bg-white border-r border-slate-200 flex flex-col p-4 hidden md:flex sticky top-0 h-screen">
                        <div className="flex items-center space-x-2 px-4 mb-8 mt-2">
                            <Logo className="h-8 w-auto" />
                        </div>
                        <nav className="space-y-1 flex-1">
                            <NavItem id="tasks" icon="check-square" label="ä»»å‹™æŒ‡æ®ä¸­å¿ƒ" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="promises" icon="message-square" label="æ‰¿è«¾ç‰†" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="events" icon="calendar" label="æ´»å‹•å ´æ¬¡è¡¨" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="projects" icon="briefcase" label="å°ˆæ¡ˆé€²åº¦" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="dashboard" icon="trending-up" label="ç‡Ÿé‹å„€è¡¨æ¿" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="crm" icon="users" label="å®¢æˆ¶ CRM" activeTab={activeTab} setActiveTab={setActiveTab} />
                        </nav>
                        <div className="pt-4 border-t border-slate-100 space-y-2">
                            <NavItem id="import" icon="database" label="è³‡æ–™åº«ç®¡ç†" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <button 
                                onClick={() => setViewMode('public')}
                                className="w-full flex items-center gap-3 px-4 py-3 rounded-xl text-slate-500 hover:bg-slate-50 hover:text-blue-600 transition-all"
                            >
                                <Icon name="eye" size={20} />
                                <span className="font-medium tracking-wide">é è¦½å‰å°</span>
                            </button>
                        </div>
                    </aside>

                    <main className="flex-1 p-4 md:p-10 overflow-y-auto bg-slate-50/50 relative h-screen">
                        <div className="md:hidden mb-6 flex justify-between items-center sticky top-0 z-30 bg-slate-50/90 backdrop-blur-sm py-2">
                            <Logo className="h-6 w-auto" />
                            <button onClick={() => setMobileMenuOpen(true)} className="p-2 bg-white rounded-lg shadow-sm text-slate-600 border border-slate-200"><Icon name="menu" /></button>
                        </div>

                        {activeTab === 'tasks' && <div className="max-w-6xl mx-auto fade-in pb-20"><header className="mb-8 flex justify-between items-end"><div><h2 className="text-2xl font-bold text-slate-800 mb-1">ä»»å‹™æŒ‡æ®ä¸­å¿ƒ</h2><p className="text-slate-500 text-sm">æ™ºæ…§è¿½è¹¤ç³»çµ±ï¼Œæ ¹æ“šæ´»å‹•æ—¥æœŸè‡ªå‹•æ’åº</p></div><div className="bg-white px-4 py-2 rounded-full border text-sm font-medium whitespace-nowrap">å¾…è™•ç†: <span className="text-blue-600 font-bold ml-1">{tasks.length}</span></div></header>{Object.keys(groupedTasks).length === 0 ? (<div className="text-center py-20"><div className="text-6xl mb-4">ğŸ‰</div><h3 className="text-xl font-bold text-slate-700">å¤ªæ£’äº†ï¼ä»»å‹™å·²æ¸…ç©º</h3></div>) : (<div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">{(() => {
    // å®šç¾©å›ºå®šé¡¯ç¤ºé †åº
    const fixedOrder = ['è¾¦ç†ä¿éšª', 'å¯„é€è¡Œå‰ä¿¡', 'å¯„é€èŠ±çµ®ä¿¡'];
    // åˆä½µå›ºå®šä»»å‹™èˆ‡å…¶ä»–è‡ªå®šç¾©ä»»å‹™
    const allTaskNames = [...new Set([...fixedOrder, ...Object.keys(groupedTasks)])];
    
    // æ’åºï¼šå›ºå®šä»»å‹™å„ªå…ˆï¼Œå…¶é¤˜æŒ‰åç¨±æ’
    allTaskNames.sort((a, b) => {
        const idxA = fixedOrder.indexOf(a);
        const idxB = fixedOrder.indexOf(b);
        if (idxA !== -1 && idxB !== -1) return idxA - idxB;
        if (idxA !== -1) return -1;
        if (idxB !== -1) return 1;
        return a.localeCompare(b);
    });

    return allTaskNames.map((taskName, index) => {
        const taskList = groupedTasks[taskName] || [];
        // è‹¥ä¸æ˜¯å›ºå®šä»»å‹™ä¸”åˆ—è¡¨ç‚ºç©ºï¼Œå‰‡éš±è—ï¼ˆå›ºå®šä»»å‹™å³ä½¿ç‚ºç©ºä¹Ÿè¦é¡¯ç¤ºä»¥é˜²è·³å‹•ï¼‰
        if (taskList.length === 0 && !fixedOrder.includes(taskName)) return null;

        const color = TASK_GROUP_COLORS[index % TASK_GROUP_COLORS.length];
        return (
            <div key={taskName} className={`rounded-2xl border ${color.border} ${color.bg} p-4 h-fit`}>
                <h3 className={`font-bold text-lg mb-4 ${color.text} flex items-center gap-2`}>
                    <Icon name="layers" className={color.icon} size={20}/>
                    {taskName}
                    <span className="text-sm opacity-75 font-normal ml-auto bg-white/50 px-2 py-0.5 rounded-full">{taskList.length}</span>
                </h3>
                <div className="space-y-3 min-h-[50px]">
                    {taskList.length > 0 ? taskList.map((t, i) => (
                        <div key={`${t.cfgKey}-${t.taskIdx}`} onClick={() => setActiveTaskDetail(t)} className="bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer group relative overflow-hidden">
                            <div className={`absolute top-0 left-0 w-1 h-full ${t.style.bg.replace('bg-', 'bg-') === 'bg-white' ? 'bg-slate-200' : t.style.bg.replace('bg', 'bg').replace('50', '400')}`}></div>
                            <div className="flex justify-between mb-2 pl-2">
                                <span className="bg-slate-100 text-slate-600 text-xs font-mono px-2 py-0.5 rounded">{t.evtDate}</span>
                                {t.style.label && <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${t.style.color} ${t.style.border} ${t.style.bg}`}>{t.style.label}</span>}
                            </div>
                            <div className="pl-2">
                                <div className="text-sm font-bold text-slate-800 mb-1 truncate">{t.evtName}</div>
                                <button onClick={(e) => { e.stopPropagation(); toggleTask(t.cfgKey, t.taskIdx) }} className="w-full mt-3 py-2 rounded-lg bg-slate-50 text-slate-400 hover:bg-green-500 hover:text-white transition-all flex justify-center gap-2 text-xs font-bold"><Icon name="check-circle-2" size={14} /> æ¨™ç¤ºå®Œæˆ</button>
                            </div>
                        </div>
                    )) : <div className="text-center text-xs text-slate-400 py-8 border-2 border-dashed border-slate-200 rounded-xl">ç›®å‰ç„¡å¾…è¾¦äº‹é …</div>}
                </div>
            </div>
        );
    });
})()}</div>)}</div>}
                        {activeTab === 'promises' && <div className="max-w-6xl mx-auto fade-in pb-20"><header className="mb-8 flex flex-col md:flex-row justify-between items-start md:items-center gap-4"><div><h2 className="text-2xl font-bold text-slate-800 mb-1">åœ˜éšŠæ‰¿è«¾ç‰†</h2><p className="text-slate-500 text-sm">ç´€éŒ„é‚£äº›éæ­£å¼ä½†é‡è¦çš„ç´„å®š</p></div><div className="flex gap-3 w-full md:w-auto"><div className="relative flex-1 md:w-64"><Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={18}/><input type="text" placeholder="æœå°‹æ‰¿è«¾..." className="w-full pl-10 pr-4 py-2 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-purple-500 transition-all" value={promiseSearch} onChange={e => setPromiseSearch(e.target.value)} /></div><button onClick={()=>setShowAddPromise(true)} className="bg-purple-600 text-white px-4 py-2 rounded-xl flex items-center gap-2 shadow-md hover:bg-purple-700 whitespace-nowrap"><Icon name="plus" size={18}/> <span className="hidden md:inline">æ–°å¢</span></button></div></header><div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">{promises.filter(p => !promiseSearch || (p.content && p.content.toLowerCase().includes(promiseSearch.toLowerCase())) || (p.who && p.who.toLowerCase().includes(promiseSearch.toLowerCase()))).map(p => { const st = getPromiseStatus(p.date, p.time); const isDone = p.status === 'done'; return (<div key={p.id} className={`bg-white p-5 rounded-2xl border shadow-sm relative transition-all ${isDone ? 'opacity-50 border-slate-100' : 'border-slate-200 hover:shadow-md'}`}><button onClick={()=>handleDeletePromise(p.id)} className="absolute top-3 right-3 text-slate-300 hover:text-red-400 opacity-0 hover:opacity-100 transition"><Icon name="trash-2" size={16}/></button><div className="flex items-center gap-2 mb-3"><span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${isDone ? 'text-slate-400 border-slate-200 bg-slate-50' : `${st.color} ${st.border} ${st.bg}`}`}>{isDone ? 'å·²å®Œæˆ' : st.label}</span><span className="text-xs text-slate-400 flex items-center gap-1"><Icon name="clock" size={12}/> {p.date} {p.time}</span></div><h4 className={`font-bold text-lg mb-2 ${isDone ? 'text-slate-400 line-through' : 'text-slate-800'}`}>{p.content}</h4>{p.who && <div className="text-sm text-slate-500 mb-4 flex items-center gap-1"><Icon name="user" size={14}/> {p.who}</div>}<button onClick={()=>handleTogglePromise(p.id, p.status)} className={`w-full py-2 rounded-xl border font-bold text-sm flex items-center justify-center gap-2 transition-all ${isDone ? 'bg-slate-50 text-slate-400 border-slate-200' : 'bg-white text-purple-600 border-purple-200 hover:bg-purple-50'}`}>{isDone ? 'é‡å•Ÿä»»å‹™' : 'æ¨™ç¤ºå®Œæˆ'}</button></div>);})}</div></div>}
                        {activeTab === 'events' && <div className="fade-in max-w-6xl mx-auto pb-20"><header className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">æ´»å‹•å ´æ¬¡</h2><div className="flex gap-3"><button onClick={()=>setShowCreateEvent(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-md"><Icon name="plus" size={18}/> å¿«é€Ÿé–‹åœ˜</button><div className="bg-white p-1 rounded-lg border flex"><button onClick={()=>setEventsViewMode('list')} className={`p-2 rounded-md ${eventsViewMode==='list'?'bg-slate-100':''}`}><Icon name="list" size={18}/></button><button onClick={()=>setEventsViewMode('calendar')} className={`p-2 rounded-md ${eventsViewMode==='calendar'?'bg-slate-100':''}`}><Icon name="calendar" size={18}/></button></div></div></header>{eventsViewMode === 'list' && (<div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden table-container"><table className="w-full text-left min-w-[600px]"><thead className="bg-slate-50 border-b border-slate-100 text-slate-500 text-sm"><tr><th className="px-6 py-4 whitespace-nowrap">æ—¥æœŸ</th><th className="px-6 py-4 whitespace-nowrap">æ´»å‹•</th><th className="px-6 py-4 whitespace-nowrap">å ±å</th><th className="px-6 py-4 whitespace-nowrap">æ“ä½œ</th></tr></thead><tbody className="divide-y divide-slate-100">{Object.values(stats.events).map((e, i) => { const cfg = eventConfigs[e.key] || {}; const cap = cfg.capacity || 20; const isFull = e.count >= cap; const carpool = e.customers ? e.customers.filter(c=>c.transport==='å…±ä¹˜').length : 0; return (<tr key={i} className="hover:bg-slate-50/80"><td className="px-6 py-4 text-slate-600 whitespace-nowrap">{e.date}</td><td className="px-6 py-4"><div className="font-bold text-slate-800">{e.eventName}</div><div className="text-xs text-slate-400 mt-0.5">{e.instructor}</div></td><td className="px-6 py-4"><div className="flex items-center gap-2"><span className={`font-bold ${isFull?'text-red-500':'text-slate-700'}`}>{e.count}</span><span className="text-xs text-slate-400">/ {cap}</span><div className="w-16 h-1.5 bg-slate-100 rounded-full overflow-hidden"><div className={`h-full ${isFull?'bg-red-500':'bg-green-500'}`} style={{width:`${Math.min((e.count/cap)*100,100)}%`}}></div></div></div>{carpool > 0 && <div className="text-[10px] text-orange-500 mt-1 flex items-center"><Icon name="car" size={10} className="mr-1"/> å…±ä¹˜ {carpool} äºº</div>}</td><td className="px-6 py-4"><button onClick={()=>setEditingEvent(e)} className="text-blue-600 hover:bg-blue-50 px-3 py-1.5 rounded flex items-center gap-1 text-sm whitespace-nowrap"><Icon name="settings" size={14}/> ç®¡ç†</button></td></tr>);})}</tbody></table></div>)}{eventsViewMode === 'calendar' && (<div className="bg-white p-4 md:p-6 rounded-2xl shadow-sm border border-slate-200 table-container"><div className="flex justify-between items-center mb-6 sticky left-0"><div className="flex items-center gap-2"><button onClick={prevMonth} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevron-left"/></button><h3 className="text-xl font-bold text-slate-800 whitespace-nowrap">{currentDate.getFullYear()}å¹´ {currentDate.getMonth()+1}æœˆ</h3><button onClick={nextMonth} className="p-2 hover:bg-slate-100 rounded-full"><Icon name="chevron-right"/></button></div></div><div className="min-w-[600px]"><div className="grid grid-cols-7 mb-2 text-center text-sm font-bold text-slate-400">{['æ—¥','ä¸€','äºŒ','ä¸‰','å››','äº”','å…­'].map(d=><div key={d}>{d}</div>)}</div><div className="grid grid-cols-7 auto-rows-[160px] border-t border-l border-slate-200">{calendarDays.map((day, i) => { const dateStr = day ? `${currentDate.getFullYear()}-${String(currentDate.getMonth()+1).padStart(2,'0')}-${String(day).padStart(2,'0')}` : ''; const dayEvents = day ? Object.values(stats.events).filter(e => e.date === dateStr) : []; return (<div key={i} className={`border-b border-r border-slate-200 p-1 md:p-2 relative ${day ? 'hover:bg-slate-50' : 'bg-slate-50/50'}`}>{day && (<><div className="flex justify-between items-start"><div className="text-sm font-medium mb-1">{day}</div><button onClick={(e)=>{e.stopPropagation();setShowScheduleModal(true);setScheduleDate(dateStr)}} className="text-slate-300 hover:text-blue-600"><Icon name="calendar-days" size={14}/></button></div><div className="space-y-1 overflow-y-auto max-h-[120px] no-scrollbar">{dayEvents.map((e, idx) => { const cfg = eventConfigs[e.key] || {}; const capacity = cfg.capacity || 20; const isHot = e.count >= (cfg.hotThreshold || 10); const isFull = capacity > 0 && e.count >= capacity; let cardClass = 'bg-blue-50 border-blue-100'; if (isFull) cardClass = 'bg-slate-100 border-slate-200 opacity-80'; else if (isHot) { const color = COLOR_OPTIONS.find(c => c.value === cfg.hotColor) || COLOR_OPTIONS[0]; cardClass = `${color.bg} ${color.border}`; } return (<div key={idx} onClick={(evt)=>{ evt.stopPropagation(); setEditingEvent(e); }} className={`mb-1 p-1.5 rounded-lg border cursor-pointer transition-all group hover:shadow-md ${cardClass}`}><div className="flex justify-between items-start mb-0.5"><div className="font-bold text-xs text-slate-800 truncate flex-1 flex items-center">{e.eventName}{isFull && <span className="ml-1 text-[9px] bg-slate-600 text-white px-1 rounded">å·²æ»¿</span>}</div>{cfg.time && <div className="text-[10px] text-slate-500 bg-white/50 px-1 rounded ml-1 whitespace-nowrap">{cfg.time}</div>}</div><div className="flex justify-between items-center"><div className="text-[10px] text-slate-600 flex items-center truncate max-w-[60%]"><Icon name="user" size={10} className="mr-0.5 flex-shrink-0"/><span className="truncate">{e.instructor || 'æœªå®š'}</span></div><div className={`text-[10px] font-bold bg-white/80 px-1 rounded-md shadow-sm ${isFull ? 'text-slate-500' : 'text-blue-600'}`}>{e.count}äºº</div></div></div>); })}{instructorSchedule[dateStr] && instructorSchedule[dateStr].length > 0 && (<div className="text-[10px] text-red-400 flex flex-wrap gap-1 mt-1">{instructorSchedule[dateStr].map(name => <span key={name} className="bg-red-50 px-1 rounded">{name}ä¼‘</span>)}</div>)}</div></>)}</div>);})}</div></div></div>)}</div>}
                        {activeTab === 'projects' && <div className="fade-in max-w-6xl mx-auto pb-20"><header className="flex justify-between items-center mb-6"><h2 className="text-2xl font-bold">å°ˆæ¡ˆé€²åº¦</h2><button onClick={handleAddProject} className="bg-blue-600 text-white px-4 py-2 rounded-lg flex items-center gap-2"><Icon name="plus" size={18}/> æ–°å¢ä»»å‹™</button></header><div className="grid grid-cols-1 md:grid-cols-3 gap-6">{['To Do', 'In Progress', 'Done'].map(status => (<div key={status} className="bg-slate-100/50 p-4 rounded-2xl border border-slate-200/60"><h3 className="text-sm font-bold text-slate-500 uppercase mb-4 flex justify-between">{status} <span className="bg-white px-2 py-0.5 rounded shadow-sm text-slate-800">{projects.filter(p => { if(status==='To Do') return p.status==='To Do'||p.status==='Stuck'; if(status==='In Progress') return p.status==='In Progress'; return p.status==='Done'; }).length}</span></h3><div className="space-y-3">{projects.filter(p => { if(status==='To Do') return p.status==='To Do'||p.status==='Stuck'; if(status==='In Progress') return p.status==='In Progress'; return p.status==='Done'; }).map(p => (<div key={p.id} onClick={()=>handleProjectStatus(p.id, p.status)} className="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition cursor-pointer group relative"><button onClick={(e)=>{e.stopPropagation();handleDeleteProject(p.id)}} className="absolute top-2 right-2 text-slate-300 hover:text-red-500 opacity-0 group-hover:opacity-100"><Icon name="trash-2" size={14}/></button><div className={`text-[10px] font-bold px-2 py-0.5 rounded w-fit mb-2 ${p.status==='Stuck'?'bg-red-100 text-red-600':p.status==='Done'?'bg-green-100 text-green-600':'bg-blue-50 text-blue-600'}`}>{p.status}</div><div className="font-bold text-slate-800">{p.name}</div><div className="flex justify-between items-center mt-3 pt-3 border-t border-slate-50"><div className="text-xs text-slate-400 flex items-center gap-1"><Icon name="clock" size={12}/> {p.deadline}</div><div className="w-6 h-6 bg-slate-100 rounded-full flex items-center justify-center text-xs font-bold text-slate-600">{p.owner?.[0]}</div></div></div>))}</div></div>))}</div></div>}
                        {activeTab === 'dashboard' && <div className="fade-in max-w-6xl mx-auto space-y-8 pb-20"><header className="flex justify-between items-center"><h2 className="text-2xl font-bold">ç‡Ÿé‹å„€è¡¨æ¿</h2><button onClick={()=>downloadCSV(csvInput, 'full_export.csv')} className="text-sm bg-slate-800 text-white px-4 py-2 rounded-lg flex items-center gap-2"><Icon name="download" size={16}/> åŒ¯å‡ºç¸½è¡¨ (Excel)</button></header><div className="grid grid-cols-1 md:grid-cols-3 gap-6"><div className="bg-white p-6 rounded-2xl shadow-sm border border-blue-100 relative overflow-hidden"><div className="absolute -right-4 -top-4 text-blue-50 opacity-50"><Icon name="trending-up" size={100}/></div><div className="relative"><div className="text-sm font-bold text-blue-600 mb-1 uppercase tracking-wider">æœ¬æœˆç‡Ÿæ”¶</div><div className="text-4xl font-bold text-slate-800">${dashboardData.currentMonthRev.toLocaleString()}</div></div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-indigo-100 relative overflow-hidden"><div className="absolute -right-4 -top-4 text-indigo-50 opacity-50"><Icon name="users" size={100}/></div><div className="relative"><div className="text-sm font-bold text-indigo-600 mb-1 uppercase tracking-wider">æœ¬æœˆäººæ¬¡</div><div className="text-4xl font-bold text-slate-800">{dashboardData.currentMonthPax} <span className="text-lg font-normal text-slate-400">äºº</span></div></div></div><div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-100"><div className="text-sm font-medium text-slate-500 mb-4">æ­·å²ç¸½ç‡Ÿæ”¶</div><div className="text-2xl font-bold text-slate-700">${stats.totalRev.toLocaleString()}</div></div></div><div><h3 className="text-lg font-bold text-slate-700 mb-4">æœˆåº¦ç‡Ÿé‹å ±è¡¨</h3>{Object.entries(dashboardData.monthlyGroups).sort((a,b)=>b[0].localeCompare(a[0])).map(([month, data]) => (<MonthlyReport key={month} month={month} data={data} />))}</div></div>}
                        {activeTab === 'crm' && <div className="fade-in max-w-6xl mx-auto pb-20">
                            <header className="mb-6 flex flex-col md:flex-row justify-between items-center gap-4">
                                <div><h2 className="text-2xl font-bold text-slate-800">å®¢æˆ¶åƒ¹å€¼åˆ†æ (CRM)</h2><p className="text-sm text-slate-500">æŒæ¡é«˜åƒ¹å€¼å®¢æˆ¶èˆ‡å¹³å‡å®¢å–®è¡¨ç¾</p></div>
                                <div className="flex bg-slate-100 p-1 rounded-xl">{[{id:'all', label:'å…¨æ™‚æ®µ'}, {id:'year', label:'è¿‘ä¸€å¹´'}, {id:'quarter', label:'è¿‘ä¸€å­£'}, {id:'month', label:'è¿‘ä¸€æœˆ'}].map(t => (<button key={t.id} onClick={() => setLtvTimeframe(t.id)} className={`px-4 py-1.5 rounded-lg text-sm font-bold transition-all ${ltvTimeframe === t.id ? 'bg-white text-blue-600 shadow-sm' : 'text-slate-500 hover:text-slate-700'}`}>{t.label}</button>))}</div>
                            </header>

                            <div className="grid grid-cols-3 gap-4 mb-6">
                                <div className="bg-gradient-to-br from-blue-500 to-blue-600 rounded-2xl p-4 text-white shadow-lg shadow-blue-200"><div className="text-blue-100 text-xs font-bold mb-1">å€é–“å¹³å‡ LTV (äººå‡è²¢ç»)</div><div className="text-2xl font-bold">${ltvStats.avgLtv.toLocaleString()}</div></div>
                                <div className="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm"><div className="text-slate-400 text-xs font-bold mb-1">å€é–“ç¸½ç‡Ÿæ”¶</div><div className="text-2xl font-bold text-slate-700">${ltvStats.periodRevenue.toLocaleString()}</div></div>
                                <div className="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm"><div className="text-slate-400 text-xs font-bold mb-1">æ´»èºå®¢æˆ¶æ•¸</div><div className="text-2xl font-bold text-slate-700">{ltvStats.activeCustomerCount} <span className="text-sm font-normal text-slate-400">äºº</span></div></div>
                            </div>

                            <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                                <div className="lg:col-span-1 space-y-4">
                                    <div className="relative"><Icon name="search" className="absolute left-3 top-3 text-slate-400" size={20}/><input type="text" className="w-full pl-10 pr-4 py-3 bg-white border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 shadow-sm" placeholder="æœå°‹å®¢æˆ¶å§“å..." value={crmSearchTerm} onChange={(e) => { setCrmSearchTerm(e.target.value); setShowCrmDropdown(true); setSelectedCustomer(''); }} onFocus={() => setShowCrmDropdown(true)} onBlur={() => setTimeout(() => setShowCrmDropdown(false), 200)} />{showCrmDropdown && crmSearchTerm && (<div className="absolute z-10 w-full bg-white border border-slate-200 rounded-xl shadow-lg mt-1 max-h-60 overflow-y-auto">{filteredCrmCustomers.length > 0 ? (filteredCrmCustomers.map(c => (<div key={c} className="p-3 hover:bg-blue-50 cursor-pointer text-slate-700 flex justify-between items-center" onClick={() => { setSelectedCustomer(c); setCrmSearchTerm(c); setShowCrmDropdown(false); }}><span>{c}</span><span className="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded font-mono">${ltvStats.map[c]?.toLocaleString()}</span></div>))) : (<div className="p-3 text-slate-400 text-sm">ç„¡ç›¸ç¬¦å®¢æˆ¶</div>)}</div>)}</div>
                                    <div className="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden"><div className="p-4 border-b border-slate-100 bg-slate-50/50 font-bold text-slate-700 flex justify-between items-center"><span>ğŸ† LTV æ’è¡Œæ¦œ ({ltvTimeframe === 'all' ? 'å…¨æ™‚æ®µ' : 'å€é–“'})</span></div><div className="max-h-[500px] overflow-y-auto">{ltvStats.sortedCustomers.slice(0, 50).map((name, idx) => (<div key={name} onClick={() => { setSelectedCustomer(name); setCrmSearchTerm(name); }} className={`p-3 flex items-center justify-between border-b border-slate-50 cursor-pointer hover:bg-blue-50 transition-colors ${selectedCustomer === name ? 'bg-blue-50 border-l-4 border-l-blue-500' : ''}`}><div className="flex items-center gap-3"><div className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold ${idx < 3 ? 'bg-yellow-100 text-yellow-700' : 'bg-slate-100 text-slate-500'}`}>{idx + 1}</div><span className="text-sm font-medium text-slate-700 truncate max-w-[100px]">{name}</span></div><div className="text-right"><div className="text-sm font-bold text-blue-600">${ltvStats.map[name].toLocaleString()}</div><div className="text-[10px] text-slate-400">{ltvStats.countMap[name]} æ¬¡æ¶ˆè²»</div></div></div>))}</div></div>
                                </div>
                                <div className="lg:col-span-2">
                                    {customerProfile ? (<div className="animate-in fade-in slide-in-from-top-4"><div className="flex flex-col md:flex-row gap-8 mb-8 pb-8 border-b border-slate-100 relative"><button onClick={() => setEditingRow(customerProfile.latestRecord)} className="absolute top-0 right-0 text-slate-400 hover:text-blue-600 flex items-center gap-1 text-sm border border-slate-200 px-3 py-1.5 rounded-lg hover:bg-blue-50 transition"><Icon name="edit-2" size={14}/> ç·¨è¼¯è³‡æ–™/å‚™è¨»</button><div className="flex items-center gap-6"><div className="w-24 h-24 bg-gradient-to-br from-blue-500 to-purple-600 rounded-full flex items-center justify-center text-4xl font-bold text-white shadow-lg shrink-0">{selectedCustomer[0]}</div><div><div className="text-3xl font-bold text-slate-800 mb-1">{selectedCustomer}</div><div className="text-sm text-slate-500 flex items-center gap-2"><Icon name="credit-card" size={14}/> LTV (çµ‚èº«åƒ¹å€¼): <span className="text-blue-600 font-bold">${customerProfile.totalSpend.toLocaleString()}</span></div></div></div><div className="flex-1 bg-slate-50 p-4 rounded-xl border border-slate-100 grid grid-cols-2 gap-y-3 gap-x-6 text-sm mt-4 md:mt-0"><div><span className="block text-xs text-slate-400 font-bold uppercase">Email</span>{customerProfile.email || '-'}</div><div><span className="block text-xs text-slate-400 font-bold uppercase">æ‰‹æ©Ÿ</span>{customerProfile.phone || '-'}</div><div><span className="block text-xs text-slate-400 font-bold uppercase">èº«åˆ†è­‰</span>{customerProfile.idNo || '-'}</div><div><span className="block text-xs text-slate-400 font-bold uppercase">ç”Ÿæ—¥</span>{customerProfile.birthday || '-'}</div><div><span className="block text-xs text-slate-400 font-bold uppercase">å¸¸ç”¨äº¤é€š</span>{customerProfile.transport || '-'}</div><div><span className="block text-xs text-slate-400 font-bold uppercase">ä¾†æºç®¡é“</span>{customerProfile.source || '-'}</div><div><span className="block text-xs text-slate-400 font-bold uppercase">ç¤¾ç¾¤æš±ç¨±</span>{customerProfile.socialName || '-'}</div><div className="col-span-2"><span className="block text-xs text-slate-400 font-bold uppercase">å‚™è¨»</span>{customerProfile.notes || '-'}</div></div></div><h4 className="font-bold text-slate-700 mb-4">æ¶ˆè²»æ­·å² ({customerProfile.history.length})</h4><div className="space-y-2 table-container max-h-[400px] overflow-y-auto">{customerProfile.history.map((h,i) => (<div key={i} className="flex justify-between items-center p-4 border border-slate-100 rounded-xl hover:bg-slate-50 transition"><div><div className="font-bold text-slate-700">{h.eventName}</div><div className="text-xs text-slate-400 mt-1">{h.date} â€¢ {h.instructor}</div>{h.orderDate && <div className="text-xs text-blue-500 mt-0.5">ğŸ“… ä¸‹å®šæ–¼: {h.orderDate}</div>}</div><div className="font-mono font-bold text-slate-600">${h.price}</div></div>))}</div></div>) : (<div className="h-full flex flex-col items-center justify-center text-slate-400 bg-white rounded-2xl border border-dashed border-slate-200 min-h-[400px]"><div className="w-16 h-16 bg-slate-50 rounded-full flex items-center justify-center mb-4"><Icon name="user-check" size={32} className="text-slate-300"/></div><p className="font-bold">è«‹å¾å·¦å´æ’è¡Œæ¦œé¸æ“‡ä¸€ä½å®¢æˆ¶</p><p className="text-sm mt-1">æˆ–ä½¿ç”¨ä¸Šæ–¹æœå°‹æ¬„æŸ¥æ‰¾</p></div>)}
                                </div>
                            </div>
                        </div>}
                        {activeTab === 'import' && <div className="fade-in max-w-6xl mx-auto space-y-8 pb-20">
                            <header className="flex flex-col md:flex-row justify-between items-center gap-4">
                                <h2 className="text-2xl font-bold">è³‡æ–™åº«èˆ‡å ±åç®¡ç†</h2>
                                <div className="flex gap-2 items-center w-full md:w-auto justify-end">
                                    <div className="text-xs text-slate-400 bg-slate-100 px-2 py-1 rounded">ä¾†æº: {dbSource}</div>
                                    <select className="text-xs p-1 border rounded" onChange={e=>handleDbSourceChange(e.target.value)} value={dbSource}><option value="crm-system-v1">v1 (æ‚¨çš„çœŸå¯¦è³‡æ–™)</option><option value="default-app-id">Default (èˆŠç‰ˆæ¸¬è©¦)</option></select>
                                    <button onClick={()=>setShowGlobalRules(true)} className="bg-indigo-600 text-white px-4 py-2 rounded-lg flex items-center gap-2 hover:bg-indigo-700 shadow-md whitespace-nowrap"><Icon name="settings" size={18}/> é è¨­ç‹€æ…‹è¦å‰‡</button>
                                    {/* [ä¿®æ”¹] å·²ç§»é™¤æ‰¹é‡åŒ¯å…¥æŒ‰éˆ• */}
                                </div>
                            </header>
                            
                            <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden table-container">
                                <div className="p-4 border-b border-slate-100 flex gap-4 sticky left-0">
                                    <div className="relative flex-1">
                                        <Icon name="search" className="absolute left-3 top-2.5 text-slate-400" size={18}/>
                                        <input type="text" placeholder="æœå°‹å§“åã€æ´»å‹•æˆ–æ—¥æœŸ..." className="w-full pl-10 pr-4 py-2 bg-slate-50 border border-slate-200 rounded-lg outline-none focus:ring-2 focus:ring-blue-500" value={importSearch} onChange={e=>setImportSearch(e.target.value)}/>
                                    </div>
                                </div>
                                <div className="max-h-[600px] overflow-y-auto">
                                    {/* [ä¿®æ”¹] ç§»é™¤ min-w-[800px] ä»¥è§£æ±ºå³å´ç©ºç™½ï¼Œæ”¹ç”¨ w-full */}
                                    <table className="w-full text-left text-sm">
                                        <thead className="bg-slate-50 border-b border-slate-100 text-slate-500 sticky top-0">
                                            <tr>
                                                <th className="p-2 md:p-4 whitespace-nowrap">æ—¥æœŸ</th>
                                                <th className="p-2 md:p-4 whitespace-nowrap">æ´»å‹•</th>
                                                <th className="p-2 md:p-4 whitespace-nowrap">å®¢æˆ¶</th>
                                                {/* [ä¿®æ”¹] é‡‘é¡æ¬„ä½ï¼šæ‰‹æ©Ÿéš±è— (hidden)ï¼Œé›»è…¦é¡¯ç¤º (md:table-cell) */}
                                                <th className="p-4 hidden md:table-cell text-right">é‡‘é¡</th>
                                                <th className="p-2 md:p-4 text-right">æ“ä½œ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {(() => {
                                                // [æ–°å¢] æ’åºé‚è¼¯ï¼šé è¿‘ä»Šå¤©çš„æ’å‰é¢ï¼Œå·²çµæŸçš„æ’å¾Œé¢
                                                const today = new Date();
                                                today.setHours(0, 0, 0, 0);
                                                
                                                const filtered = parsedData.filter(r => !importSearch || JSON.stringify(r).toLowerCase().includes(importSearch.toLowerCase()));
                                                
                                                const sorted = filtered.sort((a, b) => {
                                                    const dateA = new Date(a.date);
                                                    const dateB = new Date(b.date);
                                                    if (isNaN(dateA)) return 1;
                                                    if (isNaN(dateB)) return -1;
                                                    
                                                    const isAFuture = dateA >= today;
                                                    const isBFuture = dateB >= today;
                                                    
                                                    // æœªä¾†è¡Œç¨‹æ’åœ¨éå»è¡Œç¨‹ä¹‹å‰
                                                    if (isAFuture && !isBFuture) return -1;
                                                    if (!isAFuture && isBFuture) return 1;
                                                    
                                                    // éƒ½æ˜¯æœªä¾†ï¼šæ—¥æœŸè¶Šå°è¶Šå‰é¢ (å‡åº)
                                                    if (isAFuture) return dateA - dateB;
                                                    
                                                    // éƒ½æ˜¯éå»ï¼šæ—¥æœŸè¶Šå¤§è¶Šå‰é¢ (é›¢ä»Šå¤©è¶Šè¿‘è¶Šå‰é¢ -> é™åº)
                                                    return dateB - dateA;
                                                });
                                                
                                                return sorted.map((row) => (
                                                    <tr key={row.id} className="hover:bg-slate-50">
                                                        <td className="p-2 md:p-4 text-slate-600 text-xs md:text-sm whitespace-nowrap">{row.date}</td>
                                                        <td className="p-2 md:p-4 font-medium text-slate-700 text-xs md:text-sm">{row.eventName}</td>
                                                        <td className="p-2 md:p-4 text-xs md:text-sm truncate max-w-[80px] md:max-w-none">{row.customerName}</td>
                                                        {/* [ä¿®æ”¹] é‡‘é¡å…§å®¹ï¼šæ‰‹æ©Ÿéš±è—ï¼Œé›»è…¦é¡¯ç¤º */}
                                                        <td className="p-4 font-mono hidden md:table-cell text-right">${row.price}</td>
                                                        <td className="p-2 md:p-4 text-right flex justify-end gap-1 md:gap-2">
                                                            {/* ç·¨è¼¯æŒ‰éˆ•ï¼šæ‰‹æ©Ÿé›»è…¦çš†é¡¯ç¤º */}
                                                            <button onClick={()=>setEditingRow(row)} className="p-2 text-blue-600 hover:bg-blue-50 rounded border border-transparent hover:border-blue-100">
                                                                <Icon name="edit-2" size={16}/>
                                                            </button>
                                                            {/* [ä¿®æ”¹] åˆªé™¤æŒ‰éˆ•ï¼šæ‰‹æ©Ÿéš±è— (hidden)ï¼Œé›»è…¦é¡¯ç¤º (md:inline-block) */}
                                                            <button onClick={()=>handleDeleteRow(row.id)} className="p-2 text-red-400 hover:bg-red-50 rounded hidden md:inline-block">
                                                                <Icon name="trash-2" size={16}/>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                ));
                                            })()}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            
                            <section>
                                <h2 className="text-2xl font-bold mb-6">æ–°å¢å ±åè³‡æ–™</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200 space-y-4">
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">æ—¥æœŸ *</label><input type="date" className="w-full p-2 border rounded-lg" value={newReg.date} onChange={e=>setNewReg({...newReg, date: e.target.value})} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">æ´»å‹•åç¨± *</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="ä¾‹å¦‚: ç™»å±±åœ˜" value={newReg.eventName} onChange={e=>setNewReg({...newReg, eventName: e.target.value})} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">è¬›å¸«</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="è¬›å¸«å§“å" value={newReg.instructor} onChange={e=>setNewReg({...newReg, instructor: e.target.value})} /></div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">å®¢æˆ¶å§“å *</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="ç‹å°æ˜" value={newReg.customerName} onChange={e=>setNewReg({...newReg, customerName: e.target.value})} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">é‡‘é¡</label><input type="number" className="w-full p-2 border rounded-lg" placeholder="3000" value={newReg.price} onChange={e=>setNewReg({...newReg, price: e.target.value})} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">äº¤é€šæ–¹å¼</label><select className="w-full p-2 border rounded-lg" value={newReg.transport} onChange={e=>setNewReg({...newReg, transport: e.target.value})}><option value="">æœªå®š</option><option value="å…±ä¹˜">å…±ä¹˜</option><option value="è‡ªè¡Œå‰å¾€">è‡ªè¡Œå‰å¾€</option></select></div>
                                    </div>
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">è¨‚è³¼æ—¥</label><input type="date" className="w-full p-2 border rounded-lg" value={newReg.orderDate} onChange={e=>setNewReg({...newReg, orderDate: e.target.value})} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">å ±åç®¡é“</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="FB, IG..." value={newReg.source} onChange={e=>setNewReg({...newReg, source: e.target.value})} /></div>
                                        <div><label className="block text-xs font-bold text-slate-500 mb-1">æ‰‹æ©Ÿ</label><input type="text" className="w-full p-2 border rounded-lg" placeholder="09xx..." value={newReg.phone} onChange={e=>setNewReg({...newReg, phone: e.target.value})} /></div>
                                    </div>
                                    <div className="flex justify-end pt-2"><button onClick={handleAddManualReg} disabled={isSaving} className={`bg-blue-600 text-white px-6 py-2 rounded-lg flex items-center gap-2 transition-colors ${addRegStatus==='success'?'bg-green-600 hover:bg-green-700':'hover:bg-blue-700'}`}>{isSaving ? <Icon name="loader-2" className="animate-spin"/> : (addRegStatus==='success' ? <Icon name="check"/> : <Icon name="plus"/>)}{addRegStatus==='success' ? 'æ–°å¢æˆåŠŸï¼' : 'æ–°å¢ä¸€ç­†å ±å'}</button></div>
                                </div>
                            </section>
                            
                            <details className="group"><summary className="flex items-center gap-2 cursor-pointer text-slate-500 font-bold hover:text-slate-700"><Icon name="code" size={16}/> é€²éšï¼šåŸå§‹ CSV è³‡æ–™åº« (å…¨é‡ç·¨è¼¯)</summary><div className="mt-4 bg-white p-6 rounded-2xl shadow-sm border border-slate-200"><textarea className="w-full h-96 p-4 font-mono text-sm bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none" value={csvInput} onChange={e=>setCsvInput(e.target.value)} onFocus={() => isEditingRef.current = true} onBlur={() => isEditingRef.current = false} /><div className="mt-4 flex justify-between items-center"><div className="flex items-center gap-2 bg-slate-50 p-2 rounded-lg border border-slate-200"><Icon name="lock" size={16} className="text-slate-400"/><span className="text-xs font-bold text-slate-600">ç®¡ç†å“¡å®‰å…¨è¨­å®š</span><input type="password" placeholder="è¼¸å…¥æ–°å¯†ç¢¼..." className="px-2 py-1 border rounded text-xs w-32 outline-none focus:border-blue-400" value={newPasswordInput} onChange={e=>setNewPasswordInput(e.target.value)} /><button onClick={handleUpdatePassword} className={`text-xs text-white px-3 py-1 rounded transition-colors ${passwordSaveStatus==='success' ? 'bg-green-500' : 'bg-slate-600 hover:bg-slate-700'}`}>{passwordSaveStatus==='success' ? 'å·²æ›´æ–°' : (passwordSaveStatus==='saving' ? '...' : 'æ›´æ–°å¯†ç¢¼')}</button></div><button onClick={() => handleSaveCSV(csvInput)} disabled={isSaving || csvSaveStatus === 'saving'} className={`text-white px-6 py-2 rounded-xl flex items-center gap-2 shadow-md transition-all ${csvSaveStatus === 'success' ? 'bg-green-600 hover:bg-green-700' : csvSaveStatus === 'error' ? 'bg-red-600 hover:bg-red-700' : 'bg-slate-800 hover:bg-slate-900'}`}>{csvSaveStatus === 'saving' ? <Icon name="loader-2" className="animate-spin"/> : csvSaveStatus === 'success' ? <Icon name="check"/> : <Icon name="save"/>} <span>{csvSaveStatus === 'saving' ? 'å„²å­˜ä¸­...' : csvSaveStatus === 'success' ? 'âœ… å·²æˆåŠŸå„²å­˜ï¼' : 'å„²å­˜è®Šæ›´'}</span></button><span className="text-xs text-slate-400 ml-2">{csvSaveStatus === 'success' ? `ä¸Šæ¬¡å„²å­˜: ${new Date().toLocaleTimeString()}` : ''}</span></div></div></details>
                            
                            <DataRescueTab currentAppId={dbSource} onSwitch={handleDbSourceChange} />
                        </div>}
                    </main>

                    {showDebug && <DebugPanel onClose={()=>setShowDebug(false)} />}
                    {showCreateEvent && <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in"><div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl m-auto"><CreateEventModal onClose={()=>setShowCreateEvent(false)} onSave={handleCreateEvent} customTemplates={customTemplates} onSaveTemplate={handleSaveTemplate} onDeleteTemplate={onDeleteTemplate} availableInstructors={Object.keys(stats.instrs).sort()} instructorSchedule={instructorSchedule} /></div></div>}
                    {showAddPromise && <AddPromiseModal onClose={()=>setShowAddPromise(false)} onSave={handleAddPromise} />}
                    {showBulkImport && <BulkImportModal onClose={()=>setShowBulkImport(false)} onImport={handleBulkImport} existingData={parsedData} />}
                    {showScheduleModal && <InstructorScheduleModal date={scheduleDate} availableInstructors={Object.keys(stats.instrs).sort()} restingList={instructorSchedule[scheduleDate] || []} onClose={()=>setShowScheduleModal(false)} onToggle={handleToggleInstructorRest} />}
                    {activeTaskDetail && <TaskDetailModal task={activeTaskDetail} eventData={activeTaskDetail.fullEvent} onClose={()=>setActiveTaskDetail(null)} />}
                    {editingEvent && <EventManagerModal 
                        event={activeEditingEvent} 
                        config={eventConfigs[editingEvent.key]} 
                        onClose={()=>setEditingEvent(null)} 
                        onSaveConfig={(cfg, newInstr)=>handleSaveEventConfig(editingEvent.key, cfg, newInstr)} 
                        availableInstructors={Object.keys(stats.instrs).sort()} 
                        instructorSchedule={instructorSchedule} 
                        onCheckInToggle={handleCheckInToggle}
                        onDeleteEvent={handleDeleteEvent}
                        globalRules={globalRules}
                        onEditCustomer={(c) => setEditingRow(c)} // [ä¿®æ”¹] å‚³å…¥ç·¨è¼¯å‡½å¼
                    />}
                    {/* [æ–°å¢] æ¸²æŸ“å…¨åŸŸè¦å‰‡è¦–çª— */}
                    {showGlobalRules && <GlobalRulesModal 
                        currentRules={globalRules} 
                        onClose={()=>setShowGlobalRules(false)} 
                        onSave={async (newRules) => {
                            await setDoc(doc(db, `artifacts/${dbSource}/public/data`, 'settings', 'main'), { globalRules: newRules }, { merge: true });
                            setShowGlobalRules(false);
                        }} 
                    />}
                    
{editingRow && <EditRowModal rowData={editingRow} existingTransports={uniqueTransports} onClose={()=>setEditingRow(null)} onSave={handleUpdateRow} onDelete={(id) => { handleDeleteRow(id); setEditingRow(null); }} />}
                    {showLoginModal && <LoginModal onClose={()=>setShowLoginModal(false)} onLogin={handleVerifyLogin} />}
                </div>
            );
        };

        try {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            root.render(<MainApp />);
        } catch (error) {

            document.getElementById('root').innerHTML = '<div style="padding:20px;color:red"><h3>ç³»çµ±è¼‰å…¥å¤±æ•—</h3><p>è«‹æª¢æŸ¥ console éŒ¯èª¤è¨Šæ¯ã€‚</p></div>';
            console.error("React Render Error:", error);
        }
    </script>
</body>
</html>
