<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SuperOps - å…¨æ–¹ä½ç‡Ÿé‹ç®¡ç†ç³»çµ±</title>
    
    <!-- 1. å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. å¼•å…¥ React æ ¸å¿ƒ -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- 3. å¼•å…¥ Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. å¼•å…¥ Lucide Icons (å…¨åŸŸè®Šæ•¸ window.lucide) -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        const { useState, useMemo, useEffect, useRef } = React;
        
        // Firebase SDK Imports (CDN)
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getAuth, signInAnonymously, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js';

        // --- [æœ€çµ‚ä¿®æ­£] Icon å…ƒä»¶ ---
        // ä½¿ç”¨ window.lucide.createElement ä¾†ç”¢ç”ŸåŸç”Ÿ DOMï¼Œä¸¦æ›è¼‰åˆ° ref ä¸Š
        // é€™æ¨£å¯ä»¥é¿å… React è™›æ“¬ DOM èˆ‡ Lucide ç›´æ¥æ“ä½œ DOM ä¹‹é–“çš„è¡çª
        const Icon = ({ name, size = 24, className = "" }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (!window.lucide) return;
                const { icons, createElement } = window.lucide;

                // è½‰æ›åç¨± kebab-case -> PascalCase (ä¾‹å¦‚ arrow-right -> ArrowRight)
                const iconName = name
                    .split('-')
                    .map(part => part.charAt(0).toUpperCase() + part.slice(1))
                    .join('');
                
                const iconNode = icons[iconName];

                if (iconNode && containerRef.current) {
                    // 1. æ¸…ç©ºå®¹å™¨
                    containerRef.current.innerHTML = '';
                    
                    // 2. å»ºç«‹ SVG å…ƒç´ 
                    const svgElement = createElement(iconNode);
                    
                    // 3. è¨­å®šå±¬æ€§
                    svgElement.setAttribute('width', size);
                    svgElement.setAttribute('height', size);
                    // åˆä½µ classï¼Œç¢ºä¿ lucide é è¨­ class ä¹Ÿåœ¨ (å¦‚æœæœ‰)
                    const existingClass = svgElement.getAttribute('class') || '';
                    svgElement.setAttribute('class', `${existingClass} ${className}`.trim());
                    
                    // 4. åŠ å…¥ DOM
                    containerRef.current.appendChild(svgElement);
                }
            }, [name, size, className]);

            return <span ref={containerRef} className="inline-flex items-center justify-center"></span>;
        };

        // --- Firebase è¨­å®š (æ‚¨çš„å°ˆæ¡ˆ) ---
        const firebaseConfig = {
            apiKey: "AIzaSyBtfR8N9Dw9kG3jQSfJSs0p0MLvlQaOR74",
            authDomain: "crm-sys-4184a.firebaseapp.com",
            projectId: "crm-sys-4184a",
            storageBucket: "crm-sys-4184a.firebasestorage.app",
            messagingSenderId: "943273685158",
            appId: "1:943273685158:web:8ca441dd78dcb5b956c467",
            measurementId: "G-2M2W340ZKB"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = 'crm-system-v1';

        // --- é è¨­è³‡æ–™ ---
        const INITIAL_CSV_DATA = `æ—¥æœŸ,æ´»å‹•åç¨±,è¬›å¸«,å®¢æˆ¶å§“å,é‡‘é¡,äº¤é€šæ–¹å¼,èº«åˆ†è­‰å­—è™Ÿ,ç”Ÿæ—¥
2023-11-05,é«˜å±±æ”å½±åœ˜,å¼µå¤§å¸«,ç‹å°æ˜,5000,å…±ä¹˜,A123456789,1990-05-20
2023-11-05,é«˜å±±æ”å½±åœ˜,å¼µå¤§å¸«,æå°ç¾,5000,è‡ªè¡Œå‰å¾€,B223456789,1992-08-15
2023-11-05,é«˜å±±æ”å½±åœ˜,å¼µå¤§å¸«,é™³å¤§æ–‡,4500,å…±ä¹˜,C123456789,1988-12-01`;

        const DEFAULT_TASKS_TEMPLATE = [
            { id: 'insurance', type: 'insurance', name: 'è¾¦ç†ä¿éšª', fields: [{ label: 'ä¿å–®è™Ÿç¢¼', value: '' }], completed: false },
            { id: 'pre_letter', type: 'pre_letter', name: 'å¯„é€è¡Œå‰ä¿¡', fields: [{ label: 'å¯„é€æ—¥æœŸ', value: '' }], completed: false },
            { id: 'post_letter', type: 'post_letter', name: 'å¯„é€èŠ±çµ®ä¿¡', fields: [{ label: 'ç…§ç‰‡é€£çµ', value: '' }], completed: false },
        ];

        const DEFAULT_EVENT_TEMPLATES = [
            { id: 'default_1', name: 'ç™»å±±åœ˜æ¨¡æ¿', eventName: 'é€±æœ«ç™»å±±åœ˜', instructor: 'å¼µå¤§å¸«', isSystem: true },
            { id: 'default_2', name: 'éœ²ç‡Ÿåœ˜æ¨¡æ¿', eventName: 'æ˜Ÿç©ºéœ²ç‡Ÿ', instructor: 'æ—åšå£«', isSystem: true },
            { id: 'default_3', name: 'èª²ç¨‹æ¨¡æ¿', eventName: 'æ”å½±æ•™å­¸', instructor: 'é™³æ•™ç·´', isSystem: true },
        ];

        // --- Helper Functions ---
        const getDaysInMonth = (year, month) => new Date(year, month + 1, 0).getDate();
        const getFirstDayOfMonth = (year, month) => new Date(year, month, 1).getDay();
        const getDaysDiff = (targetDateStr) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(targetDateStr);
            const diffTime = target.getTime() - today.getTime();
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        };

        const getTaskStatusStyle = (taskType, eventDateStr) => {
            const daysDiff = getDaysDiff(eventDateStr);
            if (taskType === 'insurance') {
                if (daysDiff <= 3 && daysDiff >= 0) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'æ€¥è¿« (å‰©3å¤©)' };
                if (daysDiff < 0) return { color: 'text-slate-400', bg: 'bg-slate-100', border: 'border-slate-200', label: 'æ´»å‹•å·²é' };
                return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: 'å¾…è¾¦' };
            }
            if (taskType === 'post_letter') {
                const daysSinceEvent = -daysDiff; 
                if (daysSinceEvent < 1) return { color: 'text-slate-400', bg: 'bg-slate-50', border: 'border-slate-200', label: 'æ´»å‹•æœªçµæŸ' };
                if (daysSinceEvent === 1) return { color: 'text-green-600', bg: 'bg-green-50', border: 'border-green-200', label: 'å»ºè­°å¯„é€ (Day 1)' };
                if (daysSinceEvent === 2) return { color: 'text-orange-600', bg: 'bg-orange-50', border: 'border-orange-200', label: 'å¿«å¯„å‡º (Day 2)' };
                if (daysSinceEvent >= 3) return { color: 'text-red-600', bg: 'bg-red-50', border: 'border-red-200', label: 'å»¶é² (Day 3+)' };
            }
            return { color: 'text-slate-600', bg: 'bg-white', border: 'border-slate-200', label: '' };
        };

        // --- UI Components ---

        const NavItem = ({ id, icon, label, activeTab, setActiveTab }) => (
            <button onClick={() => setActiveTab(id)} className={`flex items-center space-x-3 px-4 py-3 rounded-xl transition-all duration-200 w-full ${activeTab === id ? 'bg-blue-600 text-white shadow-lg shadow-blue-200' : 'text-slate-500 hover:bg-white hover:shadow-sm'}`}>
                <Icon name={icon} size={20} />
                <span className="font-medium tracking-wide">{label}</span>
            </button>
        );

        const DebugPanel = ({ onClose }) => {
            const [logs, setLogs] = useState([]);
            const [status, setStatus] = useState({ auth: 'checking', firestore: 'checking', network: 'online' });

            const addLog = (msg, type = 'info') => setLogs(p => [...p, { msg, type, time: new Date().toLocaleTimeString() }]);

            useEffect(() => {
                const run = async () => {
                    addLog("ç³»çµ±å•Ÿå‹•...", 'info');
                    try {
                        const cred = await signInAnonymously(auth);
                        addLog(`åŒ¿åç™»å…¥æˆåŠŸ (UID: ${cred.user.uid.slice(0,5)}...)`, 'success');
                        setStatus(s => ({...s, auth: 'success'}));
                    } catch(e) {
                        addLog(`ç™»å…¥å¤±æ•—: ${e.message}`, 'error');
                        setStatus(s => ({...s, auth: 'error'}));
                        return;
                    }
                    try {
                        await setDoc(doc(db, 'artifacts', appId, 'public', 'ping'), { t: Date.now() });
                        addLog("è³‡æ–™åº«é€£ç·šå¯«å…¥æ¸¬è©¦æˆåŠŸ", 'success');
                        setStatus(s => ({...s, firestore: 'success'}));
                    } catch(e) {
                        addLog(`è³‡æ–™åº«å¤±æ•—: ${e.message}`, 'error');
                        setStatus(s => ({...s, firestore: 'error'}));
                        if(e.message.includes('permission')) addLog("è«‹æª¢æŸ¥ Firebase Console > Firestore > Rules è¨­å®šã€‚", 'warning');
                    }
                };
                run();
            }, []);

            return (
                <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-[100] flex items-center justify-center p-4 fade-in">
                    <div className="bg-slate-900 text-green-400 rounded-2xl shadow-2xl w-full max-w-2xl h-[500px] flex flex-col font-mono text-sm border border-slate-700 overflow-hidden">
                        <div className="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800">
                            <div className="flex items-center space-x-2"><Icon name="activity" className="animate-pulse"/><span>ç³»çµ±è¨ºæ–·</span></div>
                            <button onClick={onClose} className="hover:text-white"><Icon name="x"/></button>
                        </div>
                        <div className="grid grid-cols-3 border-b border-slate-700 text-center">
                            {Object.entries(status).map(([k, v]) => (
                                <div key={k} className={`p-3 border-r border-slate-700 ${v==='success'?'text-green-400':v==='error'?'text-red-400':'text-slate-500'}`}>
                                    <div className="uppercase text-xs font-bold mb-1">{k}</div>
                                    <div className="text-lg">{v === 'success' ? 'OK' : v === 'error' ? 'ERR' : '...'}</div>
                                </div>
                            ))}
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 space-y-1">
                            {logs.map((l, i) => <div key={i} className={l.type==='error'?'text-red-400':l.type==='warning'?'text-yellow-400':'text-slate-300'}>[{l.time}] {l.msg}</div>)}
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Application ---
        const MainApp = () => {
            const [user, setUser] = useState(null);
            const [activeTab, setActiveTab] = useState('tasks');
            const [loading, setLoading] = useState(true);
            const [showDebug, setShowDebug] = useState(false);
            const [showCreateEvent, setShowCreateEvent] = useState(false);
            const [eventsViewMode, setEventsViewMode] = useState('list');
            
            // Data
            const [csvInput, setCsvInput] = useState('');
            // remoteCsvData å·²ç§»é™¤ï¼Œç›´æ¥ä½¿ç”¨ csvInput
            const [parsedData, setParsedData] = useState([]);
            const [eventConfigs, setEventConfigs] = useState({});
            const [customTemplates, setCustomTemplates] = useState([]);
            
            // Modal State
            const [activeTaskDetail, setActiveTaskDetail] = useState(null);
            const [selectedCustomer, setSelectedCustomer] = useState('');

            // 1. Auth
            useEffect(() => {
                signInAnonymously(auth).catch(e => console.error(e));
                return onAuthStateChanged(auth, u => setUser(u));
            }, []);

            // 2. Data Sync
            useEffect(() => {
                if (!user) return;
                setLoading(true);
                const basePath = `artifacts/${appId}/public/data`;
                
                // å®šç¾© updateParsedData é‚è¼¯
                const updateParsedData = (raw) => {
                    try {
                        const lines = raw.trim().split('\n');
                        const data = lines.slice(1).map((line, i) => {
                            const v = line.split(',');
                            if(v.length < 5) return null;
                            return {
                                id: i, date: v[0]?.trim(), eventName: v[1]?.trim(), instructor: v[2]?.trim(),
                                customerName: v[3]?.trim(), price: parseInt(v[4])||0, transport: v[5]?.trim(),
                                idNo: v[6]?.trim(), birthday: v[7]?.trim()
                            };
                        }).filter(Boolean);
                        setParsedData(data);
                    } catch(e) { console.error(e); }
                };

                const unsub1 = onSnapshot(doc(db, basePath, 'settings', 'main'), s => {
                    if(s.exists()) {
                        const d = s.data().csvData || '';
                        if(d !== csvInput) { 
                            setCsvInput(d); 
                            updateParsedData(d); 
                        }
                    } else {
                        setDoc(doc(db, basePath, 'settings', 'main'), { csvData: INITIAL_CSV_DATA });
                    }
                    setLoading(false);
                }, err => console.error("Settings sync error:", err));

                const unsub2 = onSnapshot(doc(db, basePath, 'settings', 'templates'), s => setCustomTemplates(s.data()?.list || []), err => console.error("Templates sync error:", err));
                const unsub3 = onSnapshot(collection(db, basePath, 'event_configs'), s => {
                    const cfgs = {}; s.forEach(d => cfgs[d.id] = d.data()); setEventConfigs(cfgs);
                    setLoading(false);
                }, err => console.error("Configs sync error:", err));

                return () => { unsub1(); unsub2(); unsub3(); };
            }, [user]);

            // æ‰‹å‹•æ›´æ–° parsedData çš„è¼”åŠ©å‡½å¼ (ç”¨æ–¼æœ¬åœ° save å¾Œç«‹å³æ›´æ–°)
            const updateParsedDataLocal = (raw) => {
                try {
                    const lines = raw.trim().split('\n');
                    const data = lines.slice(1).map((line, i) => {
                        const v = line.split(',');
                        if(v.length < 5) return null;
                        return {
                            id: i, date: v[0]?.trim(), eventName: v[1]?.trim(), instructor: v[2]?.trim(),
                            customerName: v[3]?.trim(), price: parseInt(v[4])||0, transport: v[5]?.trim(),
                            idNo: v[6]?.trim(), birthday: v[7]?.trim()
                        };
                    }).filter(Boolean);
                    setParsedData(data);
                } catch(e) { console.error(e); }
            };

            const handleSaveCSV = async (newData) => {
                if(!user) return;
                updateParsedDataLocal(newData);
                setCsvInput(newData);
                await setDoc(doc(db, `artifacts/${appId}/public/data`, 'settings', 'main'), { csvData: newData }, { merge: true });
            };

            const handleCreateEvent = async ({ dates, eventName, instructors }) => {
                let rows = '';
                const instr = instructors.join(' & ');
                dates.forEach(d => rows += `\n${d},${eventName},${instr},é–‹æ”¾å ±åä¸­,0,,,`);
                await handleSaveCSV(csvInput + rows);
                setShowCreateEvent(false);
            };

            const handleAddTemplate = async (newTemplate) => {
                if (!user) return;
                const templateWithId = { ...newTemplate, id: `custom_${Date.now()}` };
                const newList = [...customTemplates, templateWithId];
                const templatesDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'templates');
                await setDoc(templatesDocRef, { list: newList }, { merge: true });
            };

            const onDeleteTemplate = async (templateId) => {
                if (!user || !confirm("ç¢ºå®šè¦åˆªé™¤é€™å€‹æ¨¡æ¿å—ï¼Ÿ")) return;
                const newList = customTemplates.filter(t => t.id !== templateId);
                const templatesDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'settings', 'templates');
                await setDoc(templatesDocRef, { list: newList }, { merge: true });
            };

            const handleToggleTaskInCenter = async (configKey, taskIndex) => {
                if (!user) return;
                const currentConfig = eventConfigs[configKey] || {};
                const tasks = currentConfig.tasks || JSON.parse(JSON.stringify(DEFAULT_TASKS_TEMPLATE));
                const newTasks = [...tasks];
                newTasks[taskIndex].completed = !newTasks[taskIndex].completed;
                const configDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'event_configs', configKey);
                await setDoc(configDocRef, { ...currentConfig, tasks: newTasks }, { merge: true });
            };

            const stats = useMemo(() => {
                const totalRev = parsedData.reduce((a,c) => a + c.price, 0);
                const events = {};
                const instrs = {};
                parsedData.forEach(c => {
                    const key = `${c.date}_${c.eventName}_${c.instructor}`.replace(/[\/\\#\?]/g, '-');
                    if(!events[key]) events[key] = { ...c, count: 0, customers: [], key };
                    if(c.customerName !== 'é–‹æ”¾å ±åä¸­') {
                        events[key].count++;
                        events[key].customers.push(c);
                    }
                    if(c.instructor) c.instructor.split(/[&,]/).forEach(i => {
                        const name = i.trim();
                        if(name && name !== 'æœªå®š') instrs[name] = (instrs[name]||0)+1;
                    });
                });
                return { totalRev, totalPax: parsedData.length, events, instrs };
            }, [parsedData]);

            const availableInstructors = useMemo(() => Object.keys(stats.instrs).sort(), [stats.instrs]);

            const pendingTasksData = useMemo(() => {
                const list = [];
                Object.values(stats.events).forEach(evt => {
                    const config = eventConfigs[evt.key] || {};
                    const tList = config.tasks || DEFAULT_TASKS_TEMPLATE;
                    tList.forEach((t, i) => {
                        if(!t.completed) list.push({ ...t, taskIdx: i, evtDate: evt.date, evtName: evt.eventName, cfgKey: evt.key, style: getTaskStatusStyle(t.type, evt.date), fullEvent: evt });
                    });
                });
                return list.sort((a,b) => new Date(a.evtDate) - new Date(b.evtDate));
            }, [stats.events, eventConfigs]);

            const uniqueCustomers = useMemo(() => [...new Set(parsedData.map(d => d.customerName))].filter(n => n !== 'é–‹æ”¾å ±åä¸­'), [parsedData]);
            const customerHistory = useMemo(() => {
                if (!selectedCustomer) return [];
                return parsedData.filter(d => d.customerName === selectedCustomer);
            }, [parsedData, selectedCustomer]);

            if (loading && !parsedData.length) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-slate-50 text-slate-400">
                        <Icon name="loader-2" className="animate-spin mr-2"/> è¼‰å…¥ä¸­...
                    </div>
                );
            }

            return (
                <div className="flex min-h-screen">
                    {/* Sidebar */}
                    <aside className="w-64 bg-white border-r border-slate-200 flex flex-col p-4 hidden md:flex sticky top-0 h-screen">
                        <div className="flex items-center space-x-2 px-4 mb-8 mt-2">
                            <div className="w-8 h-8 bg-gradient-to-br from-blue-500 to-indigo-600 rounded-lg flex items-center justify-center text-white font-bold">S</div>
                            <span className="font-bold text-lg tracking-tight">SuperOps</span>
                        </div>
                        <div className="space-y-1 flex-1">
                            <NavItem id="tasks" icon="check-square" label="ä»»å‹™æŒ‡æ®ä¸­å¿ƒ" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="events" icon="calendar" label="æ´»å‹•å ´æ¬¡è¡¨" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="dashboard" icon="trending-up" label="ç‡Ÿé‹å„€è¡¨æ¿" activeTab={activeTab} setActiveTab={setActiveTab} />
                            <NavItem id="crm" icon="users" label="å®¢æˆ¶ CRM" activeTab={activeTab} setActiveTab={setActiveTab} />
                        </div>
                        <div className="pt-4 border-t border-slate-100">
                            <button onClick={() => setShowDebug(true)} className="w-full flex items-center space-x-3 px-4 py-3 rounded-xl text-slate-400 hover:bg-slate-50 hover:text-slate-600 transition-all text-sm mb-1">
                                <Icon name="activity" size={18} /> <span>é€£ç·šè¨ºæ–·</span>
                            </button>
                            <NavItem id="import" icon="file-text" label="è³‡æ–™åº«ç®¡ç†" activeTab={activeTab} setActiveTab={setActiveTab} />
                        </div>
                    </aside>

                    {/* Main */}
                    <main className="flex-1 p-6 md:p-10 overflow-y-auto bg-slate-50/50">
                        
                        {/* Mobile Header */}
                        <div className="md:hidden mb-6 flex justify-between items-center">
                            <span className="font-bold text-lg">SuperOps</span>
                            <button onClick={()=>setShowDebug(true)}><Icon name="activity" className="text-slate-400"/></button>
                        </div>

                        {/* Views */}
                        {activeTab === 'tasks' && (
                            <div className="max-w-6xl mx-auto fade-in">
                                <header className="mb-8 flex justify-between items-end">
                                    <div>
                                        <h2 className="text-2xl font-bold text-slate-800 mb-1">ä»»å‹™æŒ‡æ®ä¸­å¿ƒ</h2>
                                        <p className="text-slate-500 text-sm">æ™ºæ…§è¿½è¹¤ç³»çµ±ï¼Œæ ¹æ“šæ´»å‹•æ—¥æœŸè‡ªå‹•æ’åº</p>
                                    </div>
                                    <div className="bg-white px-4 py-2 rounded-full border border-slate-200 text-sm font-medium shadow-sm">
                                        å¾…è™•ç†: <span className="text-blue-600 font-bold ml-1">{pendingTasksData.length}</span>
                                    </div>
                                </header>
                                {pendingTasksData.length === 0 ? (
                                    <div className="text-center py-20">
                                        <div className="w-20 h-20 bg-yellow-100 text-yellow-600 rounded-full flex items-center justify-center mx-auto mb-6 text-3xl shadow-sm">ğŸ‰</div>
                                        <h3 className="text-xl font-bold text-slate-700">å¤ªæ£’äº†ï¼ä»»å‹™å·²æ¸…ç©º</h3>
                                    </div>
                                ) : (
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                        {pendingTasksData.map((t, i) => (
                                            <div key={`${t.cfgKey}-${t.taskIdx}`} onClick={() => setActiveTaskDetail(t)} className={`bg-white p-5 rounded-2xl border border-slate-100 shadow-sm hover:shadow-md hover:translate-y-[-2px] transition-all cursor-pointer group relative overflow-hidden`}>
                                                <div className={`absolute top-0 left-0 w-1 h-full ${t.style.bg.replace('bg-', 'bg-') === 'bg-white' ? 'bg-slate-200' : t.style.bg.replace('bg', 'bg').replace('50', '400')}`}></div>
                                                <div className="flex justify-between items-start mb-3 pl-2">
                                                    <span className="bg-slate-100 text-slate-600 text-xs font-mono px-2 py-1 rounded-md">{t.evtDate}</span>
                                                    {t.style.label && <span className={`text-[10px] font-bold px-2 py-0.5 rounded-full border ${t.style.color} ${t.style.border} ${t.style.bg}`}>{t.style.label}</span>}
                                                </div>
                                                <div className="pl-2">
                                                    <div className="text-xs text-slate-500 mb-1 truncate">{t.evtName}</div>
                                                    <h4 className={`font-bold text-lg mb-4 ${t.style.color}`}>{t.name}</h4>
                                                    <button onClick={(e) => { e.stopPropagation(); toggleTask(t.cfgKey, t.taskIdx); }} className="w-full py-2.5 rounded-xl bg-slate-50 border border-slate-200 text-slate-400 font-bold hover:bg-green-500 hover:text-white hover:border-green-500 transition-all flex items-center justify-center gap-2 group-hover:bg-white">
                                                        <Icon name="check-circle-2" size={18} /> <span>æ¨™ç¤ºå®Œæˆ</span>
                                                    </button>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                        )}

                        {/* Other Tabs */}
                        {activeTab === 'events' && (
                            <div className="fade-in max-w-6xl mx-auto">
                                <header className="flex justify-between items-center mb-6">
                                    <h2 className="text-2xl font-bold">æ´»å‹•å ´æ¬¡</h2>
                                    <button onClick={()=>setShowCreateEvent(true)} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 shadow-md shadow-blue-200 transition-all"><Icon name="plus" size={18}/> å¿«é€Ÿé–‹åœ˜</button>
                                </header>
                                <div className="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                                    <table className="w-full text-left">
                                        <thead className="bg-slate-50 border-b border-slate-100 text-slate-500 text-sm"><tr><th className="px-6 py-4 font-medium">æ—¥æœŸ</th><th className="px-6 py-4 font-medium">æ´»å‹•</th><th className="px-6 py-4 font-medium">å ±å</th></tr></thead>
                                        <tbody className="divide-y divide-slate-100">
                                            {Object.values(stats.events).map((e, i) => (
                                                <tr key={i} className="hover:bg-slate-50/80">
                                                    <td className="px-6 py-4 text-slate-600">{e.date}</td>
                                                    <td className="px-6 py-4">
                                                        <div className="font-bold text-slate-800">{e.eventName}</div>
                                                        <div className="text-xs text-slate-400 mt-0.5">{e.instructor}</div>
                                                    </td>
                                                    <td className="px-6 py-4"><span className="font-bold text-slate-700">{e.count}</span> <span className="text-xs text-slate-400">äºº</span></td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        )}

                        {activeTab === 'dashboard' && (
                            <div className="fade-in max-w-6xl mx-auto space-y-6">
                                <h2 className="text-2xl font-bold">æ•¸æ“šç¸½è¦½</h2>
                                <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                    <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm"><div className="text-slate-500 text-sm font-medium mb-2">é ä¼°ç‡Ÿæ”¶</div><div className="text-3xl font-bold text-slate-800">${stats.totalRev.toLocaleString()}</div></div>
                                    <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm"><div className="text-slate-500 text-sm font-medium mb-2">ç¸½äººæ¬¡</div><div className="text-3xl font-bold text-slate-800">{stats.totalPax}</div></div>
                                    <div className="bg-white p-6 rounded-2xl border border-slate-100 shadow-sm"><div className="text-slate-500 text-sm font-medium mb-2">æ´»å‹•å ´æ¬¡</div><div className="text-3xl font-bold text-slate-800">{Object.keys(stats.events).length}</div></div>
                                </div>
                            </div>
                        )}

                        {activeTab === 'crm' && (
                            <div className="fade-in max-w-6xl mx-auto">
                                <h2 className="text-2xl font-bold mb-6">å®¢æˆ¶ CRM</h2>
                                <div className="bg-white p-6 rounded-2xl shadow-sm border border-slate-200">
                                    <div className="relative mb-6">
                                        <Icon name="search" className="absolute left-3 top-3 text-slate-400" size={20}/>
                                        <select className="w-full pl-10 pr-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all" value={selectedCustomer} onChange={e=>setSelectedCustomer(e.target.value)}>
                                            <option value="">æœå°‹æˆ–é¸æ“‡å®¢æˆ¶...</option>
                                            {uniqueCustomers.map(c=><option key={c} value={c}>{c}</option>)}
                                        </select>
                                    </div>
                                    {selectedCustomer && (
                                        <div className="animate-in fade-in slide-in-from-top-4">
                                            <div className="flex items-center gap-4 mb-6">
                                                <div className="w-16 h-16 bg-blue-100 text-blue-600 rounded-full flex items-center justify-center text-2xl font-bold">{selectedCustomer[0]}</div>
                                                <div>
                                                    <div className="text-xl font-bold">{selectedCustomer}</div>
                                                    <div className="text-slate-500 text-sm">å…±åƒåŠ  {customerHistory.length} æ¬¡æ´»å‹•</div>
                                                </div>
                                            </div>
                                            <div className="space-y-3">
                                                {customerHistory.map((h,i) => (
                                                    <div key={i} className="flex justify-between items-center p-4 border border-slate-100 rounded-xl hover:bg-slate-50">
                                                        <div><div className="font-bold text-slate-700">{h.eventName}</div><div className="text-xs text-slate-400">{h.date}</div></div>
                                                        <div className="font-mono text-slate-600">${h.price}</div>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {activeTab === 'import' && (
                            <div className="fade-in max-w-4xl mx-auto">
                                <h2 className="text-2xl font-bold mb-6">è³‡æ–™åº«ç®¡ç†</h2>
                                <div className="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                                    <label className="block text-sm font-medium text-slate-700 mb-3">CSV åŸå§‹æ•¸æ“š (å·²æ“´å……æ¬„ä½)</label>
                                    <textarea className="w-full h-64 p-4 font-mono text-sm bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none resize-none" value={csvInput} onChange={e=>setCsvInput(e.target.value)}></textarea>
                                    <div className="mt-4 flex justify-end">
                                        <button onClick={()=>handleSaveCSV(csvInput)} disabled={isSaving} className="bg-slate-800 text-white px-6 py-2.5 rounded-xl hover:bg-slate-900 transition-all flex items-center gap-2 shadow-lg shadow-slate-200">
                                            {isSaving ? <Icon name="loader-2" className="animate-spin"/> : <Icon name="save"/>}
                                            <span>å„²å­˜è®Šæ›´</span>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        )}

                    </main>

                    {/* Modals */}
                    {showDebug && <DebugPanel onClose={()=>setShowDebug(false)} />}
                    {showCreateEvent && (
                        <div className="fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 fade-in backdrop-blur-sm">
                            <div className="bg-white rounded-2xl w-full max-w-lg p-6 shadow-2xl">
                                <CreateEventModal 
                                    onClose={()=>setShowCreateEvent(false)} 
                                    onSave={handleCreateEvent} 
                                    customTemplates={customTemplates}
                                    onAddTemplate={handleAddTemplate}
                                    onDeleteTemplate={onDeleteTemplate}
                                    availableInstructors={availableInstructors}
                                />
                            </div>
                        </div>
                    )}
                    {activeTaskDetail && (
                        <TaskDetailModal task={activeTaskDetail} eventData={activeTaskDetail.fullEvent} onClose={()=>setActiveTaskDetail(null)} />
                    )}
                </div>
            );
        };

        // æ¸²æŸ“
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<MainApp />);
    </script>
</body>
</html>
